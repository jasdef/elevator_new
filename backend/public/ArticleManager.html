<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-datetimepicker -->
    <link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css" rel="stylesheet">
    <!-- Ion.RangeSlider -->
    <link href="../vendors/normalize-css/normalize.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.skinFlat.css" rel="stylesheet">
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    #datatable tbody td {
        vertical-align: middle;
    }

    #datatable tbody td:nth-child(9) {
        text-align: right;
    }

    #datatable {
        table-layout: fixed;
    }
    #datatable .form-control{
        width: 300px;
    }

    .dataTables_wrapper>.row {
        overflow: visible!important;
    }

    .text-ellipsis {
        width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
    }

    #datatable img{
      display:block; width:100%; height:auto;
    }

    td {
        overflow: hidden;
        text-overflow: ellipsis;
        word-wrap: break-word; /* Internet Explorer 5.5+ */
    }

    div.show-more{
        min-height: 35px;
        max-height: 50px;
        width: 100%;
        overflow: hidden;
        display: block;
        position: relative;
        -webkit-transition: all .5s linear;
           -moz-transition: all .5s linear;
            -ms-transition: all .5s linear;
             -o-transition: all .5s linear;
                transition: all .5s linear;
    }
    div.show-more::before{
        content: '';
        display: block;
        width: 100%;
        height: 20px;
        position: absolute;
        bottom: 0;
        background-image: linear-gradient(to bottom, rgba(255, 255, 255, 0) 0%, rgba(255, 255, 255, 1) 68%, rgba(255, 255, 255, 1) 100%);
        -webkit-transition: opacity .3s linear;
           -moz-transition: opacity .3s linear;
            -ms-transition: opacity .3s linear;
             -o-transition: opacity .3s linear;
                transition: opacity .3s linear;
    }
    .table-striped > tbody > tr:nth-of-type(odd) > td > div.show-more::before{
        background-image: linear-gradient(to bottom, rgba(249, 249, 249, 0) 0%, rgba(249, 249, 249, 1) 68%, rgba(249, 249, 249, 1) 100%);
    }

    div.show-more:hover{
        max-height: 500px;
    }
    div.show-more:hover::before{
        opacity: 0;
    }
    div.show-more > img{
        max-width: 160px;
    }
    .table-striped > tbody > tr > td:nth-child(3){
        white-space: nowrap;
    }
    .table-striped > tbody > tr > td:nth-child(1){
        text-align: right;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>文章管理</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-lg-6 col-md-12 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="fa fa-file-text-o" aria-hidden="true"></i> 固定頁編輯</div>
                                                <div class="panel-body">
                                                    <h5>新手導引</h5>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" data-id="1147" class="btn btn-primary fixed-edit">遊戲介面操作</button>
                                                        <button type="button" data-id="1148" class="btn btn-primary fixed-edit">道具卡使用與強化說明</button>
                                                        <button type="button" data-id="1149" class="btn btn-primary fixed-edit">贈禮說明</button>
                                                        <button type="button" data-id="1150" class="btn btn-primary fixed-edit">VIP層級介紹</button>
                                                        <button type="button" data-id="1151" class="btn btn-primary fixed-edit">活躍度說明</button>
                                                    </div>

                                                    <h5>儲值購點</h5>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" data-id="1152" class="btn btn-primary fixed-edit">Funpay立即儲</button>
                                                        <button type="button" data-id="1153" class="btn btn-primary fixed-edit">MyCard線上購點</button>
                                                        <button type="button" data-id="1154" class="btn btn-primary fixed-edit">電信支付</button>
                                                    </div>

                                                    <h5>客服中心</h5>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-primary fixed-edit">常見問題</button>
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                                權益說明 <span class="caret"></span>
                                                            </button>
                                                            <ul class="dropdown-menu">
                                                                <li><a data-id="1156" class="fixed-edit" href="javascript:;">使用合約</a></li>
                                                                <li><a data-id="1157" class="fixed-edit" href="javascript:;">隱私條款</a></li>
                                                                <li><a data-id="1158" class="fixed-edit" href="javascript:;">遊戲規章</a></li>
                                                            </ul>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="fa fa-search" aria-hidden="true"></i> 搜尋文章</div>
                                                <div class="panel-body">
                                                    <div class="form-group">
                                                        <label class="control-label">類型</label>
                                                        <select name="SearchType" id="SearchType" class="form-control">
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="SearchTitle" class="control-label">標題關鍵字</label>
                                                        <input type="text" name="SearchTitle" id="SearchTitle" class="form-control" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="SearchContent" class="control-label">內文關鍵字</label>
                                                        <input type="text" name="SearchContent" id="SearchContent" class="form-control" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="SearchPostTime" class="control-label">發文時間</label>
                                                        <div class="input-group">
                                                            <span class="input-group-addon">
                                                                <input id="SearchPostTimeSwitch" type="checkbox" checked>
                                                            </span>
                                                            <input type="text" name="SearchPostTime" id="SearchPostTime" class="form-control" value="" />
                                                        </div><!-- /input-group -->
                                                        
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="SearchAuthor" class="control-label">發文者關鍵字</label>
                                                        <input type="text" name="SearchAuthor" id="SearchAuthor" class="form-control" />
                                                    </div>
                                                    <div class="col-md-12">
                                                        <button type="button" id="SearchItem" class="btn btn-lg btn-primary pull-right">搜尋</button>
                                                        <button type="button" id="ClearSearch" class="btn btn-lg btn-primary pull-right">清除</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>


                                        <div class="col-lg-6 col-md-12 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="fa fa-plus-square" aria-hidden="true"></i> 新增文章</div>
                                                <div class="panel-body">
                                                    <div class="form-group">
                                                        <label class="control-label">類型</label>
                                                        <select name="AddType" id="AddType" class="form-control">
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="AddTitle" class="control-label">標題</label>
                                                        <input type="text" name="AddTitle" id="AddTitle" class="form-control" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label">內文</label>
                                                        <textarea name="AddContent" id="AddContent"></textarea>
                                                    </div>
                                                    <div class="col-md-12">
                                                        <button type="button" id="InsertItem" class="btn btn-lg btn-primary pull-right">新增</button>
                                                        <button type="button" id="ClearAdd" class="btn btn-lg btn-primary pull-right">清除</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <table id="datatable" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>類型</th>
                                                    <th>標題</th>
                                                    <th>內文</th>
                                                    <th>URL</th>
                                                    <th>發文時間</th>
                                                    <th>最後修改時間</th>
                                                    <th>發文者</th>
                                                    <th>功能</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- Ion.RangeSlider -->
    <script src="../vendors/ion.rangeSlider/js/ion.rangeSlider.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-datetimepicker -->
    <script src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <!-- jquery.inputmask -->
    <script src="../vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
    <!-- jQuery Knob -->
    <script src="../vendors/jquery-knob/dist/jquery.knob.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../ckeditor/ckeditor.js"></script>
    <script>
    $(document).ready(function() {
        var getArticleURL = "https://online808.com/";
        var currentRow;
        var editID;

        var ArticleTypeList = {};
        var ArticleTypeOption = '';
        var ArticleItemList = {};
        var urlPath = {
            7: "other/",
            8: "other/",
            9: "other/",
            10: "other/",
            11: "other/",
            14: "news/",
            15: "news/",
            16: "news/"
        };

        var $_GET = {};
        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
            function decode(s) {
                return decodeURIComponent(s.split("+").join(" "));
            }
            $_GET[decode(arguments[1])] = decode(arguments[2]);
        });

        function LoadingEff(effon) {
            if ($('#loading-cover').length < 1) {
                var html = '<div id="loading-cover">' +
                    '<div id="loading-icon">' +
                    '<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>'
                '</div>' +
                '</div>';
                $('body').append(html);
                $('#loading-cover').css({
                    'width': '100%',
                    'height': '100%',
                    'background': 'rgba(0,0,0,.5)',
                    'position': 'fixed',
                    'display': 'none',
                    'z-index': '999999',
                    'top': '0',
                    'left': '0'
                });
                $('#loading-icon').css({
                    'width': '85px',
                    'height': '65px',
                    'margin': '-42.5px 0 0 -32.5px',
                    'top': '50%',
                    'left': '50%',
                    'position': 'fixed'
                });
            }
            if (effon) {
                $('#loading-cover').fadeIn(100);
            } else {
                $('#loading-cover').fadeOut(100);
            }
        }


        CKEDITOR.replace('AddContent');

        // $(document).on('click', '.modal-box[target=modal-box]', function(event) {
        //     event.preventDefault();
        //     attr.('href')
        // });

        $('#SearchPostTime').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment(),
            endDate: moment(),
            timePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            ranges: {
                'Today': [moment().startOf('day'), moment().endOf('day')],
                'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
                'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
                'Last 30 Days': [moment().subtract(29, 'days').startOf('day'), moment().endOf('day')],
                'This Month': [moment().startOf('month'), moment().endOf('month')]
            }
        });

        var table = $('#datatable').DataTable({
            destroy: true,
            "order": [[ 0, "desc" ]],
            "columnDefs": [
                { "targets": 0, "width": "20px" },
                { "targets": 1, "width": "100px" },
                { "targets": 2, "width": "220px" },
                { "targets": 3, "width": "250px" },
                { "targets": 4, "width": "350px"},
                { "targets": 5, "width": "50px" },
                { "targets": 6, "width": "50px" },
                { "targets": 7, "width": "50px" },
                // {
                //     "targets": 8,
                //     "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                //         "<button class='btn btn-info' id='modifyitem'><i class='fa fa-pencil-square-o' aria-hidden='true'></i> 修改</button>" +
                //         "<button class='btn btn-danger btn-del' id='delitem'><i class='fa fa-pencil-square-o' aria-hidden='true'></i> 刪除</button>" +
                //         "<button class='btn btn-preview' id='preview'><i class='fa fa-eye' aria-hidden='true'></i></button>" +
                //         "</div>"
                // }
            ]
        });

        $.ajax({
            type: 'POST',
            url: "/GetArticleType",
            cache: false,
            async: true,
            dataType: 'json',
            success: function(msg) {
                ArticleTypeList = {};
                $.each(msg.data, function(index, value) {
                    ArticleTypeList[value.Id] = value;
                });
                ArticleTypeOption = '';
                $.each(ArticleTypeList, function(index, value) {
                    ArticleTypeOption += '<option value="' + value.Id + '">' + value.Id + "." + value.Name + '</option>';
                });
                $('#SearchType').empty();
                $('#SearchType').append('<option value="0">不限</option>' + ArticleTypeOption);
                $('#AddType').empty();
                $('#AddType').append(ArticleTypeOption);
            },
            error: function(xhr, desc, err) {
                alert("HTTP Status code:" + xhr.status);
            }
        }).done(function() {
            LoadingEff(false);
            refresh();
        });

        $(document).on('click', '.fixed-edit', function(event) {
            event.preventDefault();
            LoadingEff(true);
            var editId = $(this).attr('data-id');
            $.ajax({
                url: '/BulletinArticleManagerForm/ArticleGetById',
                type: 'GET',
                cache: false,
                async: true,
                data: { Id: editId },
                success: function(data) {
                    // console.log(data);
                    var tempForm = new Object();
                    tempForm.Id = data.Id;
                    tempForm.Title = data.Title;
                    tempForm.URL = getArticleURL + urlPath[data.Type] + data.Id;
                    tempForm.CreateTime = data.CreateTime;
                    tempForm.ModifyTime = data.ModifyTime;
                    tempForm.Author = data.Author;
                    tempForm.Type = ArticleItemList[data.Id].Type;
                    tempForm.Content = ArticleItemList[data.Id].Content;
                    editID = data.Id;
                    ShowEditModal(tempForm);
                    LoadingEff(false);
                }
            }).fail(function(xhr, desc, err) {
                alert("HTTP Status code:" + xhr.status);
            });
            
            ShowEditModal(tempForm);
        });

        $(document).on('click', '#datatable tbody button', function(e) {
        // $('#datatable tbody').on('click', 'button', function(e) {
            var data = table.row($(this).parents('tr')).data();
            var jsonData = {};
            currentRow = $(this).closest("tr");
            switch ($(this).attr('data-func')) {
                case "modifyitem":
                    var tempForm = new Object();
                    tempForm.Id = currentRow.find("td:eq(0)").text();
                    editID = currentRow.find("td:eq(0)").text();
                    tempForm.Title = currentRow.find("td:eq(2)").text();
                    tempForm.URL = currentRow.find("td:eq(4) input").val();
                    tempForm.CreateTime = currentRow.find("td:eq(5)").text();
                    tempForm.ModifyTime = currentRow.find("td:eq(6)").text();
                    tempForm.Author = currentRow.find("td:eq(7)").text();
                    tempForm.Type = ArticleItemList[tempForm.Id].Type;
                    tempForm.Content = ArticleItemList[tempForm.Id].Content;
                    ShowEditModal(tempForm);
                    break;

                case "delitem":
                    DeleteItem(currentRow.find("td:eq(0)").text());
                    break;

                case "preview":
                    PreviewItem(currentRow.find("td:eq(4) input").val());
                    break;
            }
        });

        function refresh() {
            LoadingEff(true);
            table.clear().draw();
            
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/GetArticle",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var data = parseTable(msg)
                    table.rows.add(data).draw();
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                LoadingEff(false);
            });
        }

        function SearchItem(e) {
            e.preventDefault();
            LoadingEff(true);
            var SendData = {};
            
            if ($("#SearchPostTimeSwitch").prop("checked")) {
                SendData.Post_StartDate = $('#SearchPostTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
                SendData.Post_EndDate = $('#SearchPostTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
            }

            if ($('#SearchType').val() != 0)
                SendData.Type = $('#SearchType').val();
            SendData.Title = $('#SearchTitle').val();
            SendData.Content = $('#SearchContent').val();
            SendData.Author = $('#SearchAuthor').val();
            console.log(SendData);
            table.clear().draw();
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/ArticleSearch",
                data: SendData,
                dataType: 'json',
                success: function (msg) {
                    var data = parseTable(msg)
                    table.rows.add(data).draw();
                },
                error: function (xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function () {
                LoadingEff(false);
            });
        }

        function parseTable(arr) {
            var data = [];
            $.each(arr.data, function (index, value) {
                ArticleItemList[value.Id] = value;
            });

            arr.data.forEach(function (value) {
                var re = /<img[^>]+src="?([^"\s]+)"?[^>]*\/>/g;
                var results = re.exec(value.Content);
                var img = "";
                if (results) {
                    img = `<img class="img-responsive" src="${results[1]}">`;
                }

                var text = jQuery(value.Content).text().trim();
                if (text.length > 50) {
                    text = `${text.substring(0, 50)}...`;
                }

                var content = `<div class="show-more">${text + img}</div>`;
                var url = `
                            <div class="input-group">
                                <input type="text" class="form-control" value="${getArticleURL + urlPath[value.Type] + value.Id}" readonly>
                                    <span class="input-group-btn">
                                        <button class="btn btn-secondary copy-url" type="button">
                                        <i class="fa fa-copy"></i></button>
                                    </span>
                            </div>`;
                var btnGroup = `
                            <div class="btn-group btn-group-sm" style="display: flex">
                                <button class="btn btn-info" data-func="modifyitem">
                                    <i class="fa fa-pencil-square-o"></i> 修改</button>
                                <button class="btn btn-danger btn-del" data-func="delitem" ${value.Del == "L" ? "disabled" : ""}>
                                    <i class="fa fa-pencil-square-o"></i> 刪除
                                </button>
                                <button class="btn btn-preview" data-func="preview">
                                    <i class="fa fa-eye"></i></button>
                            </div>`;
                data.push([
                    value.Id,
                    `${value.Type} .${FindTypeNameById(value.Type)}`,
                    value.Title,
                    content,
                    url,
                    value.CreateTime = null ? "" : moment(value.CreateTime).format("YYYY-MM-DD HH:mm:ss"),
                    value.ModifyTime = null ? "" : moment(value.ModifyTime).format("YYYY-MM-DD HH:mm:ss"),
                    value.Author,
                    btnGroup
                ]);
            });
            return data;
        }

        function FindTypeNameById(id) {
            if (id == null)
                return 0;
            return ArticleTypeList[id].Name;
        }

        function ShowEditModal(data) {
            var html = `
                <div class="col-sm-12">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <i class="fa fa-eye"></i> 新增章
                        </div>
                        <div class="panel-body">
                            <div class="form-group">
                                <label class="col-xs-12">類別</label>
                                <select name="EditType" id="EditType" class="form-control">
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="EditAuthor" class="control-label">發文人</label>
                                <input type="text" name="EditAuthor" id="EditAuthor" class="form-control" value="${data.Author}" disabled />
                            </div>
                            <div class="form-group">
                                <label for="EditActiveTime" class="control-label">發文時間</label>
                                <input type="text" name="EditActiveTime" id="EditActiveTime" class="form-control" value="${data.CreateTime}" disabled />
                            </div>
                            <div class="form-group">
                                <label class="control-label">URL</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" value="${data.URL}" readonly>
                                    <span class="input-group-btn">
                                        <button class="btn btn-secondary copy-url" type="button">
                                            <i class="fa fa-copy"></i>
                                        </button>
                                    </span>
                                </div>
                                <div class="form-group">
                                    <label class="control-label">文章標題</label>
                                    <input name="EditTitle" id="EditTitle" class="form-control" type="text" value="${data.Title}">
                                </div>
                                <div class="form-group">
                                    <label class="control-label">內文</label>
                                    <textarea name="EditContent" id="EditContent"></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
            ShowEditModalBox(data.Title, html);

            CKEDITOR.replace('EditContent');
            CKEDITOR.instances.EditContent.setData(data.Content);
            $('#EditType').append(ArticleTypeOption);
            $('#EditType').val(data.Type);
        }

        function ShowEditModalBox(Title, Content) {
            if ($('#bs-modal-box').length < 1) {
                var html =
                    `<div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog modal-lg" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                    <h4 class="modal-title"></h4>
                                </div>
                                <div class="modal-body" style="display:flow-root">
                                    <p></p>
                                </div>
                                <div class="modal-footer">
                                    <button id="SendEditData" type="button" class="btn btn-success">確定</button>
                                    <button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>
                                </div>
                            </div>
                        </div>
                    </div>`;
                $('body').append(html);
            }
            $('#bs-modal-box h4.modal-title').html('<span class="label label-default">編輯文章</span> ' + Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show');
            $('#bs-modal-box').on('hidden.bs.modal', function () {
                if (CKEDITOR.instances['EditContent'])
                    CKEDITOR.instances['EditContent'].destroy();
            })
        }

        //處理新增
        function InsertItem() {
            var Type = $('#AddType').val();
            var Title = $('#AddTitle').val();
            var Author = $('.user-profile').text();
            var Content = CKEDITOR.instances.AddContent.getData();

            if (!Title || !Content) {
                alert("請輸入標題與內容!!");
                return;
            }

            if (!confirm("確定新增嗎?"))
                return;

            var SendData = {
                Type: Type,
                Title: Title,
                Content: Content,
                Author: Author
            };

            console.dir(SendData);

            LoadingEff(true);
            $.ajax({
                type: 'POST',
                url: "/ArticleAdd",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                LoadingEff(false);
            });
        };

        //處理修改
        function ModifyItem() {
            //var Id = currentRow.find("td:eq(0)").text();
            var Id = editID;
            var Type = $('#EditType').val();
            var Title = $('#EditTitle').val();
            var Content = CKEDITOR.instances.EditContent.getData();
            var URL = $('#EditURL').val();

            if (!Title || !Content) {
                alert("請輸入標題與內容!!");
                return;
            }

            if (!confirm("確定修改嗎?"))
                return;

            var SendData = {
                Id: Id,
                Type: Type,
                Title: Title,
                Content: Content
            };

            console.dir(SendData);
            LoadingEff(true);
            $.ajax({
                type: 'POST',
                url: "/ArticleModify",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                LoadingEff(false);
            });
        };

        //處理刪除
        function DeleteItem(id) {
            var SendData = {
                Id: id
            };

            if (!confirm("確定刪除嗎?"))
                return;

            LoadingEff(true);
            $.ajax({
                type: 'POST',
                url: "/ArticleDel",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                LoadingEff(false);
            });
        };

        function PreviewItem(url) {
            //<a href="http://www.wibibi.com" target="_blank" title="Wibibi 網頁設計教學百科">Wibibi 網頁設計教學百科</a>
            window.open(url, 'Preview', config='height=500,width=500');
        }

        function ClearAdd(e) {
            e.preventDefault();
            $("#AddType").val(1);
            $('#AddTitle').val("");

            CKEDITOR.instances.AddContent.setData("");
        }

        function ClearSearch(e) {
            e.preventDefault();
            $("#SearchType").val(1);
            $('#SearchTitle').val("");
            $('#SearchAuthor').val("");
            $('#SearchPostTime').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD HH:mm:ss'
                },
                startDate: moment(),
                endDate: moment(),
                timePicker: true,
                timePicker24Hour: true,
                timePickerSeconds: true,
                ranges: {
                    'Today': [moment().startOf('day'), moment().endOf('day')],
                    'Yesterday': [moment().subtract(1, 'days').startOf('day'), moment().subtract(1, 'days').endOf('day')],
                    'Last 7 Days': [moment().subtract(6, 'days').startOf('day'), moment().endOf('day')],
                    'Last 30 Days': [moment().subtract(29, 'days').startOf('day'), moment().endOf('day')],
                    'This Month': [moment().startOf('month'), moment().endOf('month')]
                }
            });
        }



        $.fn.modal.Constructor.prototype.enforceFocus = function () {
            var $modalElement = this.$element;
            $(document).on('focusin.modal',
                function (e) {
                    var $parent = $(e.target.parentNode);
                    if ($modalElement[0] !== e.target &&
                        !$modalElement.has(e.target).length &&
                        !$parent.hasClass('cke_dialog_ui_input_select') &&
                        !$parent.hasClass('cke_dialog_ui_input_text')) {
                        $modalElement.focus();
                    }
                });
        };

        $(document).on('click', '#InsertItem', InsertItem);
        $(document).on('click', '#ClearAdd', ClearAdd);

        $(document).on('click', '#SearchItem', SearchItem);
        $(document).on('click', '#ClearSearch', ClearSearch);

        $(document).on('click', '#SendEditData', ModifyItem);

        // 複製
        $(document).on('click', '.copy-url', function(event) {
            var copytext = $(this).parent().prev().val();
            $(this).parent().prev().select();
            document.execCommand("Copy");
            $.notify({
                message: '<i class="fa fa-check-circle"></i> URL已經複製完成：' + copytext
            },{
                type: 'success',
                z_index: 9999
            });
        });

        // 啟用時間開關
        $(document).on('change', '#SearchPostTimeSwitch', function(event) {
            $('#SearchPostTime').prop('disabled', !$(this).prop('checked'))
        });
    });
    </script>
</body>

</html>