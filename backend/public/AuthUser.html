<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    #datatable tbody td {
        vertical-align: middle;
    }

    .required {
        background-color: #FFF0F5;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>帳號檢視</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label class="control-label">使用者ID</label>
                                            <input id="AddAuthID" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">使用者名稱</label>
                                            <input id="AddAuthName" class="form-control" type="text">
                                        </div>
                                        <button id="mSearch" class="btn btn-primary" style="margin-bottom: 10px;">搜尋</button>
                                        <button id="AuthUserAdd" class="btn btn-primary" style="margin-bottom: 10px;">新增使用者</button>
                                        <!--
                                        <div class="form-group">
                                            <label class="control-label">使用者ID</label>
                                            <input id="AddAuthID" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">使用者密碼</label>
                                            <input id="AddAuthPass1" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">使用者密碼驗證</label>
                                            <input id="AddAuthPass2" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">信箱</label>
                                            <input id="AddAuthmail" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">IP</label>
                                            <input id="AddAuthIP" class="form-control" type="text">
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">群組名稱</label>
                                            <select id="AddAuthGroupList" class="form-control" required="required" style="margin-bottom: 10px;">
                                                <option class="text-center" value="0" selected></option>
                                            </select>
                                        </div>
                                        <button id="AuthUserAdd" class="btn btn-primary" style="margin-bottom: 10px;">新增使用者</button>
                                    -->
                                    </div>
                                    <div class="x_content">
                                        <table id="datatable" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>Id</th>
                                                    <th>使用者ID</th>
                                                    <th>使用者名稱</th>
                                                    <th>信箱</th>
                                                    <th>群組名稱</th>
                                                    <th>鎖定</th>
                                                    <th>IP</th>
                                                    <th>鎖定</th>
                                                    <th>功能</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /page content -->
        <!--footer-->
    </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog"></div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {
        var table = $('#datatable').DataTable({
            destroy: true,
            "lengthMenu": [
                [30, 50, 100, -1],
                [30, 50, 100, "∞"]
            ],
            "columnDefs": [
                { "targets": 0 },
                { "targets": 1 },
                { "targets": 2 },
                { "targets": 3 },
                { "targets": 4 },
                {
                    "targets": 5,
                    "visible": false,
                    "searchable": false
                },
                { "targets": 6 },
                {
                    "targets": 7,
                    "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                        "<button class='btn btn-danger' title='停權' id='activeN'><i class='fa fa-ban' aria-hidden='true'></i> 停權</button>" +
                        "<button class='btn btn-success' title='解除停權' id='activeY'><i class='fa fa-check' aria-hidden='true'></i> 解除停權</button>" +
                        "</div>"
                },
                {
                    "targets": 8,
                    "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                        "<button class='btn btn-info' id='modifyitem'><i class='fa fa-pencil-square-o' aria-hidden='true' dispaly='none'></i> 修改</button>" +
                        "<button class='btn btn-danger' id='deleteitem'><i class='fa fa-pencil-square-o' aria-hidden='true' dispaly='none'></i> 刪除</button>" +
                        "</div>"
                }
            ],
            'rowCallback': function(row, data, dataIndex) {
                if (data[4] === "Y") {
                    $(row).find('#activeN').hide();
                    $(row).find('#activeY').show();
                } else if (data[4] === 'N') {
                    $(row).find('#activeY').hide();
                    $(row).find('#activeN').show();
                }
            }
        });


        function GetAuthMemberList() {
            var AddAuthName = $('#AddAuthName').val().replace(/\s+/g, "");
            var AddAuthID = $('#AddAuthID').val().replace(/\s+/g, "");
            var Authdata = {};
            if (AddAuthName !== "") {
                Authdata.Name = AddAuthName;
            }
            if (AddAuthID !== "") {
                Authdata.ID = AddAuthID;
            }
            $('#loading-cover').fadeIn(100);
            table.clear().draw();
            var data = [];
            $.ajax({
                type: 'POST',
                url: "/AuthUser_info",
                data: Authdata,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        msg.data.forEach(function(value) {
                            data.push([
                                value.idAccount,
                                value.account,
                                value.NickName,
                                value.mail,
                                AuthGroup[value.AuthGroupId],
                                value.LockStatus,
                                value.IP
                            ]);
                        });
                        table.rows.add(data).draw();
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);;
            });
        }
        var AuthGroup = [];
        GetAuthGroupList();

        function GetAuthGroupList() {
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/AuthGroup_list",
                data: {},
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        msg.data.forEach(function(value) {
                            AuthGroup[value.idAuthGroup] = value.AuthGroupName;
                        });
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);;
            });
        }

        $(document).on('click', '#mSearch', GetAuthMemberList);

        $('#datatable tbody').on('click', 'button', function(e) {
            var data = table.row($(this).parents('tr')).data();
            switch ($(this).attr('id')) {
                case "modifyitem":
                    ShowEditModal(data);
                    break;
                case "deleteitem":
                    if (confirm("確定刪除嗎?")) {
                        DeleteUser(data[0]);
                    }
                    break;
            }

        });

        function DeleteUser(id) {
            $.ajax({
                type: 'POST',
                url: "/AuthUser_delete",
                data: { Id: id },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        alert(msg.msg);
                        GetAuthMemberList();
                    }
                }
            });
        }

        function ShowEditModal(data) {

            var html =
                `<div class="col-sm-12">
                <div class="panel panel-warning">
                <div class="panel-heading"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 修改資料</div>
                <div class="panel-body">

                <div class="form-group">
                <label class="control-label">Id</label>
                <input id="editUserid" class="form-control" type="number" readonly value= ${data[0]}>
                </div>
                <div class="form-group">
                <label class="control-label">使用者ID</label>
                <input id="UserAcc" class="form-control" readonly maxlength="50" type="text" value=${data[1]}>
                </div>
                <div class="form-group">
                <label class="control-label">使用者名稱</label>
                <input id="editUserName" class="form-control" maxlength="50" type="text" value=${data[2]}>
                </div>
                <div class="form-group">
                <label class="control-label">密碼</label>
                <input id="editUserPassword" class="form-control" maxlength="50" type="password">
                </div>
                <div class="form-group">
                <label class="control-label">密碼驗證</label>
                <input id="check_editUserPassword" class="form-control" maxlength="50" type="password">
                </div>
                <div class="form-group">
                <label class="control-label">信箱</label>
                <input id="editUserEmail" class="form-control" maxlength="50" type="text" value=${data[3]}>
                </div>
                <div class="form-group">
                <label class="control-label">IP</label>
                <input id="editUserIP" class="form-control" maxlength="200" type="text" value=${data[6]}>
                </div>
                <div class="form-group">
                <label class="control-label">群組名稱</label>
                <select id="editUserGroupName" class="form-control">
                ${GetOption(data[4])}
            </select>
            </div>

            </div>
            </div>
            </div>`;
            ShowModalBox("", html);
        }

        function ShowModalBox(Title, Content) {
                var html =
                    `<div class="modal-dialog" role="document">
                    <div class="modal-content">
                    <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body" style="display:flow-root">
                    <p></p>
                    </div>
                    <div class="modal-footer">
                    <button id="SendEditData" type="button" class="btn btn-success">確定</button> 
                    <button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>
                    </div> 
                    </div> 
                    </div>`;
                    
            $("#bs-modal-box").html(html);              
            $('#bs-modal-box h4.modal-title').html('<span class="label label-default">編輯使用者</span> ' + Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show')
        }

        function GetOption(data) {
            var option = "";
            AuthGroup.forEach(function(value, key) {
                if (data !== AuthGroup[key]) {
                    option = option + '<option class="text-center" value="' + key + '">' + AuthGroup[key] + '</option>';
                } else {
                    option = option + '<option class="text-center" value="' + key + '" selected>' + AuthGroup[key] + '</option>';
                }

            });
            return option;
        }

        $(document).on('click', '#SendEditData', SendEditData);
        $(document).on('click', '#AuthUserAdd', ShowAddData);
        $(document).on('click', '#SendAddData', SendAddData);

        function SendEditData() {
            $('#loading-cover').fadeIn(100);
            var editUserid = $('#editUserid').val();
            var editUserName = $('#editUserName').val();
            var password = $('#editUserPassword').val();
            var check_password = $('check_editUserPassword').val();
            var mail = $('#editUserEmail').val();
            var IP = $('#editUserIP').val();
            var AuthGroup = $('#editUserGroupName').val();

            var SendData = {
                id: editUserid,
                Name:editUserName,
                password: password,
                mail: mail,
                IP: IP,
                AuthGroup: AuthGroup
            };
            if(check_editUserPassword === check_password){
                $.ajax({
                    type: 'POST',
                    url: "/AuthUser_Modify",
                    data: SendData,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function (msg) {
                        $('#bs-modal-box').modal('hide');
                        GetAuthMemberList();
                    },
                    error: function (xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function () {
                    $('#loading-cover').fadeOut(100);
                });
            } else {
                alert('請確認兩次輸入的密碼相同');
            }
        }

        function ShowAddData(data) {

            var html =
                `<div class="col-sm-12">
                <div class="panel panel-warning">
                <div class="panel-heading"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 新增資料</div>
                <div class="panel-body">


                <div class="form-group">
                <label class="control-label">使用者帳號</label>
                <input id="editUserAccount" class="form-control" maxlength="50" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">使用者名稱</label>
                <input id="editUserName" class="form-control" maxlength="50" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">密碼</label>
                <input id="editUserPassword1" class="form-control" maxlength="50" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">驗證密碼</label>
                <input id="editUserPassword2" class="form-control" maxlength="50" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">信箱</label>
                <input id="editUserEmail" class="form-control" maxlength="50" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">IP</label>
                <input id="editUserIP" class="form-control" maxlength="200" type="text">
                </div>
                <div class="form-group">
                <label class="control-label">群組名稱</label>
                <select id="editUserGroupName" class="form-control">
                ${GetOption(0)}
            </select>
            </div>

            </div>
            </div>
            </div>`;
            ShowModalBox2("", html);
        }

        function ShowModalBox2(Title, Content) {
            
                var html =
                    `<div class="modal-dialog" role="document">
                    <div class="modal-content">
                    <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title"></h4>
                    </div>
                    <div class="modal-body" style="display:flow-root">
                    <p></p>
                    </div>
                    <div class="modal-footer">
                    <button id="SendAddData" type="button" class="btn btn-success">確定</button>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>
                    </div>
                    </div>
                    </div>`;

            $("#bs-modal-box").html(html);        
            $('#bs-modal-box h4.modal-title').html('<span class="label label-default">編輯使用者</span> ' + Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show')
        }

        function SendAddData() {
            var editUserAccount = $('#editUserAccount').val().replace(/\s+/g, "");;
            var editUserName = $('#editUserName').val().replace(/\s+/g, "");;
            var editUserPassword1 = $('#editUserPassword1').val().replace(/\s+/g, "");;
            var editUserPassword2 = $('#editUserPassword2').val().replace(/\s+/g, "");;
            var mail = $('#editUserEmail').val().replace(/\s+/g, "");;
            var IP = $('#editUserIP').val().replace(/\s+/g, "");;
            var AuthGroup = $('#editUserGroupName').val();
            if (editUserAccount === "" || editUserName === "" || editUserPassword1 === "" || mail === "" || IP === "") {
                alert("不能有未填寫資料");
                return;
            }
            if (editUserPassword1 !== editUserPassword2) {
                alert("密碼不符合");
                return;
            }
             $('#loading-cover').fadeIn(100);
            var SendData = {
                Account: editUserAccount,
                Name: editUserName,
                password: editUserPassword1,
                mail: mail,
                IP: IP,
                AuthGroup: AuthGroup
            };
            $.ajax({
                type: 'POST',
                url: "/AuthUser_add",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    GetAuthMemberList();
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

    });
    </script>
</body>

</html>