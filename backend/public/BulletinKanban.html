<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- jquery-ui -->
    <link rel="stylesheet" href="../vendors/jquery-ui/jquery-ui.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    #gallery-sortable li {
        margin: .1%;
        width: 19.8%;
        padding: 5px;
    }

    #gallery-sortable .pinSize {
        overflow: hidden;
        height: 170px;
    }

    #gallery-sortable .edit-news-content,
    #gallery-sortable h3 {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    /*圖片選擇*/

    #sub-gallery-sortable>li.selected[data-pid]>.thumbnail {
        box-shadow: 0 0 1px 3px rgba(0, 130, 255, 0.7);
        border-color: rgba(0, 0, 0, 0);
    }

    #sub-gallery-sortable li {
        margin: .2%;
        width: 19.5%;
        height: 181px;
        padding: 5px;
    }

    .thumbnail {
        height: auto;
        margin-bottom: 0px;
    }

    #sub-gallery-sortable .pinSize {
        overflow: hidden;
        height: 95px;
    }

    #sub-gallery-sortable .over-img-block {
        position: relative;
        padding: 10px;
        width: 100%;
        height: 100%;
        z-index: 99;
        margin-bottom: -95px;
    }

    #sub-gallery-sortable .edit-over-item {
        position: relative;
        background: rgba(180, 180, 180, .3);
        width: 100%;
        height: 160px;
        padding: 32px 10px 10px 10px;
        margin-bottom: -160px;
        z-index: 999;
    }

    #sub-gallery-sortable p {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    </style>
    <style type="text/css" media="screen">
    #datatable tbody td {
        vertical-align: middle;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>公告設定</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-lg-6 col-md-12 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="fa fa-book" aria-hidden="true"></i> 新增項目</div>
                                                <div class="panel-body">
                                                   <!-- <div class="form-group">
                                                        <label for="mGroup" class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">受眾*</label>
                                                        <select name="mGroup" id="mGroup" class="form-control" disabled="">
                                                            <option value="none" selected>請選擇受眾</option>
                                                            <option value="all">全會員發送</option>
                                                            <option value="single">單一會員</option>
                                                        </select>
                                                        <p class="help-block">*必選項目</p>
                                                    </div>-->
                                                    <div class="form-group">
                                                        <label for="Title" class="control-label" data-toggle="tooltip" data-placement="right" title="必填, 1~12中字。">標題* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="Title" id="Title" class="form-control text-center" value="" maxlength="12"/>
                                                    </div>
                                                    <div class="form-group">
                                                        <label for="Type" class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">類型*</label>
                                                        <select name="Type" id="Type" class="form-control" >
                                                            <option value= 0 selected>請選擇類型</option>
                                                            <option value= 1>活動</option>
                                                            <option value= 2>公告</option>
                                                        </select>
                                                        <p class="help-block">*必選項目</p>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label">版型*</label>
                                                        <select name="Template" id="Template" class="form-control">
                                                            <option value= 0 selected>請選擇版型</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group">
                                                            <label for="BulletinContent" class="control-label" data-toggle="tooltip" data-placement="right" title="	必填, 1~1200中字。">公告內容* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                            <textarea id="BulletinContent" class="date-picker form-control col-md-7 col-xs-12" maxlength="1200" rows="5" style="margin-bottom: 2vh;resize: none;"></textarea>
                                                    </div>
                                                    <div class="form-group" id="ButtonTextGroup">
                                                        <label for="ButtonText" class="control-label" data-toggle="tooltip" data-placement="right" title="連結按鈕文字 ,必填, 1~7中字。">連結按鈕* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="ButtonText" id="ButtonText" class="form-control text-center" value="" maxlength="7"/>
                                                    </div>
                                                    <div class="form-group" id="MainTypeSelectGroup">
                                                            <label class="control-label">連結類型*</label>
                                                            <select name="MainTypeSelect" id="MainTypeSelect" class="form-control">
                                                            </select>
                                                    </div>
                                                    <div class="form-group" id="SubTypeSelectGroup">
                                                        <label class="control-label" id="SubTypeLabel">連結子類型*</label>
                                                        <select name="SubTypeSelect" id="SubTypeSelect" class="form-control">
                                                        </select>
                                                    </div>
                                                    <div class="form-group" id="URLInputLabelGroup">
                                                            <label for="URLInput" class="control-label" id="URLInputLabel">自訂網址</label>
                                                            <input type="text" name="URLInput" id="URLInput" class="form-control" />
                                                    </div>
                                                    <div class="form-group">
                                                            <label class="control-label">公告起訖時間 <i aria-hidden="true"></i></label>
                                                            <input type="text" name="ActiveTime" id="ActiveTime" class="form-control" value="" />
                                                    </div>

                                                    <div class="form-group">
                                                            <label for="TagType" class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">標籤種類</label>
                                                            <select name="TagType" id="TagType" class="form-control" >
                                                                <option value= 0 selected>無標籤</option>
                                                                <option value= 1>限時</option>
                                                                <option value= 2>熱門</option>
                                                                <option value= 3>優惠</option>
                                                            </select>
                                                     </div>

                                                    <div class="form-group">                                     
                                                            <label class="control-label" data-toggle="tooltip" data-placement="right" title="">標籤起訖時間</label>
                                                            <input type="text" name="TagTime" id="TagTime" class="form-control" value="" />
                                                    </div>

                                                    <div class="form-group">
                                                        <label for="Description" class="control-label" data-toggle="tooltip" data-placement="right" title="選填, 1~50中字。">敘述 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="Description" id="Description" class="form-control text-center" value="" maxlength="50"/>
                                                    </div>
   
                                                    <div class="form-group" id="selectPictureWindowGroup">
                                                        <div class="btn-group btn-group-sm btn-group-justified">
                                                            <a href="javascript:;" id="selectPictureWindow" class="btn btn-success" style="width: 80%;"><i class="fa fa-th" aria-hidden="true"></i> 圖片選擇</a>
                                                            <a href="javascript:;" id="cancelSelectedPicture" class="btn btn-danger" style="width: 20%;"><i class="fa fa-undo" aria-hidden="true"></i> 取消</a>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="form-group">
                                                            <input type="hidden" id="pictureData" value="">
                                                            <img id="SelectedPicturePreview" src="#" alt="Selected Picture Preview" class="img-responsive img-thumbnail hidden" />
                                                    </div>
                                                    <div class="col-md-12">
                                                            <button type="button" id="InsertItem" class="btn btn-lg btn-primary pull-right">確定送出</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-12 col-sm-12 col-xs-12">
                                            <div class="x_panel">
                                                <div class="x_title">
                                                    <h2>List</h2>
                                                    <div class="clearfix"></div>
                                                </div>
                                                <div class="x_content">
                                                    <ul id="gallery-sortable" class="list-unstyled row">
                                                        <li class="pull-left">
                                                            <div class="thumbnail">
                                                                <div class="pinSize">
                                                                    <img data-src="#" alt="" class="img-responsive">
                                                                </div>
                                                                <div class="caption">
                                                                    <h3>title</h3>
                                                                    <p class="edit-adwindow-content text-ellipsis"></p>
                                                                    <p class="edit-adwindow-audience text-ellipsis"></p>
                                                                    <p class="edit-adwindow-location text-ellipsis"></p>
                                                                    <p class="edit-adwindow-type text-ellipsis"></p>
                                                                    <p class="edit-adwindow-subtype text-ellipsis"></p>
                                                                    <p class="edit-adwindow-start-time pull-right"><i class="fa fa-calendar" aria-hidden="true" data-toggle="tooltip" data-placement="top" title="開始時間（網站不會顯示）"></i> <span></span></p>
                                                                    <p class="edit-adwindow-end-time pull-right"><i class="fa fa-calendar" aria-hidden="true" data-toggle="tooltip" data-placement="top" title="結束時間（網站不會顯示）"></i> <span></span></p>
                                                                    <div class="btn-group btn-group-justified">
                                                                        <!--<a href="javascript:;" title="" class="item-enabled btn btn-default"><i class="fa" aria-hidden="true"></i> <span>顯示</span></a>-->
                                                                        <a href="javascript:;" title="" class="item-edit btn btn-primary"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 編輯</a>
                                                                        <!--<a href="javascript:;" title="" class="item-top btn btn-default"><i class="fa fa-pencil-square-o" aria-hidden="true"></i> 置頂</a>-->
                                                                        <a href="javascript:;" title="" class="item-del btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> 刪除</a>
                                                                    </div>
                                                                </div>  
                                                            </div>
                                                        </li>
                                                    </ul>
                                                    <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                                                        <button id="SendOrder" type="button" class="btn btn-success btn-lg pull-right">送出順序</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /page content -->
        <!--footer-->
    </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- jquery-ui -->
    <script src="../vendors/jquery-ui/jquery-ui.min.js"></script>
    <script>
    // $.widget.bridge('uibutton', $.ui.button);
    $.widget.bridge('uitooltip', $.ui.tooltip);
    </script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {

        var Type = 'BulletinKanban';
        var allImageInfo = {};
        var LangList = {};
        var LangOption = '';
        var CDN_Domain = "";

        $('#URLInput').hide();
        $('#URLInputLabel').hide();

        getCDNDomain();
        GetBulletinKanbanTemplate($('#Template'));
        
        function getCDNDomain() {
            $.ajax({
                    url: '/GetCDNDomainWithENV',
                    type: 'GET',
                    data: { type: Type }
                }).done(function(result) {
                    CDN_Domain = result;
                    console.log(CDN_Domain);
                })
                .fail(function() {
                    alert("Get CDN Domain ERROR!");
                });
        }

        $("#gallery-sortable").sortable({
            cursor: "move",
            delay: 200,
            tolerance: "pointer",
            cancel: ".ui-state-disabled"
        });

        $("#gallery-sortable").disableSelection();

        $('#ActiveTime').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment(),
            endDate: moment(),
            timePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            ranges: {
                'Today': [moment().startOf('day'), moment().endOf('day')],
                'Tomorrow': [moment().add(1, 'days').startOf('day'), moment().add(1, 'days').endOf('day')],
                '7 Days': [moment().startOf('day'), moment().add(6, 'days').endOf('day')],
                '30 Days': [moment().startOf('day'), moment().add(29, 'days').endOf('day')],
                'This Month': [moment().startOf('month'), moment().endOf('month')]
            }
        });

        $('#TagTime').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment(),
            endDate: moment(),
            timePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            ranges: {
                'Today': [moment().startOf('day'), moment().endOf('day')],
                'Tomorrow': [moment().add(1, 'days').startOf('day'), moment().add(1, 'days').endOf('day')],
                '7 Days': [moment().startOf('day'), moment().add(6, 'days').endOf('day')],
                '30 Days': [moment().startOf('day'), moment().add(29, 'days').endOf('day')],
                'This Month': [moment().startOf('month'), moment().endOf('month')]
            }
        });

        var ItemAudience = {};
        var allItemInfo = [];
        var allImageInfo = {};
        var LangList = {};
        var LangOption = '';
        var AudienceList = {};
        var AudienceOption = '';

        var GamesInfoTypeList = {};
        var GamesInfoTypeAOption = '';
        var GamesInfoTypeBOption = '';
        var GamesInfoTypeAList = {};
        var GamesInfoTypeBList = {};

        var MainTypeOption = '';
        var MainTypeList = {};

        var PageInfoOption = '';
        var PageInfoList = {};

        var URLInfoOption = '';
        var URLInfoList = {};

        var HallDataOption = '';
        var HallDataList = {};

        function ShowModalBox(Title, Content, footer) {
            $('#bs-modal-box').remove();
            var html =
                '<div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '<h4 class="modal-title"></h4>' +
                '</div>' +
                '<div class="modal-body" style="display:flow-root">' +
                '<p></p>' +
                '</div>' +
                (footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
                '</div>' +
                '</div>' +
                '</div>';
            $('body').append(html);
            $('#bs-modal-box h4.modal-title').html(Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show')           
        }

        function SortByOrder(a, b){ 
          var aOrder = a.Order;
          var bOrder = b.Order;
          return ((aOrder < bOrder) ? -1 : ((aOrder > bOrder) ? 1 : 0)); 
        }

        getTypeList();
        function getTypeList() {
            $.ajax({
                url: '/ADWindowGetType',
                type: 'POST',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    $.each(data.data, function(index, value) {
                        if (value.ADType == 'ADWindow' ||  value.ADType == 'Both') {
                            if (value.Type == 'Main')
                                MainTypeList[value.Order] = value;
                            if (value.Type == 'Page')
                                PageInfoList[value.Order] = value;
                            if (value.Type == 'URL')
                                URLInfoList[value.Order] = value;
                        }
                    });


                    $.each(MainTypeList, function(index, value) {
                        MainTypeOption += '<option value="' + index + '">' + value.Name + '</option>';
                    });
                    $('#MainTypeSelect').append(MainTypeOption);

                    $.each(PageInfoList, function(index, value) {
                        PageInfoOption += '<option value="' + index + '">' + value.Name + '</option>';
                    });

                    $.each(URLInfoList, function(index, value) {
                        URLInfoOption += '<option value="' + index + '">' + value.Name + '</option>';
                    });
                }
            }).done(function() {
                getLangList(Type);
            });            
        }

        function getLangList() {
            $.ajax({
                url: '/getLangList',
                type: 'POST',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    $.each(data.data, function(index, value) {
                        LangList[value.Code] = value.Lang.toString();
                    });
                    LangOption = '';
                    LangOption += '<select class="form-control item-lang">';
                    $.each(LangList, function(index, value) {
                        LangOption += '<option value="' + index + '">' + value + '</option>';
                    });
                    LangOption += '</select>';
                }
            }).done(function() {
                getHallData();
            });
        }

        function getHallData() {
            $.ajax({
                url: '/ADBannerGetHallData',
                type: 'POST',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    $.each(data.data, function(index, value) {
                        HallDataList[value.Id] = value;
                    });
                }
            }).done(function() {
                getGamesInfo();
            });   
        }

        function getGamesInfo() {
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/ADBannerGetGamesInfo",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var hallStr = 'LobbyService/switchscene/machine/{$GameId}/{$HallId}';
                    var openGameStr = 'GameService/opengame/{$GameId}';
                    $.each(msg.data, function(index, value) {
                        GamesInfoTypeList[value.SCGGameId] = value;
                    });
                    GamesInfoTypeAOption = '';
                    GamesInfoTypeBOption = '';
                    $.each(GamesInfoTypeList, function(index, value) {
                        if (value.GameTypeId == 1) {
                            $.each(HallDataList, function(hallIndex, hallValue) {
                                var res = hallStr.replace('{$GameId}', value.SCGGameId).replace('{$HallId}', hallValue.Id);
                                GamesInfoTypeAOption += '<option value="' + res + '">' + value.GameName + '(' + hallValue.HallName + ')</option>';
                                GamesInfoTypeAList[res] = value.GameName + '(' + hallValue.HallName + ')';
                            });
                            var openGameStrRes = openGameStr.replace('{$GameId}', value.SCGGameId);
                            GamesInfoTypeBOption += '<option value="' + openGameStrRes + '">' + value.GameName + '</option>';
                            GamesInfoTypeBList[openGameStrRes] = value.GameName;
                        }
                    });
                    $('#SubTypeSelect').empty();
                    $('#SubTypeSelect').append(GamesInfoTypeAOption);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                getAllItemData();
                $('#loading-cover').fadeOut(100); 
            });
        }

        function getImageSize(input, callback=null){
            var _URL = window.URL || window.webkitURL;
            var file, img;
            file = input.files[0];
            img = new Image();
            img.onload = function () {
                callback(this.width, this.height);
            };
            img.src = _URL.createObjectURL(file);
        }

        function sizeLimit(input) {
            console.log("sizeLimit Check");
            if ($(input).attr('data-max-filesize') > 0) {
                size = input.files[0].size;
                limit = $(input).attr('data-max-filesize') * 2048;
                if (size > limit) {
                    return false;
                } else {
                    return true;
                }
            } else {
                return false;
            }
        }

        function fileTypeChecker(input) {
            console.log("$(input).attr('accept') : " + $(input).attr('accept'));
            console.log("$(input) : " + $(input));
            if ($(input).attr('accept').length > 0) {
                type = input.files[0].type.toString();
                attType = $(input).attr('accept').toString();
                if (type == attType) {
                    return true;
                } else {
                    return false;
                }
            } else {
                return false;
            }
        }

        function imagePreview(input, target = null) {
            if (input.files && input.files[0]) {
                if (target == null) {
                    if ($(input).next().hasClass('previewImage')) {
                        $(input).next().show();
                    } else {
                        $(input).after('<img src="" class="previewImage img-responsive img-thumbnail" alt="" style="margin-top: 10px;">');
                    }
                } else {
                    target.removeClass('hidden');
                }
                var reader = new FileReader();
                reader.onload = function(e) {
                    if (target == null) {
                        $(input).next().attr('src', e.target.result);
                    } else {
                        target.attr('src', e.target.result);
                    }
                }
                reader.readAsDataURL(input.files[0]);
            } else {
                if (target == null) {
                    $(input).next().attr('src', "#");
                } else {
                    target.addClass('hidden');
                    target.attr('src', "#");
                }
            }
        }

        function itemEdit() {
            var itemTitle = $(this).parents('.caption').find('h3').text();
            var itemDetail = $(this).parents('.caption').find('.edit-news-content').text();
            var itemYoutube = $(this).parents('.caption').find('.show-youtube-modal').attr('data-youtube');
            var pid = $(this).parents('.ui-sortable-handle').attr('data-pid');
            var selectPicture = $(this).attr('data-pid');
            var _element = $(this).parents('.ui-sortable-handle');

            var html = `<div class="form-group">
                            <label for="edit_Title" class="control-label" data-toggle="tooltip" data-placement="right" title="必填, 1~12中字。">標題* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                            <input type="text" name="edit_Title" id="edit_Title" class="form-control text-center" value="" maxlength="12"/>
                        </div>
                        <div class="form-group">
                            <label for="edit_Type" class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">類型*</label>
                            <select name="edit_Type" id="edit_Type" class="form-control" >
                                <option value= 0 selected>請選擇類型</option>
                                <option value= 1>活動</option>
                                <option value= 2>公告</option>
                            </select>
                            <p class="help-block">*必選項目</p>
                        </div>
                        <div class="form-group">
                            <label class="control-label">版型*</label>
                            <select name="edit_Template" id="edit_Template" class="form-control">
                                <option value="0" >請選擇版型</option>
                            </select>
                        </div>
                        <div class="form-group">
                                <label for="edit_BulletinContent" class="control-label" data-toggle="tooltip" data-placement="right" title="	必填, 1~1200中字。">公告內容* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                <textarea id="edit_BulletinContent" class="date-picker form-control col-md-7 col-xs-12" maxlength="1200" rows="5" style="margin-bottom: 2vh;resize: none;"></textarea>
                        </div>
                        <div class="form-group" id="edit_ButtonTextGroup">
                            <label for="edit_ButtonText" class="control-label" data-toggle="tooltip" data-placement="right" title="連結按鈕文字 ,必填, 1~7中字。">連結按鈕* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                            <input type="text" name="edit_ButtonText" id="edit_ButtonText" class="form-control text-center" value="" maxlength="7"/>
                        </div>
                        <div class="form-group" id="edit_MainTypeSelectGroup">
                                <label class="control-label">連結類型*</label>
                                <select name="edit_MainTypeSelect" id="edit_MainTypeSelect" class="form-control">
                                </select>
                        </div>
                        <div class="form-group" id="edit_SubTypeSelectGroup">
                            <label class="control-label" id="edit_SubTypeLabel">連結子類型*</label>
                            <select name="edit_SubTypeSelect" id="edit_SubTypeSelect" class="form-control">
                            </select>
                        </div>
                        <div class="form-group" id="edit_URLInputLabelGroup">
                                <label for="edit_URLInputLabel" class="control-label" id="edit_URLInputLabel">自訂網址</label>
                                <input type="text" name="edit_URLInput" id="edit_URLInput" class="form-control" />
                        </div>
                        <div class="form-group">
                                <label class="control-label">公告起訖時間 <i aria-hidden="true"></i></label>
                                <input type="text" name="edit_ActiveTime" id="edit_ActiveTime" class="form-control" value="" />
                        </div>

                        <div class="form-group">
                                <label for="edit_TagType" class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">標籤種類</label>
                                <select name="edit_TagType" id="edit_TagType" class="form-control" >
                                    <option value= 0 selected>無標籤</option>
                                    <option value= 1>限時</option>
                                    <option value= 2>熱門</option>
                                    <option value= 3>優惠</option>
                                </select>
                            </div>

                        <div class="form-group">                                     
                                <label class="control-label" data-toggle="tooltip" data-placement="right" title="">標籤起訖時間</label>
                                <input type="text" name="edit_TagTime" id="edit_TagTime" class="form-control" value="" />
                        </div>

                        <div class="form-group">
                            <label for="edit_Description" class="control-label" data-toggle="tooltip" data-placement="right" title="選填, 1~50中字。">敘述 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                            <input type="text" name="edit_Description" id="edit_Description" class="form-control text-center" value="" maxlength="50"/>
                        </div>`;

            html += `<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
                <hr/>
                <ul id="sub-gallery-sortable" class="list-unstyled row ui-sortable">
                </ul>
                </div>`;

            footer = `<button id="SendEditData" type="button" class="btn btn-success">確定</button>
                      <button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>`;

            ShowModalBox('Item Edit', html, footer);

            $('#edit_URLInputLabel').hide();
            $('#edit_URLInput').hide();
            //$('#edit_itemTitle').val(itemTitle);
            $('#SendEditData').attr('data-pid', pid);
            $('[data-toggle="tooltip"]').tooltip();

            $('#bs-modal-box').on('shown.bs.modal', function(e) {                
                getGalleryData(Type, 'DESC', selectPicture);
            });
            
            var item = getItem(pid);

            if (item == null)
                return;

            var type = item.AcType;
            var subType = item.AcSubType;
            var command = item.Command;
            
            $('#edit_BulletinContent').val(item.Content);
            $('#edit_Title').val(item.Title);
            $('#edit_Type').val(item.Type);  
            $('#edit_ButtonText').val(item.BtnText);
            $('#edit_TagType').val(item.TagType);
            $('#edit_Description').val(item.Description);

            GetBulletinKanbanTemplate($('#edit_Template'), function (){
                $('#edit_Template').val(item.Template);
            });
                
            switch (parseInt(type)) {
                case 3:
                    if (parseInt(subType) == 0) {
                        $('#edit_URLInputLabel').show();
                        $('#edit_URLInput').show();
                        $('#edit_URLInput').val(command.replace("webService/openwebview/", ""));
                    }
                    break;

                case 5:
                    $('#edit_URLInputLabel').show();
                    $('#edit_URLInput').show();
                    $('#edit_URLInput').val(/[^/]*$/.exec(command)[0]);
                    break;
            }
            if ((parseInt(type) == 3 && parseInt(subType) == 0) || parseInt(type) == 5) {
                $('#edit_URLInputLabel').show();
                $('#edit_URLInput').show();
                if (parseInt(type) == 5) {
                    console.log("11111111");
                    $('#edit_URLInput').val(/[^/]*$/.exec(command)[0]);
                } else {
                    console.log("222222222");
                    $('#edit_URLInput').val(command.replace("webService/openwebview/", ""));
                }
            }

            if ((parseInt(type) == 2 && parseInt(subType) == 10) || (parseInt(type) == 2 && parseInt(subType) == 11)) {
                $('#edit_URLInput').val(/[^/]*$/.exec(command)[0]);
            }

         //   $('#edit_AudienceSelect').append(AudienceOption);
            $('#edit_MainTypeSelect').append(MainTypeOption);
            $('#edit_SubTypeSelect').empty();
            mainTypeSelectChange($('#edit_URLInputLabel'), $('#edit_URLInput'), $('#edit_SubTypeLabel'), $('#edit_SubTypeSelect'), parseInt(type));
            onTemplateChange($('#sub-gallery-sortable'), $('#edit_ButtonTextGroup'), $('#edit_MainTypeSelectGroup'), $('#edit_SubTypeSelectGroup'), $('#edit_URLInput'), parseInt(item.Template), parseInt(item.AcType), parseInt(item.AcSubType));


            // switch (parseInt(type)) {
            //     case 0:
            //         $('#edit_SubTypeSelect').append(GamesInfoTypeAOption);
            //         break;

            //     case 1:
            //         $('#edit_SubTypeSelect').append(GamesInfoTypeBOption);
            //         break;

            //     case 2:
            //         $('#edit_SubTypeSelect').append(PageInfoOption);
            //         break;

            //     case 3:
            //         $('#edit_SubTypeSelect').append(URLInfoOption);
            //         break;
            // }
       

            $(document).on('change', '#edit_MainTypeSelect', function(event) {
                mainTypeSelectChange($('#edit_URLInputLabel'), $('#edit_URLInput'), $('#edit_SubTypeLabel'), $('#edit_SubTypeSelect'), parseInt($(this).val()));
            });

            $(document).on('change', '#edit_SubTypeSelect', function(event) {
                subTypeSelectChange($('#edit_URLInputLabel'), $('#edit_URLInput'), $('#edit_MainTypeSelect').val(), parseInt($(this).val()));
            });

            $(document).on('change', '#edit_Template', function(event) {
                onTemplateChange($('#sub-gallery-sortable'), $('#edit_ButtonTextGroup'), $('#edit_MainTypeSelectGroup'), $('#edit_SubTypeSelectGroup'), $('#edit_URLInput'), parseInt($(this).val()), $('#edit_MainTypeSelect').val(), $('#edit_SubTypeSelect').val());
            });

            $('#edit_itemDescript').val(item.Content);
          //  $('#edit_AudienceSelect').val(findAudienceIdByADBannerId(item.Id));
            $('#edit_MainTypeSelect').val(type);
            $('#edit_SubTypeSelect').val(subType);

            $('#edit_ActiveTime').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD HH:mm:ss'
                },
                startDate: moment(item.TimeStart).format('YYYY-MM-DD HH:mm:ss'),
                endDate: moment(item.TimeEnd).format('YYYY-MM-DD HH:mm:ss'),
                timePicker: true,
                timePicker24Hour: true,
                timePickerSeconds: true,
                ranges: {
                    'Today': [moment().startOf('day'), moment().endOf('day')],
                    'Tomorrow': [moment().add(1, 'days').startOf('day'), moment().add(1, 'days').endOf('day')],
                    '7 Days': [moment().startOf('day'), moment().add(6, 'days').endOf('day')],
                    '30 Days': [moment().startOf('day'), moment().add(29, 'days').endOf('day')],
                    'This Month': [moment().startOf('month'), moment().endOf('month')]
                }
            });

            $('#edit_TagTime').daterangepicker({
                locale: {
                    format: 'YYYY-MM-DD HH:mm:ss'
                },
                startDate: moment(item.TagTimeStart).format('YYYY-MM-DD HH:mm:ss'),
                endDate: moment(item.TagTimeEnd).format('YYYY-MM-DD HH:mm:ss'),
                timePicker: true,
                timePicker24Hour: true,
                timePickerSeconds: true,
                ranges: {
                    'Today': [moment().startOf('day'), moment().endOf('day')],
                    'Tomorrow': [moment().add(1, 'days').startOf('day'), moment().add(1, 'days').endOf('day')],
                    '7 Days': [moment().startOf('day'), moment().add(6, 'days').endOf('day')],
                    '30 Days': [moment().startOf('day'), moment().add(29, 'days').endOf('day')],
                    'This Month': [moment().startOf('month'), moment().endOf('month')]
                }
            });
        }

        function getItem(id) {
            var item = null;
            $.each(allItemInfo, function(index, value) {
                if (value.Id == id) {
                    item = value;
                    return;
                }
            });
            return item;
        }

        function sendItemEditData() {
            var checkStatus = false;
            var requestData = {r : true};

            var checkDataStr = modifyItemCheck();
            if (checkDataStr != "") {
                alert(checkDataStr);
                return;
            }
            
            var pic = $('#sub-gallery-sortable input.pictureSelected:checked').val();

            if (!checkIsNullOrEmpty(pic))
                pic = CDN_Domain+pic;
            else 
                pic = "";

            requestData.Id = $(this).attr('data-pid');
            requestData.Title = $('#edit_Title').val();
            requestData.Type = $('#edit_Type').val();
            requestData.BulletinContent = $('#edit_BulletinContent').val();
            requestData.Template = $('#edit_Template').val();
            requestData.MainTypeSelect = $('#edit_MainTypeSelect').val();
            requestData.SubTypeSelect = $('#edit_SubTypeSelect').val();
            requestData.StartTime =  $('#edit_ActiveTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.EndTime = $('#edit_ActiveTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.BulletinPic = pic;
            requestData.TagType = $('#edit_TagType').val();
            requestData.TagTimeStart = $('#edit_TagTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.TagTimeEnd = $('#edit_TagTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.BtnText = $('#edit_ButtonText').val();
            requestData.Description = $('#edit_Description').val();
            var MainType = $('#edit_MainTypeSelect').val();
            var SubType = $('#edit_SubTypeSelect').val();
            
            var template = parseInt(requestData.Template);
      
            if (template === 2 || template === 4 || template === 6) {
                requestData.BtnText = "";
                requestData.MainTypeSelect = 0;
                requestData.SubTypeSelect = 0;
            }
            
            if (template === 5 || template === 6) {
                requestData.BulletinPic = "";
            }


            var Command = getSettingCommand(parseInt(MainType), SubType, $('#edit_URLInput'));
            if (Command == "Error")
                return;
            
            requestData.Command = Command;
             
            console.log("Command : " + requestData.Command);

            LoadingEff(true);
            $.ajax({
                url: '/EditBulletinKanban',
                type: 'POST',
                data: { SendData: JSON.stringify(requestData) },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    checkStatus = true;
                }
            }).always(function() {
                if (!checkStatus) {
                    alert('編輯失敗');
                } else {
                    alert('編輯成功');
                    getAllItemData();
                }
                LoadingEff(false);
            });
        }

        function itemDel() {
            var confirmData = confirm("確定要刪除？");
            var checkStatus = false;

            if (confirmData) {
                var pid = $(this).parents('.ui-sortable-handle').attr('data-pid');
                var _element = $(this).parents('.ui-sortable-handle');

                $.ajax({
                    url: '/BulletinKanbanItemDel',
                    type: 'POST',
                    data: { Id: pid },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(data) {
                        _element.remove();
                        checkStatus = true;
                    }
                }).always(function() {
                    if (!checkStatus)
                        alert('發生錯誤');
                });
            }
        }

        $(document).on('click', '#SendOrder', eachOrder);
        $(document).on('click', '#InsertItem', InsertItem);
        $(document).on('click', '.item-del', itemDel);
        $(document).on('click', '.item-edit', itemEdit);
        $(document).on('click', '#SendEditData', sendItemEditData);

        $(document).on('change', '#MainTypeSelect', function(event) {
            mainTypeSelectChange($('#URLInputLabel'), $('#URLInput'), $('#SubTypeLabel'), $('#SubTypeSelect'), parseInt($(this).val()));
        });

        $(document).on('change', '#SubTypeSelect', function(event) {
            subTypeSelectChange($('#URLInputLabel'), $('#URLInput'), $('#MainTypeSelect').val(), parseInt($(this).val()));
        });

        $(document).on('change', '#Template', function(event) {
            onTemplateChange($('#selectPictureWindowGroup'), $('#ButtonTextGroup'), $('#MainTypeSelectGroup'), $('#SubTypeSelectGroup'), $('#URLInput'), parseInt($(this).val()), $('#MainTypeSelect').val(), $('#SubTypeSelect').val());
        });

        function mainTypeSelectChange(URLInputLabel, URLInput, SubTypeLabel, SubTypeSelect, val) {
            URLInputLabel.hide();
            URLInput.hide();
            SubTypeLabel.hide();
            SubTypeSelect.hide();
            SubTypeSelect.empty();

            switch (val) {
                case 0:
                    SubTypeSelect.append(GamesInfoTypeAOption);
                    SubTypeLabel.show();
                    SubTypeSelect.show();
                    break;

                case 1:
                    SubTypeSelect.append(GamesInfoTypeBOption);
                    SubTypeLabel.show();
                    SubTypeSelect.show();
                    break;

                case 2:
                    SubTypeSelect.append(PageInfoOption);
                    SubTypeLabel.show();
                    SubTypeSelect.show();
                    break;

                case 3:
                    URLInputLabel.text("自訂網址");
                    SubTypeSelect.append(URLInfoOption);
                    SubTypeLabel.show();
                    SubTypeSelect.show();
                    URLInputLabel.show();
                    URLInput.show();
                    break;

                case 4:
                    SubTypeSelect.hide();
                    break;

                case 5:
                    URLInputLabel.text("活動Id");
                    SubTypeSelect.hide();
                    URLInputLabel.show();
                    URLInput.show();
                    break;
            }
        }
        
        function onTemplateChange(BtnPic, BtnText, ActTypeGroup, AcSubTypeGroup, URL, Template, ActType, AcSubType) {

            ActTypeGroup.show();
            AcSubTypeGroup.show();
            BtnText.show();
            BtnPic.show();

            if (Template === 1 || Template === 3 || Template === 0) {
                console.log("ActType=="+ActType+"  AcSubType "+AcSubType);
                if (ActType == 3 && AcSubType == 0) {
                    var label = $('#edit_URLInputLabel');
                    label.text("自訂網址");
                    URL.show();
                    label.show();
                }
                else if ((ActType == 2 && AcSubType == 10) || (ActType == 2 && AcSubType == 11)) {
                    var label = $('#edit_URLInputLabel');
                    label.text("活動Id");
                    URL.show();
                    label.show();                    
                }
                else if (ActType == 5) {
                    var label = $('#edit_URLInputLabel');
                    label.text("活動Id");
                    URL.show();
                    label.show();  
                }
                else {
                    label.hide();
                    URL.hide();
                }
            }

            if (Template === 2 || Template === 4 || Template === 6) {
                ActTypeGroup.hide();
                AcSubTypeGroup.hide();
                BtnText.hide();
                if ((ActType == 3 && AcSubType == 0) || (ActType == 2 && AcSubType == 10) || (ActType == 2 && AcSubType == 11)) {
                     URL.hide();
                }
            }
            
            if (Template === 5 || Template === 6) {
                BtnPic.hide();
            }

        }

        function subTypeSelectChange(URLInputLabel, URLInput, MainType, SubType) {
            URLInputLabel.hide();
            URLInput.hide();
            console.log("MainType : " + MainType);
            console.log("SubType : " + SubType);
            if (MainType == 3 && SubType == 0) {//訂定URL
                URLInputLabel.show();
                URLInput.show();
            }            
            else if (MainType == 2 && SubType == 10) { //包月
                URLInputLabel.text("活動Id");
                URLInputLabel.show();
                URLInput.show();
            }
            else if (MainType == 2 && SubType == 11) {//扭蛋
                URLInputLabel.text("活動Id");
                URLInputLabel.show();
                URLInput.show();
            }
        }

        $(document).on('change', '#pictureFile', function(event) {
            var thisValue = this;
            getImageSize(this, function(width, height){ 
                console.log(width, height);
                var overDimension = width > 2048 || height > 2048;
                var overLimit = sizeLimit(thisValue);
                var allowType = fileTypeChecker(thisValue);
                if (!overLimit || !allowType || overDimension) {
                    $(this).val('');
                    var msg = (!overLimit ? "Size Over Limit \n" : "") + (!allowType ? "File Type Error" : "") + (overDimension ? "圖片尺寸過大" : "");
                    alert(msg);
                    $('#SendPicture').prop('disabled', true);
                } else {
                    $('#SendPicture').prop('disabled', false);
                }
                imagePreview(thisValue, $('#picturePreview'));
            });
        });

        function eachOrder() {
            var checkStatus = false;
            var item = $('#gallery-sortable > li');
            var postData = [];
            $(item).each(function(index, el) { //reverse -> 應應 SQL ORDER BY DESC
                postData.push({ 'Id': $(this).attr('data-pid'), 'Order': index });
            });
            OutputMsg(postData);
            // LoadingEff(true);
            $.ajax({
                url: '/BulletinKanbanOrder',
                type: 'POST',
                data: JSON.stringify({ data: postData }),
                cache: false,
                async: true,
                contentType: 'application/json',
                processData: false,
                // dataType: 'json',
                success: function(data) {
                    checkStatus = true;
                }
            }).always(function() {
                if (!checkStatus) {
                    alert('更新順序發生錯誤');
                } else {
                    alert('更新順序成功');
                    //getItemLocations();
                    //getItemAudience();
                    getAllItemData();
                }
            });
        }

        function insertItemCheck() {
            if (checkIsNullOrEmpty($('#Title').val()))
                return "請輸入標題!!";

            if (checkIsNullOrEmpty($('#Type').val()) || $('#Type').val() == 0)
                return "請選擇類型!!";

            if (checkIsNullOrEmpty($('#Template').val()) || $('#Template').val() == 0)
                return "請選擇版型!!";
            
            if (checkIsNullOrEmpty($('#BulletinContent').val()))
                return "請輸入公告內容!!";
            
            var template = parseInt($('#Template').val());

            if (template === 1 || template === 3 || template === 5) {
                
                if (checkIsNullOrEmpty($('#ButtonText').val()))
                    return "請輸入連結按鈕!!";

                if (checkIsNullOrEmpty($('#MainTypeSelect').val()))
                    return "請選擇連結類型!!";

                if (checkIsNullOrEmpty($('#SubTypeSelect').val()) && $('#SubTypeSelect').is(":visible"))
                    return "請選擇連結子類型!!";
            }
                      
            return "";
        }

        function modifyItemCheck() {
            if (checkIsNullOrEmpty($('#edit_Title').val()))
                return "請輸入標題!!";

            if (checkIsNullOrEmpty($('#edit_Type').val()) || $('#edit_Type').val() == 0)
                return "請選擇類型!!";

            if (checkIsNullOrEmpty($('#edit_Template').val()) || $('#edit_Template').val() == 0)
                return "請選擇版型!!";
            
            if (checkIsNullOrEmpty($('#edit_BulletinContent').val()))
                return "請輸入公告內容!!";
            
            var template = parseInt($('#edit_Template').val());

            if (template === 1 || template === 3 || template === 5) {
                
                if (checkIsNullOrEmpty($('#edit_ButtonText').val()))
                    return "請輸入連結按鈕!!";

                if (checkIsNullOrEmpty($('#edit_MainTypeSelect').val()))
                    return "請選擇連結類型!!";

                if (checkIsNullOrEmpty($('#edit_SubTypeSelect').val()) && $('#edit_SubTypeSelect').is(":visible"))
                    return "請選擇連結子類型!!";
            }

            return "";
        }

        function checkIsNullOrEmpty(obj) {
             if (obj == 'undefined' || obj == null  || obj == '')
                return true;
            return false;
        }

        function InsertItem() {
            var checkStatus = false;
            var requestData = {r : true};

            var checkDataStr = insertItemCheck();
            if (checkDataStr != "") {
                alert(checkDataStr);
                return;
            }
            
            var pic = $('#sub-gallery-sortable input.pictureSelected:checked').val();

            if (!checkIsNullOrEmpty(pic))
                pic = CDN_Domain+pic;
            else 
                pic = "";
                
            requestData.Title = $('#Title').val();
            requestData.Type = $('#Type').val();
            requestData.BulletinContent = $('#BulletinContent').val();
            requestData.Template = $('#Template').val();

            requestData.StartTime =  $('#ActiveTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.EndTime = $('#ActiveTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.BulletinPic = pic;
            requestData.TagType = $('#TagType').val();
            requestData.TagTimeStart = $('#TagTime').data('daterangepicker').startDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.TagTimeEnd = $('#TagTime').data('daterangepicker').endDate.format('YYYY-MM-DD HH:mm:ss');
            requestData.BtnText = $('#ButtonText').val();
            requestData.Description = $('#Description').val();

            var MainType =  $('#MainTypeSelect').val() ;
            var SubType = $('#SubTypeSelect').val();
 
            Command = getSettingCommand(parseInt(MainType), SubType, $('#URLInput'));
                 if (Command == "Error")
                    return;

            requestData.MainTypeSelect = MainType;
            requestData.SubTypeSelect = SubType;
            requestData.Command = Command;
             
            console.log("Command : " + requestData.Command);
            console.log("TagaTimeEnd : " + requestData.TagaTimeEnd);

            LoadingEff(true);
            $.ajax({
                url: '/AddBulletinKanban',
                type: 'POST',
                data: { SendData: JSON.stringify(requestData) },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    checkStatus = true;
                }
            }).always(function() {
                if (!checkStatus) {
                    alert('新增失敗');
                } else {
                    alert('新增成功');
                    //getAllItemData();
                    location.reload(); 
                }
                LoadingEff(false);
            });
        }

        function GetBulletinKanbanTemplate(obj, cb = null) {
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/GetBulletinKanbanTemplate",
                data: {},
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        ImpoliteTypeGroup = msg.data;
                      
                        msg.data.forEach(function(value) {
                            
                            obj.append('<option  value="'+value.id+'">'+value.name+' </option>');     
                                                                         
                        });

                        if (cb !== null)
                            cb();
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }


        function getSettingCommand(MainType, SubType, URLInput) {
            console.log("MainType : " + MainType);
            console.log("SubType : " + SubType);
            switch (MainType) {
                case 0:
                    return SubType;

                case 1:
                     return SubType;

                case 2:
                    if (PageInfoList[SubType].Settings) {
                        var selectSettings = JSON.parse(PageInfoList[SubType].Settings);
                        var command = selectSettings['Command'];
                        if (SubType == 10 || SubType == 11) {
                            command += URLInput.val();
                        }
                        return command;
                    }
                    break;

                case 3:
                    if (URLInfoList[SubType].Settings) {
                        var selectSettings = JSON.parse(URLInfoList[SubType].Settings);
                        return 'webService/openwebview/' + selectSettings['Command'];
                    } else if (URLInput.is(":visible")) {
                        if (URLInput.val() == '') {
                            alert("請輸入網址!!!");
                            return "Error";
                        }
                        return 'webService/openwebview/' + URLInput.val();
                    }
                    break;
                
                case 4:
                    return "";
                    break;

                case 5:
                    if (URLInput.is(":visible")) {
                        if (URLInput.val() == '') {
                            alert("請輸入活動Id!!!");
                            return "Error";
                        }
                        return 'LobbyService/openview/ad/' + URLInput.val();
                    }
                    break;
            }
            return "Error";
        }

        var getTemplate = $('#gallery-sortable').html();
        function getAllItemData() {

            $.ajax({
                url: '/BulletinKanbanGetAllItemData',
                type: 'POST',
                cache: false,
                async: true,
                processData: false,
                contentType: false,
                success: function(data) {
                    allItemInfo = data.data;
                    $('#gallery-sortable').html('');
                    $.each(data.data, function(index, value) {
                        $('#gallery-sortable').append(getTemplate);
                      
                        var type = "null";
                        var subType = "null";
                        var target = $('#gallery-sortable > li').last();
                        
                        console.log(value);
                     
                        target.attr('data-pid', value.Id);
                        target.find('img').attr('src', value.BulletinPic);
                        //target.find('h3').text(value.Order == null ? "null" : value.Order);
                        target.find('h3').text(value.Title);
                        target.find('.edit-adwindow-content').text("敘述 : " + value.Description);
                       // target.find('.edit-adwindow-audience').text("受眾 : " + (audienceId == 0 ? "無特定" : AudienceList[audienceId].AudienceName));
                       if (value.Template === 1 || value.Template === 3 || value.Template === 5) {
                         target.find('.edit-adwindow-type').text("類型 : " + getMainTypeName(value.AcType));
                         target.find('.edit-adwindow-subtype').text("子類型 : " + getSubTypeName(value.AcType, value.AcSubType, value));
                       }
                       else {
                            target.find('.edit-adwindow-type').text("類型 : " );
                            target.find('.edit-adwindow-subtype').text("子類型 : ");
                       }

                       
                        target.find('.edit-adwindow-start-time > span').text('開始時間 ' + moment(value.TimeStart).format("YYYY-MM-DD HH:mm:ss"));
                        target.find('.edit-adwindow-end-time > span').text('結束時間 ' + moment(value.TimeEnd).format("YYYY-MM-DD HH:mm:ss"));
                        target.find('.btn-group > a.item-enabled > span').html(value.Del == 'Y' ? '顯示' : '隱藏');
                        target.find('.btn-group > a.item-edit').attr('data-pid', value.BulletinPic);
                        target.find('.btn-group > a.item-enabled > i').addClass(value.Del == 'Y' ? 'fa-eye' : 'fa-eye-slash');
                        target.find('img').css('opacity', value.Del == 'N' ? '1' : '.3');
                        target.attr('data-enabled', value.Del == 'Y' ? '1' : '0');
                        target.attr('data-enabled', value.Del);
                    });
                    $('[data-toggle="tooltip"]').tooltip();                   
                }
            });
        }
        
        function getMainTypeName(mainType) {
            if (mainType == "null")
                return "null";
            return MainTypeList[mainType].Name;
        }

        function getSubTypeName(mainType, subType, value) {

            if (parseInt(mainType) == 4) {
                return "";
            }

            if (parseInt(mainType) == 5) {
                command = value.Command != null ? value.Command : "";
                return /[^/]*$/.exec(command)[0];
            }

            if (mainType == "null" || subType == "null")
                return "null";

            switch (parseInt(mainType)) {
                case 0:
                    return GamesInfoTypeAList[subType];

                case 1:
                    return GamesInfoTypeBList[subType];
                    
                case 2:
                    return PageInfoList[subType].Name;

                case 3:
                    return URLInfoList[subType].Name;
            }
        }

        function LoadingEff(effon) {
            if ($('#loading-cover').length < 1) {
                var html = '<div id="loading-cover">' +
                    '<div id="loading-icon">' +
                    '<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>'
                '</div>' +
                '</div>';
                $('body').append(html);
                $('#loading-cover').css({
                    'width': '100%',
                    'height': '100%',
                    'background': 'rgba(0,0,0,.5)',
                    'position': 'fixed',
                    'display': 'none',
                    'z-index': '999999',
                    'top': '0',
                    'left': '0'
                });
                $('#loading-icon').css({
                    'width': '85px',
                    'height': '65px',
                    'margin': '-42.5px 0 0 -32.5px',
                    'top': '50%',
                    'left': '50%',
                    'position': 'fixed'
                });
            }
            if (effon) {
                $('#loading-cover').fadeIn(100);
            } else {
                $('#loading-cover').fadeOut(100);
            }
        }

        function getGalleryData(type, order = 'DESC', selectedPic = null) {

            if (Object.keys(LangList) <= 0) {
                alert('載入語言選單發生問題');
                getLangList();
            }
            $.ajax({
                url: '/GetPictures',
                type: 'POST',
                data: { type: type, order: order },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(data) {
                    $.each(data.data, function(index, value) {
                        allImageInfo[value.pid] = value;
                    });
                    var html = '<li class="pull-left ui-disabled well" style="margin-top: 6px; height: 165px;">' +
                        '<div class="form-group">' +
                        '<div class="pinSize">' +
                        '<img src="#" alt="圖片上傳預覽，檔案大小必須為800KB以內，且為jpg格式。" id="picturePreview" class="img-responsive">' +
                        '</div>' +
                        '<label for="pictureFile">於項目內新增相片</label>' +
                        '<input type="file" id="pictureFile" name="pictureFile" style="width:60px; font-size:12px;" class="pull-left" accept="image/jpeg" data-max-filesize="800" />' +
                        // '<p class="help-block">檔案大小必須為800KB以內，且為jpg格式。</p>' +
                        '<button type="button" id="SendPicture" class="btn btn-xs btn-primary pull-right" disabled><i class="fa fa-upload" aria-hidden="true"></i></button>' +
                        '</div>' +
                        '</li>';
                    $('#sub-gallery-sortable').html(html);
                    $.each(data.data, function(index, value) {                        
                        var imageSrc = CDN_Domain+value.Picture;
                        var html =
                            '<li class="pull-left" data-pid="' + value.pid + '">' +
                            '<div class="thumbnail">' +
                            '<div class="edit-over-item hide">' +
                            '<div class="form-group form-group-sm">' +
                            '<input type="text" class="form-control item-annotation" value="' + value.Annotation + '" />' +
                            '</div>' +
                            '<div class="form-group form-group-sm">' +
                            LangOption +
                            '</div>' +
                            '<div class="form-group form-group-sm">' +
                            '<div class="btn-group btn-group-xs btn-group-justified">' +
                            '<a href="javascript:;" class="btn btn-primary edit-picture-send"><i class="fa fa-check-circle" aria-hidden="true"></i> 確定</a>' +
                            '<a href="javascript:;" class="btn btn-default edit-picture-cancel"><i class="fa fa-undo" aria-hidden="true"></i> 取消</a>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '<div class="pinSize">' +
                            '<div class="over-img-block">' +
                            '<span class="label label-default">' + LangList[value.Lang] + '</span>' +
                            '<div class="pull-right">' +
                            '<input class="pictureSelected" type="radio" name="pictureSelected" id="pictureSelected_' + value.pid + '" value="' + value.Picture + '" data-pid="' + value.pid + '" ' + (imageSrc == selectedPic ? 'checked' : '') + '>' +
                            '</div>' +
                            '</div>' +
                            '<img src="' + imageSrc + '" alt="" class="img-responsive">' +
                            '</div>' +
                            '<div class="caption">' +
                            '<p>' + value.Annotation + '</p>' +
                            '<div class="btn-group btn-group-xs btn-group-justified">' +
                            '<a href="javascript:;" class="edit-picture btn btn-success"><i class="fa fa-pencil" aria-hidden="true"></i> 編輯</a>' +
                            '<a href="javascript:;" data-pid="' + value.pid + '" class="picture-del btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> 刪除</a>' +
                            '</div>' +
                            '</div>' +
                            '</div>' +
                            '</li>'; 
                        $('#sub-gallery-sortable').append(html);
                        var optionSelect = $('#sub-gallery-sortable li[data-pid="' + value.pid + '"] .over-img-block > div.form-group > select > option');
                        $.each(optionSelect, function(index, element) {
                            $(element).prop('selected', $(element).attr('value') == value.Lang ? true : false);
                        });
                    });
                    pictureSelected();
                    $("#sub-gallery-sortable").sortable({
                        cursor: "move",
                        delay: 300,
                        tolerance: "pointer",
                        cancel: "input, select",
                        items: "li:not(.ui-disabled)",
                        placeholder: "pull-left",
                        classes: {
                            "ui-sortable-placeholder": "ui-state-highlight"
                        }
                    });
                    $("#sub-gallery-sortable").disableSelection();
                }
            });
        }

        function pictureSelected() {
            $.each($('#sub-gallery-sortable > li[data-pid]'), function(index, element) {
                $(element).removeClass('selected');
                if ($(element).find('input.pictureSelected').prop('checked')) {
                    $(element).addClass('selected');
                }
            });
            // $(this).parents('#sub-gallery-sortable > li[data-pid]').addClass('selected');
            if ($('#sub-gallery-sortable input.pictureSelected:checked').val() != null) {
                $('#insertPicture').prop('disabled', false);
            }
        }

        function ShowModalBox(Title, Content, footer) {
            $('#bs-modal-box').remove();
            var html =
                '<div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '<h4 class="modal-title"></h4>' +
                '</div>' +
                '<div class="modal-body" style="display:flow-root">' +
                '<p></p>' +
                '</div>' +
                (footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
                '</div>' +
                '</div>' +
                '</div>';
            $('body').append(html);
            $('#bs-modal-box h4.modal-title').html(Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show')
        }

        function SendPicture() {
            var data = new FormData();
            var pid = $('#sub-gallery-sortable input.pictureSelected:checked').attr('data-pid');
            
            
            var files = $("#pictureFile").get(0).files;
            if (files.length > 0) {
                data.append("uploadImage", files[0]);
            };
            data.append('type', Type);
            

            LoadingEff(true);
            $.ajax({
                url: '/SendPicture',
                type: 'POST',
                data: data,
                cache: false,
                async: true,
                processData: false,
                contentType: false,
                success: function(data) {
                    console.log("pid : " + data);
                    getGalleryData(Type, 'ASC', pid);
                }
            }).always(function() {
                LoadingEff(false);
            });
        }

        function pictureDel() {
            var confirmData = confirm("確定要刪除？");
            var checkStatus = false;

            if (confirmData) {
                var pid = $(this).attr('data-pid');
                var _element = $(this).parents('li.ui-sortable-handle');
                $.ajax({
                    url: '/DelPicture',
                    type: 'POST',
                    data: { pid: pid },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(data) {
                        _element.remove();
                        checkStatus = true;
                    }
                }).always(function() {
                    if (!checkStatus)
                        alert('發生錯誤');
                });
            }
        }

        function pictureEdit(targetForm, targetOther){
            if(targetForm.hasClass('hide')){
                targetForm.removeClass('hide');
                targetOther.addClass('blur');
            } else {
                targetForm.addClass('hide');
                targetOther.removeClass('blur');
            }
        }
       
        function pictureEditOpen(){
            targetForm = $(this).parents('.thumbnail').find('.edit-over-item');
            targetOther = $(this).parents('.thumbnail').find('.pinSize, .caption');
            pictureEdit(targetForm, targetOther);
        }

        function itemEditHide(selectNum){
            targetForm = $('#sub-gallery-sortable > li > .thumbnail').eq(selectNum).find('.edit-over-item');
            targetOther = $('#sub-gallery-sortable > li > .thumbnail').eq(selectNum).find('.pinSize, .caption');
            pictureEdit(targetForm, targetOther);
        }

        function editPictureSend(){
            var pid = $(this).parents('li[data-pid]').attr('data-pid');
            var annotation = $(this).parents('div.edit-over-item').find('.item-annotation').val();
            var lang = $(this).parents('div.edit-over-item').find('.item-lang').val();
            var thisEq = $(this).parents('li[data-pid]').prevAll().not('.ui-disabled').length;

            if($(this).hasClass('edit-picture-send')){
                var checkStatus = false;

                $.ajax({
                    url: '/EditPicture',
                    type: 'POST',
                    data: { pid: pid, annotation: annotation, lang: lang },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(data) {
                        checkStatus = true;
                    }
                }).always(function() {
                    if (!checkStatus){
                        alert('發生錯誤');
                    }
                    itemEditHide(thisEq);
                    getGalleryData(Type, 'ASC');
                });
            } else {
                itemEditHide(thisEq);
            }
        }
        
        function sendPictureOrder() {
            var checkStatus = false;
            var item = $('#sub-gallery-sortable > li').not('.ui-disabled');
            var postData = [];
            $(item).each(function(index, el) { //.get().reverse() -> 應應 SQL ORDER BY DESC
                postData.push({ 'pid': $(this).attr('data-pid'), 'no': index });
            });
            $.ajax({
                url: '/OrderPicture',
                type: 'POST',
                data: JSON.stringify({ data: postData }),
                cache: false,
                async: true,
                contentType: 'application/json',
                processData: false,
                success: function(data) {
                    checkStatus = true;
                }
            }).always(function() {
                if (!checkStatus) {
                    alert('更新順序發生錯誤');
                } else {
                    alert('更新順序成功');
                    getGalleryData(Type, 'ASC');
                }
            });
        }

        function insertPicture(){
            var insertPictureData = $('#sub-gallery-sortable input.pictureSelected:checked').val();
            var pid = $('#sub-gallery-sortable input.pictureSelected:checked').attr('data-pid');
            // var pid = $('#sub-gallery-sortable input.pictureSelected:checked img').attr('src');

            if(insertPictureData != null){
                //$('#pictureData').val(Type + '/' + insertPictureData);
                var imageSrc = CDN_Domain + insertPictureData;
                $('#pictureData').val(insertPictureData);
                $('#SelectedPicturePreview').attr('src', imageSrc);
                $('#SelectedPicturePreview').removeClass('hidden');
                $('#bs-modal-box').modal('hide');
            } else {
                alert('沒有任何選項被選擇，請選擇圖片！');
                $('#SelectedPicturePreview').addClass('hidden');
            }             
        }

        function cancelSelectedPicture(){
            var confirmAlert = confirm("確定取消選取的圖片？");
            if(confirmAlert){
                $('#pictureData').val('');
                $('#SelectedPicturePreview').attr('src', '#');
                $('#SelectedPicturePreview').addClass('hidden');
            } else {}
        }

        function selectPictureWindow() {
            html = '<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">' +
                '<ul id="sub-gallery-sortable" class="list-unstyled row ui-sortable">' +
                '</ul>' +
                '</div>';

            footer = '<div class="btn-group btn-group-lg" style="margin-right: 10px;">' +
                '<button id="insertPicture" type="button" class="btn btn-primary" disabled><i class="fa fa-picture-o" aria-hidden="true"></i> 確定選取</button>' +
                '<button id="sendPictureOrder" type="button" class="btn btn-info"><i class="fa fa-sort-amount-desc" aria-hidden="true"></i> 儲存順序</button>' +
                '</div>' +
                '<button type="button" class="btn btn-danger btn-lg" data-dismiss="modal"><i class="fa fa-undo" aria-hidden="true"></i> 取消</button>';

            ShowModalBox('Image Selector', html, footer);
            $('#bs-modal-box').on('shown.bs.modal', function(e) {
                getGalleryData(Type, 'ASC');
            });
        }

       /* var GroupData = {};

        function getmGroup() {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getmGroup",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var targetSelect = $('#mGroup');
                    targetSelect.prop('disabled', false);

                    msg.data.forEach(function(value) {
                        targetSelect.append('<option data-content="<div class=\'label label-success\'>' + value.count + ' 人</div> ' + value.AudienceName + '" value="' + value.Id + '">' + value.AudienceName + '</option>');
                        GroupData[value.Id] = value.AudienceName;
                    });
                    targetSelect.selectpicker('refresh');
                }
            })
        }
        getmGroup();
*/

        function EndTimeChecker(a, b){
            a = moment(a);
            b = moment(b);
            var diff = b.diff(a, 's');
            var baseCoin = $('#baseCoin').val();
            if(diff <= 1800 && baseCoin > 0){
                return true;
            } else {
                return false;
            }
        }
   
        $(document).on('change', '.pictureSelected', pictureSelected);

        $(document).on('click', '#selectPictureWindow', selectPictureWindow);

        $(document).on('click', '#SendPicture', SendPicture);

        $(document).on('click', '.picture-del', pictureDel);

        $(document).on('click', '.edit-picture', pictureEditOpen);

        $(document).on('click', '.edit-picture-send, .edit-picture-cancel', editPictureSend);

        $(document).on('click', '#sendPictureOrder', sendPictureOrder);

        $(document).on('click', '#insertPicture', insertPicture);

        $(document).on('click', '#cancelSelectedPicture', cancelSelectedPicture);

        function OutputMsg(msg) {
            console.log(msg);
        }

    });
    </script>
</body>

</html>