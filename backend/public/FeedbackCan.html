<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">

    <!-- bootstrap-datetimepicker -->
    <link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css" rel="stylesheet">
    <!-- Ion.RangeSlider -->
    <link href="../vendors/normalize-css/normalize.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.skinFlat.css" rel="stylesheet">
    <style>
        .dataTables_wrapper>.row {
            overflow: visible!important;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="clearfix"></div>
                <div class="row">
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>公版訊息設定</h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <toolbar>
                                    <button id="rowAdd" class="btn btn-primary">新增公版訊息</button>
                                    <br>
                                    <br>
                                </toolbar>
                                <table id="datatable" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Id</th>
                                            <th>對應問題類別</th>
                                            <th>公版訊息標題</th>
                                            <th>公版訊息內容</th>
                                            <th>功能</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- Ion.RangeSlider -->
    <script src="../vendors/ion.rangeSlider/js/ion.rangeSlider.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-datetimepicker -->    
    <script src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- jquery.inputmask -->
    <script src="../vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
    <!-- jQuery Knob -->
    <script src="../vendors/jquery-knob/dist/jquery.knob.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>

    $(document).ready(function() {

        var currentRow;
        var feedbackType = [];
        var $_GET = {}; 
        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() { 
            function decode(s) { 
                return decodeURIComponent(s.split("+").join(" ")); 
            } 
            $_GET[decode(arguments[1])] = decode(arguments[2]); 
        });

        var table = $('#datatable').DataTable({
            destroy: true,
            "columnDefs": [
                {"targets": 0},
                {"targets": 1},
                {"targets": 2},
                {"targets": 3},
                {
                    "targets": 4,
                    "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                        "<button class='btn btn-info' id='modifyitem'><i class='fa fa-pencil-square-o' aria-hidden='true'></i> 修改</button>" +
                        "<button class='btn btn-danger' id='delitem'><i class='fa fa-pencil-square-o' aria-hidden='true'></i> 刪除</button>" +
                        "</div>"
                }
            ]
        });

        //點選新增
        $("button#rowAdd").on('click', "", function(e) {
            ShowAddModal();
        });

        $('#datatable tbody').on('click', 'button', function(e) {
            var data = table.row($(this).parents('tr')).data();
            var jsonData = {};
            currentRow = $(this).closest("tr");
            switch ($(this).attr('id')) {
                case "modifyitem":
                    var tempForm = new Object();
                    tempForm.id = currentRow.find("td:eq(0)").text();
                    tempForm.type = getFeedbackTypeIdByName(currentRow.find("td:eq(1)").text());
                    tempForm.title = currentRow.find("td:eq(2)").text();
                    tempForm.content = currentRow.find("td:eq(3)").text()
                    ShowEditModal(tempForm);
                    break;

                case "delitem":
                    delitem(currentRow.find("td:eq(0)").text());
                    break;
            }
        });

        function getFeedbackTypeIdByName(typeName) {
            var id = 0;
            $.each( feedbackType, function( key, value ) {
                if (value.CommentTypeName == typeName) {
                    id = value.Id;
                    return true;
                }
            });
            return id;
        }

        function getFeedbackType() {
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/GetFeedbackType",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    feedbackType = msg.data;
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
                refresh();
            });
        }

        getFeedbackType();

        function refresh() {
            $('#loading-cover').fadeIn(100);
            table.clear().draw();
            var data = [];
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/GetFeedbackCan",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    msg.data.forEach(function(value) {
                        data.push([
                            value.Id,
                            feedbackType[value.Type - 1].CommentTypeName,
                            value.Title,
                            value.Content
                        ]);

                    });
                    table.rows.add(data).draw();
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function ShowAddModalBox(Title, Content) {
            if ($('#bs-modal-box').length < 1) {
                var html =
                    '<div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog">' +
                    '<div class="modal-dialog" role="document">' +
                    '<div class="modal-content">' +
                    '<div class="modal-header">' +
                    '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                    '<h4 class="modal-title"></h4>' +
                    '</div>' +
                    '<div class="modal-body" style="display:flow-root">' +
                    '<p></p>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                    '<button id="SendAddData" type="button" class="btn btn-success">確定</button>' +
                    '<button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
                $('body').append(html);
            }
            $('#bs-modal-box h4.modal-title').html('<span class="label label-default">公版訊息</span> ' + Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show');
        }

        function ShowEditModalBox(Title, Content) {
            if ($('#bs-modal-box').length < 1) {
                var html =
                    '<div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog">' +
                    '<div class="modal-dialog" role="document">' +
                    '<div class="modal-content">' +
                    '<div class="modal-header">' +
                    '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                    '<h4 class="modal-title"></h4>' +
                    '</div>' +
                    '<div class="modal-body" style="display:flow-root">' +
                    '<p></p>' +
                    '</div>' +
                    '<div class="modal-footer">' +
                    '<button id="SendEditData" type="button" class="btn btn-success">確定</button>' +
                    '<button type="button" class="btn btn-danger" data-dismiss="modal">取消</button>' +
                    '</div>' +
                    '</div>' +
                    '</div>' +
                    '</div>';
                $('body').append(html);
            }
            $('#bs-modal-box h4.modal-title').html('<span class="label label-default">公版訊息</span> ' + Title);
            $('#bs-modal-box div.modal-body').html(Content);
            $('#bs-modal-box').modal('show');
        }

        function ShowAddModal() {
            var html =
                '<div class="col-sm-12">' +
                '<div class="panel panel-default">' +
                '<div class="panel-heading"><i class="fa fa-eye" aria-hidden="true"></i> 新增公版訊息</div>' +
                '<div class="panel-body">' +
                '<div class="item form-group">' +
                '<label class="col-md-6 col-sm-6 col-xs-12">對應問題類別</label>' +
                '<select name="addType" id="addType" class="form-control">' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label">公版訊息標題</label>' +
                '<input name="addTitle" id="addTitle" class="form-control" type="text" value="">' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label">公版訊息內容</label>' +
                '<textarea name="addContent" id="addContent" class="form-control" maxlength="200" rows="5" style="resize: none;"></textarea>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            ShowAddModalBox("新增公版訊息", html);

            var mySelect = $('#addType');
            feedbackType.forEach(function(value) {
                mySelect.append(
                    $('<option></option>').val(value.Id).html(value.CommentTypeName)
                );
            });
        }

        function ShowEditModal(data) {
            console.log($('#datatable tbody tr').find('td:eq(0)').text().trim());
            var html =
                '<div class="col-sm-12">' +
                '<div class="panel panel-default">' +
                '<div class="panel-heading"><i class="fa fa-eye" aria-hidden="true"></i> 編輯公版訊息</div>' +
                '<div class="panel-body">' +
                '<div class="item form-group">' +
                '<label class="col-md-6 col-sm-6 col-xs-12">對應問題類別</label>' +
                '<select name="editType" id="editType" class="form-control">' +
                '</select>' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label">公版訊息標題</label>' +
                '<input name="editTitle" id="editTitle" class="form-control" type="text" value="' + data.title + '">' +
                '</div>' +
                '<div class="form-group">' +
                '<label class="control-label">公版訊息內容</label>' +
                '<textarea name="editContent" id="editContent" class="form-control" maxlength="200" rows="5" style="resize: none;">'+data.content+'</textarea>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>' +
                '</div>';
            ShowEditModalBox(data.title, html);

            var mySelect = $('#editType');
            feedbackType.forEach(function(value) {
                mySelect.append(
                    $('<option' + (value.Id == data.type ? " selected" : "") + '></option>').val(value.Id).html(value.CommentTypeName)
                );
            });
        }


        //處理新增
        function additem() {
            var addType = $('#addType').val();
            var addTitle = $('#addTitle').val();
            var addContent = $('#addContent').val();
            if (!addTitle || !addContent) {
                alert("請輸入內容!!");
                return;
            }

            var SendData = {
                Type : addType,
                Title : addTitle,
                Content: addContent
            };

            if (!confirm("確定新增嗎?"))
                return;

            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/FeedbackCanAdd",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        };

        //處理修改
        function modifyitem() {
            var editId = currentRow.find("td:eq(0)").text();
            var editType = $('#editType').val();
            var editTitle = $('#editTitle').val();
            var editContent = $('#editContent').val();
            if (!editTitle || !editContent) {
                alert("請輸入內容!!");
                return;
            }

            var SendData = {
                Id : editId,
                Type : editType,
                Title : editTitle,
                Content: editContent
            };

            if (!confirm("確定修改嗎?"))
                return;

            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/FeedbackCanModify",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        };

        //處理刪除
        function delitem(id) {
            var SendData = {
                Id : id
            };

            if (!confirm("確定刪除嗎?"))
                return;

            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/FeedbackCanDel",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        };

        $(document).on('click', '#SendEditData', modifyitem);
        $(document).on('click', '#SendAddData', additem);
    });
    
    </script>
</body>

</html>