<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-notify -->
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    #datatable tbody td {
        vertical-align: middle;
    }
    .alert h5{
        margin: 0 0 0 15px;
        font-size: 1.3em;
    }
    .alert i{
        margin-right: 5px;
    }
    .input-group-btn .btn{
        margin-right: 0;
    }
    .input-group{
        margin-bottom: 0;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>會員原始資訊</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">會員ID
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberIdO" class="date-picker form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">遊戲暱稱
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberNickNameO" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">真實姓名
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberNameO" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">電子郵件
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberEmailO" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">綁定門號
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberPhoneO" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">活躍度
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberActiveO" class="form-control" type="number" min="0" max="99" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">註冊國家
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberNation" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">註冊地區
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberAddress" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">帳戶餘額
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberBalance" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>會員新資訊</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">會員ID
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberIdN" class="date-picker form-control" type="text" readonly>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">遊戲暱稱
                                            </label>
                                            <div class="col-xs-10">
                                                <div class="input-group">
                                                    <input id="MemberNickNameN" class="form-control" type="text" maxlength="16">
                                                    <span class="input-group-btn">
                                                        <button id="MemberNickNameN_check" class="btn btn-info">遊戲暱稱檢查</button>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">真實姓名
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberNameN" class="form-control" type="text">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">Email 帳號
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberEmailN" class="form-control" type="text">
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">綁定門號
                                            </label>
                                            <div class="col-xs-10">
                                                <div class="input-group">
                                                    <input id="MemberPhoneN" class="form-control text-right" type="number" readonly>
                                                    <span class="input-group-btn">
                                                        <a href="" target="_blank" id="MemberPhoneNBtn" class="btn btn-success">門號修改</a>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">活躍度
                                            </label>
                                            <div class="col-xs-10">
                                                <input id="MemberActiveN" class="form-control" type="number" min="0" max="99">
                                            </div>
                                        </div>

                                        <div class="form-group">
                                            <label class="control-label col-xs-2">扣除餘額
                                            </label>
                                            <div class="col-xs-10">
                                                <div class="input-group">
                                                    <input id="MemberBalanceDecrease" class="form-control text-right" type="number" min="1" max="0">
                                                    <span class="input-group-btn">
                                                        <button id="MemberBalanceDecreaseBtn" class="btn btn-success">確定扣除餘額</button>
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">解除驗證碼鎖定
                                            </label>
                                            <div class="col-xs-10">
                                                <div class="btn-group btn-group-justified">
                                                    <div class="btn-group" role="group">
                                                        <button id="mUnlockTransactionVerifyCode" class="btn btn-success">解鎖贈禮驗證碼鎖定</button>
                                                    </div>
                                                    <div class="btn-group" role="group">
                                                        <button id="mUnlockBindPhoneVerifyCode" class="btn btn-success">解鎖綁定手機驗證碼鎖定</button>
                                                    </div>
                                                    <div class="btn-group" role="group">
                                                        <button id="mUnlockForgetPwdVerifyCode" class="btn btn-success">解鎖忘記密碼驗證碼鎖定</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="ln_solid"></div>
                                        <div class="form-group">
                                            <div class="btn-group btn-group-lg center-btn" style="display: flex; justify-content: center;">
                                                <button id="mClear" class="btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> 清除</button>
                                                <button id="mSuccess" class="btn btn-success"><i class="fa fa-pencil" aria-hidden="true"></i> 確認</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script>
    $(document).ready(function() {
        function QuickNotify(message, type) {
            var icon = "";
            switch (type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fa-times-circle';
                    break;
                default:
                    icon = 'fa-exclamation-triangle';
            }
            $.notify({
                message: '<h5><i class="fa ' + icon + '"></i> ' + message + '</h5>'
            }, {
                    type: type,
                    z_index: 20000,
                    delay: 6000,
                });
        }

        function isEmail(email) {
            var regex = /^([a-zA-Z0-9_\.\-\+])+\@(([a-zA-Z0-9\-])+\.)+([a-zA-Z0-9]{2,4})+$/;
            if (!regex.test(email)) {
                return false;
            } else {
                return true;
            }
        }

        getByteLength = function (str) {
            if (str == null) return 0;
            if (typeof str != "string") {
                str += "";
            }
            return str.replace(/[^\x00-\xff]/g, "01").length;
        }
       
        var $_GET = {};
        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
            function decode(s) {
                return decodeURIComponent(s.split("+").join(" "));
            }
            $_GET[decode(arguments[1])] = decode(arguments[2]);
        });

        GetMemberInfo($_GET["MemberId"]);

        function GetMemberInfo(memberid) {
            $('#loading-cover').fadeIn(100);
            var data = { "MemberId": memberid };

            $.ajax({
                type: 'POST',
                url: "/MemberView",
                data: data,
                dataType: 'json',
                success: function(result) {
                    console.log(result.msg[0]);
                    $('#MemberIdO').val(result.msg[0].MemberId);
                    $('#MemberIdN').val(result.msg[0].MemberId);
                    $('#MemberNickNameO').val(result.msg[0].NickName);
                    $('#MemberNameO').val(result.msg[0].Name);
                    $('#MemberEmailO').val(result.msg[0].Email);
                    $('#MemberPhoneO').val(result.msg[0].CellPhoneNum);
                    $('#MemberPhoneN').val(result.msg[0].CellPhoneNum);
                    $('#MemberActiveO').val(result.msg[0].ActiveValue);
                    $('#MemberNation').val(result.msg[0].Nation);
                    $('#MemberAddress').val(result.msg[0].Address);
                    $('#MemberBalance').val(result.msg[0].MemberBalance / 100);
                    $('#MemberPhoneNBtn').attr('href', `/ModifyPhoneNum?MemberId=${result.msg[0].MemberId}&NickName=${encodeURIComponent(result.msg[0].NickName)}&CellPhoneNum=${result.msg[0].CellPhoneNum}`);
                    if (result.msg[0].TransactionAuth == 1) {
                        $('#mUnlockTransactionVerifyCode').attr("disabled", "disabled");
                    } else {
                        $('#mUnlockTransactionVerifyCode').removeAttr("disabled");
                    }
                    if (result.msg[0].BindCellPhoneAuth == 1) {
                        $('#mUnlockBindPhoneVerifyCode').attr("disabled", "disabled");
                    } else {
                        $('#mUnlockBindPhoneVerifyCode').removeAttr("disabled");
                    }
                    if (result.msg[0].ForgetPasswordAuth == 1) {
                        $('#mUnlockForgetPwdVerifyCode').attr("disabled", "disabled");
                    } else {
                        $('#mUnlockForgetPwdVerifyCode').removeAttr("disabled");
                    }
                    $('#MemberBalanceDecrease').attr("max", result.msg[0].MemberBalance / 100);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function datacheck() {
            var NickName = $('#MemberNickNameN').val().replace(/\s+/g, "");
            var MemberName = $('#MemberNameN').val().replace(/\s+/g, "");
            var MemberEmail = $('#MemberEmailN').val().replace(/\s+/g, "");
            var MemberActive = $('#MemberActiveN').val().replace(/\s+/g, "");

            var result = { r: false };

            if (NickName !== "") {
                if(getByteLength(NickName) > 16){
                    result.r = false;
                } else {
                    result.r = true;
                }
                result.NickName = NickName;
            }
            if (MemberName !== "") {
                result.r = true;
                result.MemberName = MemberName;
            }
            if (MemberEmail !== "") {
                result.r = isEmail(MemberEmail);
                result.MemberEmail = MemberEmail;
            }
            if (MemberActive !== "") {
                result.r = true;
                result.MemberActive = MemberActive;
            }
            if (result.r) {
                result.MemberId = $_GET["MemberId"];
            }
            if (!result.r) { 
                QuickNotify('請確認所有已輸入的資料', 'warning');
            };
            return result;
        }

        function mSuccess() {
            if (confirm("確定要更新？")) {
                var data = datacheck();
                if (!data.r) {
                    return;
                }
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/MemberEdit",
                    data: data,
                    dataType: 'json',
                    success: function(result) {
                        QuickNotify(result.msg, result.code == '-1' ? 'danger' : 'success');
                        GetMemberInfo($_GET["MemberId"]);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                    $('#loading-cover').fadeOut(100);
                });
            }
        }

        function UnlockTransactionVerifyCodeLock() {
            if (confirm("確定要解鎖 贈禮 驗證碼鎖定？")) {
                var data = { MemberId:$_GET["MemberId"] };
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/MemberUnlockTransactionVerifyCodeRequest",
                    data: data,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                        alert(msg.msg);
                        GetMemberInfo($_GET["MemberId"]);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                });
            }
        }

        function UnlockBindPhoneVerifyCodeLock() {
            if (confirm("確定要解鎖 綁定手機 驗證碼鎖定？")) {
                var data = { MemberId:$_GET["MemberId"] };
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/MemberUnlockBindPhoneVerifyCodeRequest",
                    data: data,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                        alert(msg.msg);
                        GetMemberInfo($_GET["MemberId"]);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                });
            }
        }

        function UnlockForgetPwdVerifyCodeLock() {
            if (confirm("確定要解鎖 忘記密碼 驗證碼鎖定？")) {
                var data = { MemberId:$_GET["MemberId"] };
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/MemberUnlockChangePasswordVerifyCodeRequest",
                    data: data,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                        alert(msg.msg);
                        GetMemberInfo($_GET["MemberId"]);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                });
            }
        }
        function NickNameChecker() {
            $.ajax({
                type: 'POST',
                url: '/NickNameChecker',
                data: { nickName: $('#MemberNickNameN').val().replace(/\s+/g, "") },
                success: function (result) {
                    QuickNotify(result.msg, result.code == '-1' ? 'danger' : 'success');
                },
                error: function (xhr, desc, err) {
                    QuickNotify(`HTTP Status code: ${xhr.status}`, 'danger');
                }
            });
        }

        function MemberBalanceDecrease() {
            var costBalance = $('#MemberBalanceDecrease').val();
            if (costBalance <= 0 || costBalance.length <= 0) {
                alert("請輸入正確的數值!");
                return;
            }

            if (costBalance > $('#MemberBalance').val()) {
                alert("扣除金額必須低於帳戶餘額!");
                return;
            }
            
            if (confirm("確定要扣除餘額 " + costBalance + " ？")) {
                var data = { MemberId:$_GET["MemberId"], CostBalance:costBalance * 100 * -1 };
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/MemberCostBalance",
                    data: data,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                        alert(msg.msg);
                        GetMemberInfo($_GET["MemberId"]);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                });
            }
        }

        function clear(e) {
            e.preventDefault();
            $('#MemberNickNameN').val("");
            $('#MemberNameN').val("");
            $('#MemberEmailN').val("");
            $('#MemberActiveN').val("");
        }

        $(document).on('change keyup keydown focus click', 'input[type=number][min][max]', function (event) {
            var maxValue = Number($(this).attr('max'));
            var minValue = Number($(this).attr('min'));
            var getValue = Number($(this).val());
            
            if (maxValue != null) {
                if (getValue > maxValue) {
                    QuickNotify(`數值超出系統容許大小：${maxValue}。已自動將數值降至容許最大值。`, 'warning');
                    $(this).val(maxValue);
                }
            }
            if (minValue != null) {
                if (getValue < minValue) {
                    QuickNotify(`數值低於系統容許大小：${minValue}。已自動將數值降至容許最小值。`, 'warning');
                    $(this).val(minValue);
                }
            }
        });

        $(document).on('change keyup keydown keypress focus click', '#MemberNickNameN', function (event) {
            var nickNeme = $(this).val();
            if(nickNeme.match(/\s+/g)){
                nickNeme = nickNeme.replace(/\s+/g, "");
                $(this).val(nickNeme);
            }
            var byteLength = getByteLength(nickNeme);
            if(event){
            }
            if(byteLength > 16 && event.keyCode != 8 && event.keyCode != 46){
                event.preventDefault();
                var overText = substr_utf8_bytes(nickNeme, 0, 16);
                $(this).val(overText);
            }
        })

        function encode_utf8(s) {
            return unescape(encodeURIComponent(s));
        }
        function substr_utf8_bytes(str, startInBytes, lengthInBytes) {
            var resultStr = '';
            var startInChars = 0;
            for (bytePos = 0; bytePos < startInBytes; startInChars++) {
                ch = str.charCodeAt(startInChars);
                bytePos += (ch < 128) ? 1 : encode_utf8(str[startInChars]).length;
            }
            end = startInChars + lengthInBytes - 1;
            for (n = startInChars; startInChars <= end; n++) {
                ch = str.charCodeAt(n);
                end -= (ch < 128) ? 1 : encode_utf8(str[n]).length - 1;
                resultStr += str[n];
            }
            return resultStr;
        }
        $(document).on('click', '#mClear', clear);
        $(document).on('click', '#mSuccess', mSuccess);
        $(document).on('click', '#mUnlockTransactionVerifyCode', UnlockTransactionVerifyCodeLock);
        $(document).on('click', '#mUnlockBindPhoneVerifyCode', UnlockBindPhoneVerifyCodeLock);
        $(document).on('click', '#mUnlockForgetPwdVerifyCode', UnlockForgetPwdVerifyCodeLock);
        $(document).on('click', '#MemberBalanceDecreaseBtn', MemberBalanceDecrease);
        $(document).on('click', '#MemberNickNameN_check', NickNameChecker);
    });
    </script>
</body>

</html>