<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" rel="stylesheet"/>
    <!-- bootstrap-notify -->
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">       
        .alert h5 {
            margin: 0 0 0 15px;
            font-size: 1.3em;
        }
    
        .alert i {
            margin-right: 5px;
        }
        .btn-file {
            position: relative;
            overflow: hidden;
        }
        .btn-file input[type=file] {
            position: absolute;
            top: 0;
            right: 0;
            min-width: 100%;
            min-height: 100%;
            font-size: 100px;
            text-align: right;
            filter: alpha(opacity=0);
            opacity: 0;
            background: red;
            cursor: inherit;
            display: block;
        }
        input[readonly] {
            background-color: white !important;
            cursor: text !important;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">會員ID
                                            </label>
                                            <div class="col-md-9 col-sm-9 col-xs-12">
                                                <input id="MemberId" class="date-picker form-control col-md-7 col-xs-12" placeholder="" type="text" maxlength="13">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">遊戲暱稱
                                            </label>
                                            <div class="col-md-9 col-sm-9 col-xs-12">
                                                <input id="MemberNickName" class="form-control col-md-7 col-xs-12" placeholder="" type="text">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">VIP 等級</label>
                                            <div class="col-md-2 col-sm-2 col-xs-3">
                                                <select name="MemberVIPLV_filter" id="MemberVIPLV_filter" class="form-control" required="required">
                                                    <option class="text-center" value="0" selected>=</option>
                                                    <option class="text-center" value="1">&gt;</option>
                                                    <option class="text-center" value="2">&lt;</option>
                                                </select>
                                            </div>
                                            <div class="col-md-7 col-sm-7 col-xs-12">
                                                <select name="MemberVIPLV" id="MemberVIPLV" class="form-control"></select>
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">玩家等級
                                            </label>
                                            <div class="col-md-2 col-sm-2 col-xs-3">
                                                <select name="MemberLV_filter" id="MemberLV_filter" class="form-control" required="required">
                                                    <option class="text-center" value="0" selected>=</option>
                                                    <option class="text-center" value="1">&gt;</option>
                                                    <option class="text-center" value="2">&lt;</option>
                                                </select>
                                            </div>
                                            <div class="col-md-7 col-sm-7 col-xs-12">
                                                <input id="MemberLV" class="form-control" type="number" min="1" max="999">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">信箱
                                            </label>
                                            <div class="col-md-9 col-sm-9 col-xs-12">
                                                <input id="MemberEmail" class="form-control col-md-7 col-xs-12" placeholder="" type="text">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">年齡
                                            </label>
                                            <div class="col-md-2 col-sm-2 col-xs-3">
                                                <select name="MemberAge_filter" id="MemberAge_filter" class="form-control" required="required">
                                                    <option class="text-center" value="0" selected>=</option>
                                                    <option class="text-center" value="1">&gt;</option>
                                                    <option class="text-center" value="2">&lt;</option>
                                                </select>
                                            </div>
                                            <div class="col-md-7 col-sm-7 col-xs-12">
                                                <input id="MemberAge" class="form-control col-md-6 col-xs-12" placeholder="" type="number" min="1" max="120">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">身分證字號
                                            </label>
                                            <div class="col-md-9 col-sm-9 col-xs-12">
                                                <input id="MemberIdNumber" class="form-control col-md-6 col-xs-12" placeholder="" type="text">
                                            </div>
                                        </div>
                                        <div class="item form-group">
                                            <label class="control-label col-md-3 col-sm-3 col-xs-12">活躍度
                                            </label>
                                            <div class="col-md-2 col-sm-2 col-xs-3">
                                                <select name="MemberActive_filter" id="MemberActive_filter" class="form-control" required="required">
                                                    <option class="text-center" value="0" selected>=</option>
                                                    <option class="text-center" value="1">&gt;</option>
                                                    <option class="text-center" value="2">&lt;</option>
                                                </select>
                                            </div>
                                            <div class="col-md-7 col-sm-7 col-xs-12">
                                                <input id="MemberActive" class="form-control col-md-6 col-xs-12" type="number" min="0" max="99">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ln_solid"></div>
                                    <div class="form-group">
                                        <div class="col-md-6 col-md-offset-4">
                                            <button class="btn btn-danger">清除</button>
                                            <button class="btn btn-success">搜尋</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="item form-group">
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">真實姓名
                                                </label>
                                                <div class="col-md-9 col-sm-9 col-xs-12">
                                                    <input id="MemberName" class="form-control col-md-7 col-xs-12" placeholder="" type="text">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">註冊國家
                                                </label>
                                                <div class="col-md-9 col-sm-9 col-xs-12">
                                                    <input id="MemberNation" class="form-control" placeholder="" type="text">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">綁定門號
                                                </label>
                                                <div class="col-md-9 col-sm-9 col-xs-12">
                                                    <input id="MemberPhone" class="form-control col-md-7 col-xs-12" placeholder="" type="text">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">註冊時間
                                                </label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberRegistered_filter" id="MemberRegistered_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="date col-md-7 col-sm-7 col-xs-12">
                                                    <input type="text" name="MemberRegistered" id="MemberRegistered" class="form-control" value="">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">未上線天數
                                                </label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberOffline_filter" id="MemberOffline_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="date col-md-7 col-sm-7 col-xs-12">
                                                    <input type="number" name="MemberOffline" id="MemberOffline" class="form-control" value="">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">首次登入時間</label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberFirstLogin_filter" id="MemberFirstLogin_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="date col-md-7 col-sm-7 col-xs-12">
                                                    <input type="text" name="MemberFirstLogin" id="MemberFirstLogin" class="form-control" value="">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">現有錶底金額(credit)
                                                </label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberBalance_filter" id="MemberBalance_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-7 col-sm-7 col-xs-12">
                                                    <input id="MemberBalance" class="form-control col-md-7 col-xs-12" placeholder="" type="number">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">現有碎片總數
                                                </label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberChips_filter" id="MemberChips_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-7 col-sm-7 col-xs-12">
                                                    <input id="MemberChips" class="form-control col-md-9 col-xs-12" placeholder="" type="number">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">現有卡片數量
                                                </label>
                                                <div class="col-md-2 col-sm-2 col-xs-3">
                                                    <select name="MemberCards_filter" id="MemberCards_filter" class="form-control" required="required">
                                                        <option class="text-center" value="0" selected>=</option>
                                                        <option class="text-center" value="1">&gt;</option>
                                                        <option class="text-center" value="2">&lt;</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-7 col-sm-7 col-xs-12">
                                                    <input id="MemberCards" class="form-control col-md-9 col-xs-12" placeholder="" type="number">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-md-3 col-sm-3 col-xs-12">自定義群組
                                                </label>
                                                <div class="col-md-9 col-sm-9 col-xs-3">
                                                    <select name="GroupM" id="GroupM" class="form-control">
                                                        <option value="0" selected></option>
                                                    </select>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">
                                    <div class="form-group">
                                        <label class="control-label">群組名稱</label>
                                        <input id="AudienceName" class="form-control" placeholder="" maxlength="50" type="text">
                                    </div>
                                    <div class="form-group">
                                        <label class="control-label">群組敘述</label>
                                        <textarea id="AudienceDescription" class="form-control" placeholder="" rows="5" maxlength="200" style="resize: none;"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <button id="AudienceAdd" class="btn btn-danger">創建群組</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>Member List</h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <div class="form-group">
                                    <label class="control-label">自定義群組</label>
                                    <select name="MemberGroup" id="MemberGroup" class="form-control" required="required"></select>
                                </div>
                                <div class="form-group">
                                    <button id="rowAdd" class="btn btn-primary">加入群組</button>
                                </div>
                                <hr>
                                <div class="form-group col-md-1">
                                    <a class="btn btn-primary" href="./public/sampleFile/ImportTest.csv" download="ImportTest.csv">匯入範例檔下載</a>
                                </div>   
                                <div class="form-group col-md-3">
                                    <!-- <input type="file" id="importExcel" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, .csv"></input> -->
                                    <div class="input-group">
                                        <span class="input-group-btn">
                                            <span class="btn btn-primary btn-file">
                                                選擇檔案 <input type="file" id="importExcel" accept="application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, .csv" single>
                                            </span>
                                        </span>
                                        <input type="text" class="form-control" readonly>
                                    </div>
                                </div>                             
                                <hr>
                                <table id="datatable-checkbox" class="table table-striped table-bordered bulk_action">
                                    <thead>
                                        <tr>
                                            <th>
                                                <input type="checkbox" id="select-all" class="flat">
                                            </th>
                                            <th>會員ID</th>
                                            <th>遊戲暱稱</th>
                                            <th>VIP 等級</th>
                                            <th>玩家等級</th>
                                            <th>活躍度</th>
                                            <th>信箱</th>
                                            <th>真實姓名</th>
                                            <th>註冊國家</th>
                                            <th>綁定門號</th>
                                            <th>註冊時間</th>
                                            <th>未上線天數</th>
                                            <th>年齡</th>
                                            <th>身分證字號</th>
                                            <th>首次登入時間</th>
                                            <th>現有錶底金額(credit)</th>
                                            <th>現有碎片總數</th>
                                            <th>現有卡片數量</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>

    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- bootstrap-datetimepicker -->
    <script src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../vendors/xlsx/dist/xlsx.full.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <script>
    $(document).ready(function() {
        $('.btn-file :file').on('fileselect', function(event, numFiles, label) {        
            var input = $(this).parents('.input-group').find(':text'),
                log = numFiles > 1 ? numFiles + ' files selected' : label;
            
            if( input.length ) {
                input.val(log);
            } else {
                if( log ) alert(log);
            }
            
        });

        $(document).on('change', '.btn-file :file', function() {
            var input = $(this),
                numFiles = input.get(0).files ? input.get(0).files.length : 1,
                label = input.val().replace(/\\/g, '/').replace(/.*\//, '');
            input.trigger('fileselect', [numFiles, label]);


            console.log(table.length);
            var files = input.get(0).files;

            var fileReader = new FileReader();
            fileReader.onload = function(ev) {
                try {
                    var data = ev.target.result,
                        workbook = XLSX.read(data, {
                            type: 'binary'
                        }), // 以二进制流方式读取得到整份excel表格对象
                        member = []; // 存储获取到的数据
                } catch (e) {
                    console.log('文件類型不正確');
                    return;
                }

                // 表格的表格范围，可用于判断表头是否数量是否正确
                var fromTo = '';
                // 遍历每张表读取
                for (var sheet in workbook.Sheets) {
                    if (workbook.Sheets.hasOwnProperty(sheet)) {
                        fromTo = workbook.Sheets[sheet]['!ref'];
                        console.log(fromTo);
                        member = member.concat(XLSX.utils.sheet_to_json(workbook.Sheets[sheet]));
                        // break; // 如果只取第一张表，就取消注释这行
                    }
                }
                console.log(table.length);
                importMember(member);
                //$('#importExcel').val('');
            };

            // 以二进制方式打开文件
            fileReader.readAsBinaryString(files[0]);
        });

        function QuickNotify(message, type) {
            var icon = "";
            switch (type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fa-times-circle';
                    break;
                default:
                    icon = 'fa-exclamation-triangle';
            }
            $.notify({
                message: '<h5><i class="fa ' + icon + '"></i> ' + message + '</h5>'
            }, {
                    type: type,
                    z_index: 20000,
                    delay: 6000,
                });
        }

        var $_GET = {};
        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
            function decode(s) {
                return decodeURIComponent(s.split("+").join(" "));
            }
            $_GET[decode(arguments[1])] = decode(arguments[2]);
        });

        $('#MemberBalance_filter, #MemberRegistered_filter, #MemberOffline_filter, #MemberFirstLogin_filter, #MemberActive_filter, #MemberAge_filter, #MemberLV_filter, #MemberVIPLV_filter, #GroupM, #MemberGroup, #MemberChips_filter, #MemberCards_filter').selectpicker({
            showTick: true
        });
        $('#MemberRegistered').datetimepicker({ format: 'YYYY-MM-DD' });
        $('#MemberFirstLogin').datetimepicker({ format: 'YYYY-MM-DD' });

        GetVIPLvSetting();
        var VIPData = [];

        function GetVIPLvSetting() {
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/GetVIPLvSetting",
                data: {},
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var mySelect = $('#MemberVIPLV');
                    var s = '<option value="0">全部</option>';
                    msg.data.forEach(function(value) {
                        s += '<option value="' + value.VIPLvId + '">' + value.VIPLvName + '</option>';
                        VIPData[value.VIPLvId] = value.VIPLvName;
                    });
                    mySelect.append(s);
                    mySelect.selectpicker('refresh');
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }


        GetMemberGroupList();
        var MemberGroupData = {};
        function GetMemberGroupList(e) {
            $('#MemberGroup option').remove();
            $('#GroupM option').remove();
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/GetMemberGroupList",
                data: {},
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        $.each(msg.data, function(index, value) {
                            MemberGroupData[value.AudienceName] = value;
                        });
                        $("#GroupM").append(`<option value="0" selected></option>`);
                        msg.data.forEach(function(value) {
                            $('#MemberGroup, #GroupM').append(`<option value="${value.Id}">${value.AudienceName}</option>`);
                        });

                        console.log("$_GET[MemberGroupId] : " + $_GET["MemberGroupId"]);
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
                if ($_GET["MemberGroupId"] != undefined) {
                    $('#MemberGroup').val($_GET["MemberGroupId"]);
                    $('html,body').animate({scrollTop:$('#MemberGroup').offset().top},400);
                }
                $('#MemberGroup, #GroupM').selectpicker('refresh');
            });
        }

        var selectid = [];
        var table = $('#datatable-checkbox').DataTable({
            'order': [
                [1, 'asc']
            ],
            "lengthMenu": [
                [30, 50, 100, -1],
                [30, 50, 100, "∞"]
            ],
            'columnDefs': [{
                orderable: false,
                targets: [0]
            }],
            'rowCallback': function(row, data, dataIndex) {
                var rowId = data[1];
                if ($.inArray(rowId, selectid) !== -1) {
                    $(row).iCheck('check');
                }
            }
        });

        $('#datatable-checkbox').on('draw.dt', function() {
            $('input.flat').iCheck({
                checkboxClass: 'icheckbox_flat-green'
            });
        });

        $('input.flat').iCheck({
            checkboxClass: 'icheckbox_flat-green'
        });

        var checked = false;
        $(document).on('ifChanged', "input[type='checkbox']#select-all", function(event) {
            var r = table.rows({ filter: 'applied' }).data();
            if (!checked) {
                checked = true;
                for (i = 0; i < r.length; i++) {
                    selectid.push(r[i][1]);
                    $(table.row(i)).iCheck('check');
                };
            } else {
                checked = false;
                selectid = [];
                for (i = 0; i < r.length; i++) {
                    $(table.row(i)).iCheck('uncheck');
                };
            }
        });

        function selectAll() {
            var r = table.rows({ filter: 'applied' }).data();
            if (this.checked) {
                for (i = 0; i < r.length; i++) {
                    selectid.push(r[i][1]);
                    $(table.row(i)).iCheck('check');
                };
            } else {
                selectid = [];
                for (i = 0; i < r.length; i++) {
                    $(table.row(i)).iCheck('uncheck');
                };
            }
        }

        $(document).on('ifChanged', "input[type='checkbox']#check-all", function(event) {
            var $row = $(this).closest('tr');
            var data = table.row($row).data();
            var rowId = data[1];
            var index = $.inArray(rowId, selectid);
            if (this.checked && index === -1) {
                selectid.push(rowId);
            } else if (!this.checked && index !== -1) {
                selectid.splice(index, 1);
            }
            console.log("check-all");
        });

        function clear(e) {
            e.preventDefault();
            $('#MemberId').val("");
            $('#MemberNickName').val("");
            $('#MemberVIPLV_filter').val(0);
            $('#MemberVIPLV_filter').selectpicker('refresh');
            $('#MemberVIPLV').val(0);
            $('#MemberBalance_filter').val(0);
            $('#MemberBalance_filter').selectpicker('refresh');
            $('#MemberCards_filter').val(0);
            $('#MemberCards_filter').selectpicker('refresh');
            $('#MemberLV_filter').val(0);
            $('#MemberLV_filter').selectpicker('refresh');
            $('#MemberLV').val("");
            $('#MemberActive').val("");
            $('#MemberEmail').val("");
            $('#MemberName').val("");
            $('#MemberNation').val("");
            $('#MemberPhone').val("");
            $('#MemberAge').val("");
            $('#MemberIdNumber').val("");
            $('#MemberRegistered').val("");
            $('#MemberFirstLogin').val("");
            $('#MemberBalance_filter').val(0);
            $('#MemberBalance_filter').selectpicker('refresh');
            $('#MemberBalance').val("");
            $('#MemberChips_filter').val(0);
            $('#MemberChips_filter').selectpicker('refresh');
            $('#MemberChips').val("");
            $('#MemberCards_filter').val(0);
            $('#MemberCards_filter').selectpicker('refresh');
            $('#MemberCards').val("");
            $('#MemberOffline_filter').val(0);
            $('#MemberOffline_filter').selectpicker('refresh');
            $('#MemberOffline').val("");
            $('#GroupM').val(0);
            $('#GroupM').selectpicker('refresh');
        }

        function datacheck() {
            var MemberId = $('#MemberId').val().replace(/\s+/g, "");
            var MemberNickName = $('#MemberNickName').val().replace(/\s+/g, "");
            var MemberVIPLV = $('#MemberVIPLV').val();
            var MemberVIPLV_filter = $('#MemberVIPLV_filter').val();
            var MemberLV = $('#MemberLV').val();
            var MemberLV_filter = $('#MemberLV_filter').val();
            var MemberEmail = $('#MemberEmail').val().replace(/\s+/g, "");
            var MemberName = $('#MemberName').val().replace(/\s+/g, "");
            var MemberNation = $('#MemberNation').val().replace(/\s+/g, "");
            var MemberAge = $('#MemberAge').val();
            var MemberAge_filter = $('#MemberAge_filter').val()
            var MemberPhone = $('#MemberPhone').val().replace(/\s+/g, "");
            var GroupM = $('#GroupM').val();
            var MemberRegistered = $('#MemberRegistered').val();
            var MemberRegistered_filter = $("#MemberRegistered_filter").val();
            var MemberFirstLogin = $('#MemberFirstLogin').val();
            var MemberFirstLogin_filter = $('#MemberFirstLogin_filter').val();
            var MemberIdNumber = $('#MemberIdNumber').val();
            var MemberActive_filter  = $('#MemberActive_filter').val();
            var MemberActive = $('#MemberActive').val();
            var MemberBalance = $('#MemberBalance').val();
            var MemberBalance_filter = $('#MemberBalance_filter').val();
            var MemberChips = $('#MemberChips').val();
            var MemberChips_filter = $('#MemberChips_filter').val();
            var MemberCards = $('#MemberCards').val();
            var MemberCards_filter = $('#MemberCards_filter').val();
            var MemberOffline = $('#MemberOffline').val();
            var MemberOffline_filter = $('#MemberOffline_filter').val();

            var result = { r: false };

            if (MemberAge !== "") {
                result.r = true;
                result.MemberAge_filter = MemberAge_filter;
                result.MemberAge = MemberAge;
            }
            if (MemberOffline !== "") {
                result.r = true;
                result.MemberOffline_filter = MemberOffline_filter;
                result.MemberOffline = MemberOffline;
            }
            if (MemberFirstLogin !== "") {
                result.r = true;
                result.MemberFirstLogin_filter = MemberFirstLogin_filter;
                result.MemberFirstLogin = MemberFirstLogin;
            }
            if (MemberBalance !== "") {
                result.r = true;
                result.MemberBalance_filter = MemberBalance_filter;
                result.MemberBalance = MemberBalance * 100;
            }
            if (MemberChips !== "") {
                result.r = true;
                result.MemberChips_filter = MemberChips_filter;
                result.MemberChips = MemberChips;
            }
            if (MemberActive !== "") {
                result.r = true;
                result.MemberActive_filter = MemberActive_filter;
                result.MemberActive = MemberActive;
            }
            if (MemberCards !== "") {
                result.r = true;
                result.MemberCards_filter = MemberCards_filter;
                result.MemberCards = MemberCards;
            }
            if (MemberId !== "") {
                result.r = true;
                result.MemberId = MemberId;
            }
            if (MemberNickName !== "") {
                result.r = true;
                result.MemberNickName = MemberNickName;
            }
            if (MemberVIPLV !== "0") {
                result.r = true;
                result.MemberVIPLV_filter = MemberVIPLV_filter;
                result.MemberVIPLV = MemberVIPLV;
            }
            if (MemberLV !== "") {
                result.r = true;
                result.MemberLV = MemberLV;
                result.MemberLV_filter = MemberLV_filter;
            }
            if (MemberEmail !== "") {
                result.r = true;
                result.MemberEmail = MemberEmail;
            }
            if (MemberName !== "") {
                result.r = true;
                result.MemberName = MemberName;
            }
            if (MemberNation !== "") {
                result.r = true;
                result.MemberNation = MemberNation;
            }
            if (MemberPhone !== "") {
                result.r = true;
                result.MemberPhone = MemberPhone;
            }
            if (MemberIdNumber !== "") {
                result.r = true;
                result.MemberIdNumber = MemberIdNumber;
            }
            if (GroupM !== "0") {
                result.r = true;
                result.GroupM = GroupM;
            }
            if (MemberRegistered !== "") {
                result.r = true;
                result.MemberRegistered = MemberRegistered;
                result.MemberRegistered_filter = MemberRegistered_filter;
            }
            if (!result.r) { alert('Please Enter Data'); };
            return result;
        }

        function search(e) {
            e.preventDefault();
            var result = datacheck();
            console.log(result);
            if (!result.r) {
                return;
            }
            $('.input-sm').val('');
            table.search('').draw();
            table.clear().draw();
            var data = [];
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/ManualTargetSearch",
                data: result,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        msg.data.forEach(function(value) {
                            data.push(["<input type='checkbox' id='check-all' class='flat'>",
                                checkIsNullOrEmpty(value.MemberId) ? "" : value.MemberId,
                                checkIsNullOrEmpty(value.NickName) ? "" : value.NickName,
                                checkIsNullOrEmpty(value.MemberVIP) ? "" : value.MemberVIP > VIPData.length ? "資料錯誤 : " + value.MemberVIP : VIPData[value.MemberVIP],
                                checkIsNullOrEmpty(value.MemberLevel) ? "" : value.MemberLevel,
                                checkIsNullOrEmpty(value.ActiveValue) ? "0" : value.ActiveValue,
                                checkIsNullOrEmpty(value.Email) ? "" : value.Email,
                                checkIsNullOrEmpty(value.Name) ? "" : value.Name,
                                checkIsNullOrEmpty(value.Nation) ? "" : value.Nation,
                                checkIsNullOrEmpty(value.CellPhoneNum) ? "" : value.CellPhoneNum,
                                checkIsNullOrEmpty(value.CreateTime) ? "" : moment(value.CreateTime).format("YYYY-MM-DD HH:mm:ss"),
                                checkIsNullOrEmpty(value.FirstLogInTime) ? "未登入" : (checkIsNullOrEmpty(value.OfflineDays) ? "0" : value.OfflineDays),
                                checkIsNullOrEmpty(value.Age) ? "未輸入" : value.Age,
                                checkIsNullOrEmpty(value.IdNumber) ? "" : value.IdNumber,
                                checkIsNullOrEmpty(value.FirstLogInTime) ? "未登入" : moment(value.FirstLogInTime).format("YYYY-MM-DD HH:mm:ss"),
                                checkIsNullOrEmpty(value.MemberBalance) ? "0" : thousandComma(Number(value.MemberBalance / 100).toFixed(2)),
                                checkIsNullOrEmpty(value.ChipCount) ? "0" : value.ChipCount,
                                checkIsNullOrEmpty(value.ItemCount) ? "0" : value.ItemCount
                            ]);
                        });
                        table.rows.add(data).draw();
                        $('html,body').animate({scrollTop:$('#MemberGroup').offset().top},400);
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function thousandComma(number) {
            var num = number.toString();
            var pattern = /(-?\d+)(\d{3})/;

            while (pattern.test(num)) {
                num = num.replace(pattern, "$1,$2");
            }
            return num;
        }

        function importMember(members) {
            selectid = [];
            table.search('').draw();
            table.clear().draw();
            var data = [];
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/ManualTargetGetImportMember",
                data: { Members: JSON.stringify(members) },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    console.log(msg.data);
                    if (msg.code == -1) { msg.msg } else {
                        msg.data.forEach(function(value) {
                            console.log("ADD : " + value.MemberId);
                            console.log("value.MemberVIP : " + value.MemberVIP);
                            data.push(["<input type='checkbox' id='check-all' class='flat' checked='checked'>",
                                checkIsNullOrEmpty(value.MemberId) ? "" : value.MemberId,
                                checkIsNullOrEmpty(value.NickName) ? "" : value.NickName,
                                checkIsNullOrEmpty(value.MemberVIP) ? "" : value.MemberVIP > VIPData.length ? "資料錯誤 : " + value.MemberVIP : VIPData[value.MemberVIP],
                                checkIsNullOrEmpty(value.MemberLevel) ? "" : value.MemberLevel,
                                checkIsNullOrEmpty(value.ActiveValue) ? "" : value.ActiveValue,
                                checkIsNullOrEmpty(value.Email) ? "" : value.Email,
                                checkIsNullOrEmpty(value.Name) ? "" : value.Name,
                                checkIsNullOrEmpty(value.Nation) ? "" : value.Nation,
                                checkIsNullOrEmpty(value.CellPhoneNum) ? "" : value.CellPhoneNum,
                                checkIsNullOrEmpty(value.CreateTime) ? "" : moment(value.CreateTime).format("YYYY-MM-DD HH:mm:ss"),
                                checkIsNullOrEmpty(value.FirstLogInTime) ? "未登入" : (checkIsNullOrEmpty(value.OfflineDays) ? "0" : value.OfflineDays),
                                checkIsNullOrEmpty(value.Age) ? "未輸入" : value.Age,
                                checkIsNullOrEmpty(value.IdNumber) ? "" : value.IdNumber,
                                checkIsNullOrEmpty(value.FirstLogInTime) ? "未登入" : moment(value.FirstLogInTime).format("YYYY-MM-DD HH:mm:ss"),
                                checkIsNullOrEmpty(value.MemberBalance) ? "0" : thousandComma(Number(value.MemberBalance / 100).toFixed(2)),
                                checkIsNullOrEmpty(value.ChipCount) ? "0" : value.ChipCount,
                                checkIsNullOrEmpty(value.ItemCount) ? "0" : value.ItemCount
                            ]);
                            selectid.push(value.MemberId);
                        });
                        table.rows.add(data).draw();
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                console.log(selectid);
                $('#loading-cover').fadeOut(100);;
            });
        }

        function checkIsInTable(memberId) {
            var isFound = false;
            table.rows().data().each(function (value, index) {
                console.log("VALUE!!!");
                console.log(value);
                var rowMemberId = value[1];
                if (memberId == rowMemberId) {
                    console.log("memberId : " + memberId);
                    console.log("rowMemberId : " + rowMemberId);
                    console.log(table.row(index));
                    $(table.row(index + 1)).iCheck('check');
                    // var id = $.inArray(memberId, selectid);
                    // if (id === -1) {
                    //     selectid.push(memberId);
                    // }
                    isFound = true;
                    console.log(selectid);
                }
            });
            return isFound;
        }

        function checkIsNullOrEmpty(obj) {
             if (obj == 'undefined' || obj == null || obj == 0 || obj == '')
                return true;
            return false;
        }

        $('.btn.btn-danger')
            .on('mousedown', clear)
            .on('touchstart', clear);

        $('.btn.btn-success')
            .on('mousedown', search)
            .on('touchstart', search);

        $('#AudienceAdd').on('click', "", function(e) {
            var tempForm = new Object();
            tempForm.AudienceName = $('#AudienceName').val();
            tempForm.AudienceDescription = $('#AudienceDescription').val();
            tempForm.Smart = "0";

            if (!checkIsNullOrEmpty(MemberGroupData[tempForm.AudienceName])) {
                alert("新增失敗, 已有相同名稱群組");
                return;
            }
            additem(tempForm);
        });

        $("button#rowAdd").on('click', "", function(e) {
            if (confirm("確定要加入嗎?")) {
                $('#loading-cover').fadeIn(100);
                $.ajax({
                    type: 'POST',
                    url: "/InsertMemberToGroup",
                    data: { Members: JSON.stringify(selectid), GroupId: $("#MemberGroup").find(":selected").val() },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                        alert(msg.msg);
                    },
                    error: function(xhr, desc, err) {
                        alert("HTTP Status code:" + xhr.status);
                    }
                }).done(function() {
                    $('#loading-cover').fadeOut(100);;
                });
            }
        });

        // $('#importExcel').change(function(e) {
        //     console.log(table.length);
        //     var files = e.target.files;

        //     var fileReader = new FileReader();
        //     fileReader.onload = function(ev) {
        //         try {
        //             var data = ev.target.result,
        //                 workbook = XLSX.read(data, {
        //                     type: 'binary'
        //                 }), // 以二进制流方式读取得到整份excel表格对象
        //                 member = []; // 存储获取到的数据
        //         } catch (e) {
        //             console.log('文件類型不正確');
        //             return;
        //         }

        //         // 表格的表格范围，可用于判断表头是否数量是否正确
        //         var fromTo = '';
        //         // 遍历每张表读取
        //         for (var sheet in workbook.Sheets) {
        //             if (workbook.Sheets.hasOwnProperty(sheet)) {
        //                 fromTo = workbook.Sheets[sheet]['!ref'];
        //                 console.log(fromTo);
        //                 member = member.concat(XLSX.utils.sheet_to_json(workbook.Sheets[sheet]));
        //                 // break; // 如果只取第一张表，就取消注释这行
        //             }
        //         }
        //         console.log(table.length);
        //         importMember(member);
        //         $('#importExcel').val('');
        //     };

        //     // 以二进制方式打开文件
        //     fileReader.readAsBinaryString(files[0]);
        // });

        function additem(data) {
            if (confirm("確定存檔嗎?")) {
                if (checkObjectValue(data)) {
                    $.ajax({
                        type: 'POST',
                        url: "/MemberGroupAdd",
                        cache: false,
                        async: true,
                        data: data,
                        dataType: 'json',
                        success: function(msg) {
                            if (msg.code == 0) {
                                GetMemberGroupList();
                                $('#AudienceName').val(""); 
                                $('#AudienceDescription').val(""); 
                            }
                            alert(msg.msg);
                        }
                    });
                }
            }
        };

        //檢查物件
        function checkObjectValue(tempForm) {

            if (tempForm.AudienceName.trim() == "") {
                alert("AudienceName Error");
                return false;
            }
            if (!tempForm.AudienceDescription) {
                alert("AudienceDescription Error");
                return false;
            }
            return true;
        }

        $(document).on('change keyup keydown focus click', 'input[type=number][min][max]', function (event) {
            var maxValue = Number($(this).attr('max'));
            var minValue = Number($(this).attr('min'));
            var getValue = Number($(this).val());

            if (getValue != null && getValue != "") {
                if (maxValue != null) {
                    if (getValue > maxValue) {
                        QuickNotify(`數值超出系統容許大小：${maxValue}。已自動將數值降至容許最大值。`, 'warning');
                        $(this).val(maxValue);
                    }
                }
                if (minValue != null) {
                    if (getValue < minValue) {
                        QuickNotify(`數值低於系統容許大小：${minValue}。已自動將數值降至容許最小值。`, 'warning');
                        $(this).val(minValue);
                    }
                }
            }
        });
    });
    </script>
</body>

</html>