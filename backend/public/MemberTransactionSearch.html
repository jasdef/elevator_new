
<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.min.css" rel="stylesheet"/>

    <style>
        #datatable td:nth-last-child(1) { white-space: nowrap;}
        #datatable td:nth-last-child(2) { white-space: nowrap;}
        #datatable div { margin-bottom: 6px;}
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">贈禮時間</label>
                                            <div class="col-xs-10">
                                                <input type="text" id="MemberTransactionTime" class="form-control "/>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label col-xs-2">贈禮類型
                                            </label>
                                            <div class="col-xs-10">
                                                <select name="TransactionType" id="TransactionType" class="form-control" required="required">
                                                    <option class="text-center" value="all" selected>全部</option>
                                                    <option class="text-center" value="send">贈送者</option>
                                                    <option class="text-center" value="recv">接受者</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="ln_solid"></div>
                                    <div class="form-group">
                                        <div class="col-md-6 col-md-offset-4">
                                            <button class="btn btn-danger">清除</button>
                                            <button class="btn btn-success">搜尋</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 col-sm-6 col-xs-12">
                            <div class="x_panel">
                                <div class="x_content">
                                    <div class="form-horizontal form-label-left" novalidate>
                                        <div class="item form-group">
                                            <div class="item form-group">
                                                <label class="control-label col-xs-2">會員ID
                                                </label>
                                                <div class="col-xs-10">
                                                    <input id="MemberId" class="date-picker form-control" placeholder="" type="text" readonly="readonly">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-xs-2">遊戲暱稱
                                                </label>
                                                <div class="col-xs-10">
                                                    <input id="MemberNickName" class="form-control" placeholder="" type="text" readonly="readonly">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-xs-2">真實姓名
                                                </label>
                                                <div class="col-xs-10">
                                                    <input id="MemberName" class="form-control" placeholder="" type="text" readonly="readonly">
                                                </div>
                                            </div>
                                            <div class="item form-group">
                                                <label class="control-label col-xs-2">遊戲帳號
                                                </label>
                                                <div class="col-xs-10">
                                                    <input id="MemberAccount" class="form-control" placeholder="" type="text" readonly="readonly">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="row">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>贈禮查詢</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <table id="datatable" class="table table-striped table-bordered bulk_action">
                                        <thead>
                                            <tr>
                                                <th>Id</th>
                                                <th>贈送者ID</th>
                                                <th>贈送者暱稱</th>
                                                <th>接收者ID</th>
                                                <th>接收者暱稱</th>
                                                <th>遊戲幣金額</th>
                                                <th>手續費</th>
                                                <th>狀態</th>
                                                <th>創造時間</th>
                                                <th>有效期限</th>
                                                <th>SN</th>
                                                <th>贈送或退回完成</th>
                                                <th>贈送的道具表</th>
                                                <th>贈送的碎片表</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script src="../vendors/xlsx/dist/xlsx.full.min.js"></script>

    <script>
    $(document).ready(function() {    
        var $_GET = {};
        
        var table = $('#datatable').DataTable({
            'order': [
                [1, 'asc']
            ],
            "lengthMenu": [ 
                [30, 50, 100, -1], 
                [30, 50, 100, "∞"] 
            ],
            "columnDefs": [{
                "targets": [0, 11],
                "className": "text-center"
            },{
                "targets": [12],
                "width": "600px"
            },{
                "targets": [13],
                "width": "300px"
            }]
        });

        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
            function decode(s) {
                return decodeURIComponent(s.split("+").join(" "));
            }
            $_GET[decode(arguments[1])] = decode(arguments[2]);
        });  
        
        $("#MemberId").val($_GET["MemberId"]);
        $("#MemberNickName").val($_GET["NickName"]);
        $("#MemberName").val($_GET["Name"]);
        $("#MemberAccount").val($_GET["Account"]);
        
        $('#TransactionType').selectpicker({
            showTick: true
        });  
        $('#MemberTransactionTime').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment().startOf('day'),
            endDate: moment().endOf('day'),
            timePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            ranges: {
                'Today': [moment().startOf('day'), moment().endOf('day')],
                'Tomorrow': [moment().add(1, 'days').startOf('day'), moment().add(1, 'days').endOf('day')],
                '7 Days': [moment().startOf('day'), moment().add(6, 'days').endOf('day')],
                '30 Days': [moment().startOf('day'), moment().add(29, 'days').endOf('day')],
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'This Year': [moment().startOf('year'), moment().endOf('year')]
            }
        });

        function clear(e) {
            e.preventDefault();
        }

        function search(e) {
            e.preventDefault();
            //$('.input-sm').val('');
            //table.search('').draw();
            table.clear().draw();
            var data = [];
            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/MemberTransactionSearch",
                data: { MemberId: $_GET["MemberId"] },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        var jsonData = JSON.parse(msg.data);
                        var recvArr = jsonData.reiceverTransactionInfoList;
                        var recvLen = recvArr.length;
                        var sendArr = jsonData.senderTransactionInfoList;
                        var sendLen = sendArr.length;

                        for (var i = 0; i < recvLen; ++i) {
                            var item = generateTableItem(recvArr[i]);
                            if (item != null)
                                data.push(item);
                        }

                        for (var i = 0; i < sendLen; ++i) {
                            var item = generateTableItem(sendArr[i]);
                            if (item != null)
                                data.push(item);
                        }
                        table.rows.add(data).draw();
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function generateTableItem(item) {
            var MemberTransactionTimeStart = $('#MemberTransactionTime').data('daterangepicker').startDate;
            var MemberTransactionTimeEnd = $('#MemberTransactionTime').data('daterangepicker').endDate;
            //var TransactionSeq = $('#TransactionSeq').val();
            var TransactionType = $('#TransactionType').val();

            if (item.createTime < MemberTransactionTimeStart || item.createTime > MemberTransactionTimeEnd) {
                return null;
            }

            // if (TransactionSeq != "" && !item.transactionSN.includes(TransactionSeq)) {
            //     return null;
            // }

            if (TransactionType == "send" && item.sender != $_GET["MemberId"]) {
                return null;
            }

            if (TransactionType == "recv" && item.receiver != $_GET["MemberId"]) {
                return null;
            }

            var isSender = item.sender == $_GET["MemberId"];
            var arr = [];
            arr = [
                item.transactionId,
                item.sender,
                item.senderNickName,
                item.receiver,
                item.receiverNickName,
                thousandComma(isNullOrEmpty((isSender ? "-" : "+") + item.amount, "0")),
                thousandComma(isNullOrEmpty(item.fee, "0")),
                item.status,
                moment(item.createTime).format("YYYY-MM-DD HH:mm:ss"),
                moment(item.validTime).format("YYYY-MM-DD HH:mm:ss"),
                item.transactionSN,
                item.transComplete,
                getItemOrChipString(item.costItemInfoList, true),
                getItemOrChipString(item.costChipInfoList, false)
            ];
            return arr;
        }

        function thousandComma(number) {
            var num = number.toString();
            var pattern = /(-?\d+)(\d{3})/;

            while (pattern.test(num)) {
                num = num.replace(pattern, "$1,$2");
            }
            return num;
        }

        function isNullOrEmpty(obj, s) {
             if (obj == 'undefined' || obj == null || obj == 0 || obj == '')
                return s;
            return obj;
        }

        function getItemOrChipString(value, isItem) {
            var str = "";
            for (var j = 0 ; j < value.length; ++j) {
                str += '<div>';
                str += isItem ? AttItemsData["Item"][value[j].itemId].DataContent : AttItemsData["Chip"][value[j].typeId].DataContent;
                str += ' <span class=\'label label-warning\'>數量' + value[j].costNum + '</span></div><br>'
            }
            return str;
        }

        getCategory();
        
        function getCategory(callback) {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getAttItems",
                cache: false,
                data: { mAttachment: '1' },
                async: true,
                dataType: 'json',
                success: function(msg) {
                    mAttachmentParse('Item', msg.data);
                    $.ajax({
                        type: 'GET',
                        url: "/BulletinMail_getAttItems",
                        cache: false,
                        data: { mAttachment: '2' },
                        async: true,
                        dataType: 'json',
                        success: function(msg) {
                            mAttachmentParse('Chip', msg.data);
                            //callback();
                        }
                    });
                }
            });
        };

        // Other GET / POST
        var AttItemsData = {};
        // ParseData
        function mAttachmentParse(ParseData) {
            // console.log(value);
            AttItemsData = {};
            $.each(ParseData, function(index, value) {
                AttItemsData[value.ItemId] = {
                    id: value.ItemId,
                    Name: value.ItemName,
                    betLevel: value.betLevel,
                    GameName: value.GameName,
                    multiple: value.multiple,
                    round: value.round,
                    itemType: value.itemType,
                    DataContent: '<span class=\'label label-default\'>' + value.ItemId + '號</span> <span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>Lv-' + value.betLevel + '</span> <span class=\'label label-info\'>' + value.ItemName + '</span> <span class=\'label label-primary\'>' + value.multiple + '倍</span> <span class=\'label label-default\'>' + value.round + '場</span> <span class=\'label label-default\'>' + value.itemType + '</span>'
                };
            });
        };

        // ParseData
        function mAttachmentParse(mAttachment, ParseData) {
            // console.log(value);
            AttItemsData[mAttachment] = {};
            switch (mAttachment) {
                case 'Item':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ItemId] = {
                            id: value.ItemId,
                            Name: value.ItemName,
                            betLevel: value.betLevel,
                            GameName: value.GameName,
                            multiple: value.multiple,
                            round: value.round,
                            itemType: value.itemType,
                            DataContent: '<span class=\'label label-default\'>' + value.ItemId + '號</span> <span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>Lv-' + value.betLevel + '</span> <span class=\'label label-info\'>' + value.ItemName + '</span> <span class=\'label label-primary\'>' + value.multiple + '倍</span> <span class=\'label label-default\'>' + value.round + '場</span> <span class=\'label label-default\'>' + value.itemType + '</span>'
                        };
                    });
                    break;
                case 'Chip':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ChipId] = {
                            id: value.ChipId,
                            Name: value.ChipName,
                            GameName: value.GameName,
                            MixValue: value.MixValue,
                            DataContent: '<span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>' + value.ChipName + '</span> <span class=\'label label-info\'>' + value.MixValue + '</span> <span class=\'label label-default\'>' + value.SellValue + '</span>'
                        };
                    });
                    break;
            }
        };

        $('.btn.btn-danger')
            .on('mousedown', clear)
            .on('touchstart', clear);

        $('.btn.btn-success')
            .on('mousedown', search)
            .on('touchstart', search);
    });
    </script>
</body>

</html>