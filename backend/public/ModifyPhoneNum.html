<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.min.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
        #datatable tbody td {
            vertical-align: middle;
        }
    
        .required {
            background-color: #FFF0F5;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>門號修改</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="col-md-6 col-sm-6 col-xs-12">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label class="control-label">會員ID</label>
                                            <input id="MemberId" class="form-control" type="text" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">玩家暱稱</label>
                                            <input id="NickName" class="form-control" type="text" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">原門號</label>
                                            <input id="OldPhoneNum" class="form-control" type="text" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">新門號(格式為:9XXXXXXXX)</label>
                                            <div class="input-group">                                               
                                                <input id="NewPhoneNum" class="form-control text-left"  oninput="if(value.length>9) value=value.slice(0,9)" type="number">
                                                <span class="input-group-btn">
                                                    <button target="_blank" id="Check" class="btn btn-success">門號檢查</button>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="form-group">
                                            <label class="control-label">新門號錯誤回報</label>
                                            <input id="CheckResult" class="form-control" type="text" readonly>
                                        </div>
                                        <div class="form-group">
                                            <label for="Note" class="control-label" data-toggle="tooltip" data-placement="right" title="	必填, 1~1200中字。">修改原因* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                            <textarea id="Note" class="date-picker form-control col-md-7 col-xs-12" maxlength="1200" rows="5" style="margin-bottom: 2vh;resize: none;"></textarea>
                                        </div>
  
                                        <button id="Send" class="btn btn-primary" style="margin-bottom: 10px;">送出</button>

                                    </div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>門號修改紀錄</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                     <div class="x_content">
                                        <table id="datatable" class="table table-striped table-bordered">
                                            <thead>
                                                <tr>
                                                    <th>玩家Id</th>
                                                    <th>玩家暱稱</th>
                                                    <th>原門號</th>
                                                    <th>新門號</th>
                                                    <th>修改者</th>
                                                    <th>修改原因</th>
                                                    <th>修改時間</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /page content -->
        <!--footer-->
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <div id="bs-modal-box" class="modal fade" tabindex="-1" role="dialog"></div>

    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- validator -->
    <script src="../vendors/validator/validator.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>

    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {

        var isCanSendModifyNum = false;
        var Action;
        var PhoneId;//只有在Action 2的時候才會有
        var ImpoliteTypeGroup = [];
        var $_GET = {};
        var table = $('#datatable').DataTable();
        
        Init();
        function Init() {
            document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
                function decode(s) {
                    return decodeURIComponent(s.split("+").join(" "));
                }
                $_GET[decode(arguments[1])] = decode(arguments[2]);
            });
            
            $('#MemberId').val($_GET["MemberId"]);
            $('#NickName').val($_GET["NickName"]);
            var phoneNum = $_GET["CellPhoneNum"];
            
            if (phoneNum == "null")
                phoneNum = "";
            
            $('#OldPhoneNum').val(phoneNum);
   
        }

        function Send() {
            if ($('#Note').val() === "") {
                alert("修改原因一定要填!!");
                return;
            }
            
            if (isCanSendModifyNum) {                
                var requestData = {};
                requestData.MemberId = $_GET["MemberId"];
                requestData.NickName = $_GET["NickName"];
                requestData.OldPhoneNum = $_GET["CellPhoneNum"];
                requestData.NewPhoneNum = $('#NewPhoneNum').val();
                requestData.Note = $('#Note').val();

                if (Action == 4) {
                    
                    $.ajax({
                    type: 'POST',
                    url: "/AddPhoneNum",
                    data: { requestData: JSON.stringify(requestData) },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                            alert(msg.msg);
                        }
                    });
                }
                else if (Action == 3) {
                    requestData.PhoneId = PhoneId;
                    $.ajax({
                    type: 'POST',
                    url: "/UpdatePhoneNum",
                    data: { requestData: JSON.stringify(requestData) },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                            alert(msg.msg);
                        }
                    });
                }
                else if (Action == 1) {
                    requestData.PhoneId = PhoneId;
                    $.ajax({
                    type: 'POST',
                    url: "/AddMemberStatusCellPhoneNumber",
                    data: { requestData: JSON.stringify(requestData) },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                            alert(msg.msg);
                        }
                    });
                }
                else if (Action == 2) {
                    $.ajax({
                    type: 'POST',
                    url: "/AddCellPhoneNumber",
                    data: { requestData: JSON.stringify(requestData) },
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(msg) {
                            alert(msg.msg);
                        }
                    });
                }
                search();
            }
            else {
                alert("請確認新門號是否格式正確!!");
            }

        }
        
        function Check() {
            $('#loading-cover').fadeIn(100);
            var newPhoneNum = $('#NewPhoneNum').val();
            if (!newPhoneNum.match(/^9[0-9]{8}$/)) {
                $('#CheckResult').val("此門號格式有誤");
                $('#loading-cover').fadeOut(100);
            }
            else {
                $.ajax({
                type: 'POST',
                url: "/CheckPhoneNum",
                data: { NewPhoneNum: newPhoneNum, MemberId:$_GET["MemberId"] },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {

                    if (msg.code == 0) {
                        isCanSendModifyNum = true;
                        Action = msg.action;
                        console.log("action =="+Action);
                        if (Action == 1 || Action == 3)
                            PhoneId = msg.phoneId;
                    }
                    $('#CheckResult').val(msg.msg);
                }
                }).done(function() {
                    $('#loading-cover').fadeOut(100);
                });
            }
        }

        
        search();

        function search() {


            if (typeof table !== "undefined") {
                table.destroy();
            }

            table = $('#datatable').DataTable({
                "serverSide": false,
                "searching" : true,
                "lengthMenu": [
                    [30, 50, 100, 1000],
                    [30, 50, 100, 1000]
                ],
                "order": [
                    [6, "desc"]
                ],
                "columns": [
                    { "data": "MemberId"},
                    { "data": "NickName"},
                    { "data": "NumBefore" },
                    { "data": "NumAfter" },
                    { "data": "Author" },
                    { "data": "Note" },     
                    { "data": "ModifyTime" },               
                ],
                'rowCallback': function(row, data, dataIndex) {
                            $('td:eq(6)', row).html(moment(data.ModifyTime).format("YYYY-MM-DD HH:mm:ss"));      
                },
                "ajax": {
                    "url": "/GetAllModifyNumData",
                    "type": "POST",
                    //"data": { requestData: JSON.stringify(requestData) },
                    "cache": "false",
                    "async": "true",
                    "dataType": 'json'
                }
            });
        }


        $(document).on('click', '#Send', Send);
        $(document).on('click', '#Check', Check);
        $('#NewPhoneNum').change(function() {
            isCanSendModifyNum = false;
        });
    });


    </script>

</body>