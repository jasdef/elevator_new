<!DOCTYPE html>
<html lang="en">

<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<!-- Meta, title, CSS, favicons, etc. -->
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>SCG</title>
	<!-- Bootstrap -->
	<link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Font Awesome -->
	<link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
	<!-- NProgress -->
	<link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
	<!-- Datatables -->
	<link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
	<link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
	<link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
	<link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
	<link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
	<!-- Custom Theme Style -->
	<link href="../build/css/custom.min.css" rel="stylesheet">
	<!-- bootstrap-daterangepicker -->
	<link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
	<!-- bootstrap-select -->
	<link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
	<!-- jquery-ui -->
	<link rel="stylesheet" href="../vendors/jquery-ui/jquery-ui.min.css">
	<link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
	<style type="text/css" media="screen">
	.popover {
		max-width: 700px;
	}

	.form-control[readonly] {
		background-color: transparent;
	}
	/*圖片選擇*/

	#gallery-sortable li {
		margin: .2%;
		width: 19.5%;
		height: 300px;
		padding: 5px;
	}

	.thumbnail {
		height: auto;
		margin-bottom: 0px;
	}

	#gallery-sortable .pinSize {
		overflow: hidden;
		height: 210px;
		position: relative;
	}

	#gallery-sortable .over-img-block {
		position: absolute;
		padding: 10px;
		width: 100%;
		height: 40px;
		z-index: 99;
		top: 0;
		left: 0;
	}

	#gallery-sortable .edit-over-item {
		position: relative;
		background: rgba(180, 180, 180, .3);
		width: calc(100% + 20px);
		height: 310px;
		padding: 32px 10px 10px 10px;
		margin: -10px -10px -300px -10px;
		z-index: 999;
	}

	#gallery-sortable p {
		overflow: hidden;
		text-overflow: ellipsis;
		white-space: nowrap;
	}

	.label {
		font-size: 100%;
	}

	.blur {
		filter: blur(3px);
	}

	#gallery-sortable>li.selected[data-pid]>.thumbnail {
		box-shadow: 0 0 1px 3px rgba(0, 130, 255, 0.7);
		border-color: rgba(0, 0, 0, 0);
	}
	/*圖片選擇*/

	.pinSize img.img-responsive {
		cursor: pointer;
		-webkit-transition: transform .5s ease;
		-moz-transition: transform .5s ease;
		-ms-transition: transform .5s ease;
		-o-transition: transform .5s ease;
		transition: transform .5s ease;
	}

	.pinSize img.img-responsive:hover {
		-webkit-transform: scale(2.2) rotateZ(15deg);
		-moz-transform: scale(2.2) rotateZ(15deg);
		-ms-transform: scale(2.2) rotateZ(15deg);
		-o-transform: scale(2.2) rotateZ(15deg);
		transform: scale(2.2) rotateZ(15deg);
	}
	/*圖片放大瀏覽*/

	.form-control-feedback {
		margin-top: 5px;
	}

	.has-feedback .form-control {
		padding-right: 25px;
	}

	textarea {
		resize: vertical;
	}

	.progress {
		width: 100%;
		margin-bottom: 0;
		border-radius: 10px;
		height: 12px;
	}

	.progress>.progress-bar>span {
		line-height: 12px;
		margin-top: 0px;
		display: block;
	}
	</style>
</head>

<body class="nav-md">
	<div class="container body">
		<div class="main_container">
			<!--Menu-->
			<!--Top-->
			<!-- page content -->
			<div class="right_col" role="main">
				<div class="row">
					<div class="clearfix"></div>
					<div class="row">
						<div class="col-md-12 col-sm-12 col-xs-12">
							<div class="x_panel">
								<div class="x_title">
									<h2>圖片上傳</h2>
									<div class="clearfix"></div>
								</div>
								<div class="x_content">
									<div class="col-md-12 col-sm-12 col-xs-12">
										<div class="col-lg-12 col-md-12 col-xs-12">
											<ul id="gallery-sortable" class="list-unstyled"></ul>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<!-- /page content -->
			<!--footer-->
		</div>
	</div>
	<!-- jQuery -->
	<script src="../vendors/jquery/dist/jquery.min.js"></script>
	<!-- jquery-ui -->
	<script src="../vendors/jquery-ui/jquery-ui.min.js"></script>
	<script>
	// $.widget.bridge('uibutton', $.ui.button);
	$.widget.bridge('uitooltip', $.ui.tooltip);
	</script>
	<!-- Bootstrap -->
	<script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
	<!-- FastClick -->
	<script src="../vendors/fastclick/lib/fastclick.js"></script>
	<!-- NProgress -->
	<script src="../vendors/nprogress/nprogress.js"></script>
	<!-- iCheck -->
	<script src="../vendors/iCheck/icheck.min.js"></script>
	<!-- Datatables -->
	<script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
	<script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
	<script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
	<script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
	<script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
	<script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
	<script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
	<script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
	<script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
	<script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
	<script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
	<script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
	<script src="../vendors/jszip/dist/jszip.min.js"></script>
	<script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
	<script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
	<script src="../vendors/moment/min/moment.min.js"></script>
	<script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
	<!-- bootstrap-select -->
	<script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
	<script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
	<!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
	<!-- Custom Theme Scripts -->
	<script src="../build/js/custom.min.js"></script>
	<script>
	$(document).ready(function() {
		var Type = 'WebSiteImage';
		var $_GET = {};
		var CDN_Domain = "";

		$.each($('#datatable > thead > tr > th'), function(index, val) {
			$(this).attr('title', index);
		});

		document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
			function decode(s) {
				return decodeURIComponent(s.split("+").join(" "));
			}
			$_GET[decode(arguments[1])] = decode(arguments[2]);
		});

		function getCDNDomain() {
			$.ajax({
					url: '/GetCDNDomain',
					type: 'GET',
				}).done(function(result) {
					CDN_Domain = result;
					console.log(CDN_Domain);
				})
				.fail(function() {
					alert("Get CDN Domain ERROR!");
				});
		}
		getCDNDomain();

		function LoadingEff(effon) {
			if ($('#loading-cover').length < 1) {
				var html = '<div id="loading-cover">' +
					'<div id="loading-icon">' +
					'<i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>'
				'</div>' +
				'</div>';
				$('body').append(html);
				$('#loading-cover').css({
					'width': '100%',
					'height': '100%',
					'background': 'rgba(0,0,0,.5)',
					'position': 'fixed',
					'display': 'none',
					'z-index': '999999',
					'top': '0',
					'left': '0'
				});
				$('#loading-icon').css({
					'width': '85px',
					'height': '65px',
					'margin': '-42.5px 0 0 -32.5px',
					'top': '50%',
					'left': '50%',
					'position': 'fixed'
				});
			}
			if (effon) {
				$('#loading-cover').fadeIn(100);
			} else {
				$('#loading-cover').fadeOut(100);
			}
		}

		function ShowAlert(Content, Sec) {
			//margin: 0 auto;
			if ($('#bs-alert-box').length < 1) {
				var html = '<div id="bs-alert-box" class="alert alert-success alert-dismissible" role="alert" style="position: fixed; bottom: 0; left: 0; width: 98%; z-index:999999; margin: 1%;">' +
					'<button type="button" class="close" data-dismiss="alert" aria-label="Close">' +
					'<span aria-hidden="true">&times;</span>' +
					'</button>' +
					'<h6>TEXT</h6>' +
					'</div>';
				$('body').prepend(html);
			}
			$('#bs-alert-box > h6').text(Content);
			$(".alert").alert();
			setTimeout(function() {
				$(".alert").alert('close');
				// alert('hide');
			}, Sec * 1000);
		}

		function ShowModalBox(Title, Content, footer, zindex = '999') {
			$('#bs-modal-box-' + zindex).remove();
			var html =
				'<div id="bs-modal-box-' + zindex + '" class="modal fade" tabindex="' + zindex + '" role="dialog">' +
				'<div class="modal-dialog modal-lg" role="document">' +
				'<div class="modal-content">' +
				'<div class="modal-header">' +
				'<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
				'<h4 class="modal-title"></h4>' +
				'</div>' +
				'<div class="modal-body" style="display:flow-root">' +
				'<p></p>' +
				'</div>' +
				(footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
				'</div>' +
				'</div>' +
				'</div>';
			$('body').append(html);
			$('#bs-modal-box-' + zindex + ' h4.modal-title').html(Title);
			$('#bs-modal-box-' + zindex + ' div.modal-body').html(Content);
			$('#bs-modal-box-' + zindex).modal('show');
		}

		function sizeLimit(input) {
			if ($(input).attr('data-max-filesize') > 0) {
				size = input.files[0].size;
				limit = $(input).attr('data-max-filesize') * 1024;

				if (size > limit) {
					return false;
				} else {
					return true;
				}
			} else {
				return false;
			}
		}

		function getImageSize(input, callback = null) {
			var _URL = window.URL || window.webkitURL;
			var file, img;
			file = input.files[0];
			img = new Image();
			img.onload = function() {
				callback(this.width, this.height);
			};
			img.src = _URL.createObjectURL(file);
		}

		function fileTypeChecker(input) {
			if ($(input).attr('accept').length > 0) {
				type = input.files[0].type.toString();
				attType = $(input).attr('accept').toString();
				if (type == attType) {
					return true;
				} else {
					return false;
				}
			} else {
				return false;
			}
		}

		function imagePreview(input, target = null) {
			if (input.files && input.files[0]) {
				if (target == null) {
					if ($(input).next().hasClass('previewImage')) {
						$(input).next().show();
					} else {
						$(input).after('<img src="" class="previewImage img-responsive img-thumbnail" alt="" style="margin-top: 10px;">');
					}
				} else {
					target.removeClass('hidden');
				}
				var reader = new FileReader();
				reader.onload = function(e) {
					if (target == null) {
						$(input).next().attr('src', e.target.result);
					} else {
						target.attr('src', e.target.result);
					}
				}
				reader.readAsDataURL(input.files[0]);
			} else {
				if (target == null) {
					$(input).next().attr('src', "#");
				} else {
					target.addClass('hidden');
					target.attr('src', "#");
				}
			}
		}

		$('[data-toggle="tooltip"]').tooltip();

		var LangList = {}; // 語言列表(Arrray)
		var LangOption = ''; // 語言列表(html)

		function getLangList() {
			$.ajax({
				url: '/getLangList',
				type: 'POST',
				cache: false,
				async: true,
				dataType: 'json',
				success: function(data) {
					$.each(data.data, function(index, value) {
						LangList[value.Code] = value.Lang.toString();
					});
					LangOption = '';
					LangOption += '<select class="form-control item-lang">';
					$.each(LangList, function(index, value) {
						LangOption += '<option value="' + index + '">' + value + '</option>';
					});
					LangOption += '</select>';
				}
			}).done(function() {
				getGalleryData(Type, 'ASC');
			});
		}
		getLangList();


		function getGalleryData(type, order = 'DESC', selectedPicture = null) {
			if (Object.keys(LangList) <= 0) {
				alert('載入語言選單發生問題');
				getLangList();
			}
			$.ajax({
				url: '/GetPictures',
				type: 'POST',
				data: { type: type, order: order },
				cache: false,
				async: true,
				dataType: 'json',
				success: function(data) {
					var html = '<li class="pull-left ui-disabled well" style="">' +
						'<div class="form-group">' +
						'<div class="pinSize">' +
						'<img src="#" alt="圖片上傳預覽，檔案大小必須為800KB以內，且為jpg格式。" id="picturePreview" class="img-responsive">' +
						'</div>' +
						'<label for="pictureFile">於項目內新增相片</label>' +
						'<input type="file" id="pictureFile" name="pictureFile" style="width:60px; font-size:12px;" class="pull-left" accept="image/*" data-max-filesize="800" />' +
						'<button type="button" id="SendPicture" class="btn btn-xs btn-primary pull-right" disabled><i class="fa fa-upload" aria-hidden="true"></i></button>' +
						'</div>' +
						'</li>';
					$('#gallery-sortable').html(html);
					$.each(data.data, function(index, value) {
						var imageSrc = CDN_Domain + Type + '/' + value.Picture;
						var html =
							'<li class="pull-left" data-pid="' + value.pid + '">' +
							'<div class="thumbnail">' +
							'<div class="edit-over-item hide">' +
							'<div class="form-group form-group-sm">' +
							'<input type="text" class="form-control item-annotation" value="' + value.Annotation + '" />' +
							'</div>' +
							'<div class="form-group form-group-sm">' +
							LangOption +
							'</div>' +
							'<div class="form-group form-group-sm">' +
							'<div class="btn-group btn-group-xs btn-group-justified">' +
							'<a href="javascript:;" class="btn btn-primary edit-picture-send"><i class="fa fa-check-circle" aria-hidden="true"></i> 確定</a>' +
							'<a href="javascript:;" class="btn btn-default edit-picture-cancel"><i class="fa fa-undo" aria-hidden="true"></i> 取消</a>' +
							'</div>' +
							'</div>' +
							'</div>' +
							'<div class="pinSize">' +
							'<div class="over-img-block">' +
							'<span class="label label-default">' + LangList[value.Lang] + '</span>' +
							'</div>' +
							'<img src="' + imageSrc + '" alt="" class="img-responsive">' +
							'</div>' +
							'<div class="caption">' +
							'<p>' + value.Annotation + '</p>' +
							'<div class="btn-group btn-group-xs btn-group-justified">' +
							'<a href="javascript:;" class="edit-picture btn btn-success"><i class="fa fa-pencil" aria-hidden="true"></i> 編輯</a>' +
							'<a href="javascript:;" data-pid="' + value.pid + '" class="picture-del btn btn-danger"><i class="fa fa-trash" aria-hidden="true"></i> 刪除</a>' +
							'</div>' +
							'</div>' +
							'</div>' +
							'</li>';
						$('#gallery-sortable').append(html);
						var optionSelect = $('#gallery-sortable li[data-pid="' + value.pid + '"] .over-img-block > div.form-group > select > option');
						$.each(optionSelect, function(index, element) {
							$(element).prop('selected', $(element).attr('value') == value.Lang ? true : false);
						});
					});
					$("#gallery-sortable").sortable({
						cursor: "move",
						delay: 300,
						tolerance: "pointer",
						cancel: "input, select",
						items: "li:not(.ui-disabled)",
						placeholder: "pull-left",
						classes: {
							"ui-sortable-placeholder": "ui-state-highlight"
						}
					});
					$("#gallery-sortable").disableSelection();
				}
			});
		}

		function SendPicture() {
			var data = new FormData();
			var files = $("#pictureFile").get(0).files;
			if (files.length > 0) {
				data.append("uploadImage", files[0]);
			};
			data.append('type', Type);

			LoadingEff(true);
			$.ajax({
				url: '/SendPicture',
				type: 'POST',
				data: data,
				cache: false,
				async: true,
				processData: false,
				contentType: false,
				success: function(data) {
					getGalleryData(Type, 'ASC');
				}
			}).always(function() {
				LoadingEff(false);
			});
		}

		function pictureDel() {
			var confirmData = confirm("確定要刪除？（已經使用過的照片路徑不會真的被刪除，僅會從列表移除）");
			var checkStatus = false;

			if (confirmData) {
				var pid = $(this).attr('data-pid');
				var _element = $(this).parents('li.ui-sortable-handle');
				$.ajax({
					url: '/DelPicture',
					type: 'POST',
					data: { pid: pid },
					cache: false,
					async: true,
					dataType: 'json',
					success: function(data) {
						_element.remove();
						checkStatus = true;
					}
				}).always(function() {
					if (!checkStatus)
						alert('發生錯誤');
				});
			}
		}

		function pictureEdit(targetForm, targetOther) {
			if (targetForm.hasClass('hide')) {
				targetForm.removeClass('hide');
				targetOther.addClass('blur');
			} else {
				targetForm.addClass('hide');
				targetOther.removeClass('blur');
			}
		}

		function pictureEditOpen() {
			targetForm = $(this).parents('.thumbnail').find('.edit-over-item');
			targetOther = $(this).parents('.thumbnail').find('.pinSize, .caption');
			pictureEdit(targetForm, targetOther);
		}

		function itemEditHide(selectNum) {
			targetForm = $('#gallery-sortable > li > .thumbnail').eq(selectNum).find('.edit-over-item');
			targetOther = $('#gallery-sortable > li > .thumbnail').eq(selectNum).find('.pinSize, .caption');
			pictureEdit(targetForm, targetOther);
		}

		function editPictureSend() {
			var pid = $(this).parents('li[data-pid]').attr('data-pid');
			var annotation = $(this).parents('div.edit-over-item').find('.item-annotation').val();
			var lang = $(this).parents('div.edit-over-item').find('.item-lang').val();
			var thisEq = $(this).parents('li[data-pid]').prevAll().not('.ui-disabled').length;

			if ($(this).hasClass('edit-picture-send')) {
				var checkStatus = false;

				$.ajax({
					url: '/EditPicture',
					type: 'POST',
					data: { pid: pid, annotation: annotation, lang: lang },
					cache: false,
					async: true,
					dataType: 'json',
					success: function(data) {
						checkStatus = true;
					}
				}).always(function() {
					if (!checkStatus) {
						alert('發生錯誤');
					}
					itemEditHide(thisEq);
					getGalleryData(Type, 'ASC');
				});
			} else {
				itemEditHide(thisEq);
			}
		}

		function sendPictureOrder() {
			var checkStatus = false;
			var item = $('#gallery-sortable > li').not('.ui-disabled');
			var postData = [];
			$(item).each(function(index, el) { //.get().reverse() -> 應應 SQL ORDER BY DESC
				postData.push({ 'pid': $(this).attr('data-pid'), 'no': index });
			});
			console.log(postData);
			$.ajax({
				url: '/OrderPicture',
				type: 'POST',
				data: JSON.stringify({ data: postData }),
				cache: false,
				async: true,
				contentType: 'application/json',
				processData: false,
				success: function(data) {
					checkStatus = true;
				}
			}).always(function() {
				if (!checkStatus) {
					alert('更新順序發生錯誤');
				} else {
					alert('更新順序成功');
					getGalleryData(Type, 'ASC');
				}
			});
		}

		function showPicturePreviewModal() {
			var Content = $(this)[0].outerHTML;
			var CloudURL = CDN_Domain + Type + '/' + $(this).attr('src').split(Type + '/')[1];
			var lang = $(this).prev().find('span')[0].outerHTML;
			var annotation = $(this).parents('.thumbnail').find('.caption > p').text();
			var Title = lang + ' ' + annotation;

			Content = '<input type="url" class="form-control selecttext" value="' + CloudURL + '">' + Content;

			ShowModalBox(Title, Content, null, '99999');
		}

		$(document).on('change', '#pictureFile', function(event) {
			var overLimit = sizeLimit(this);
			// var allowType = fileTypeChecker(this);
			var allowType = true;
			if (!overLimit || !allowType) {
				$(this).val('');
				var msg = (!overLimit ? "Size Over Limit \n" : "") + (!allowType ? "File Type Error" : "");
				alert(msg);
				$('#SendPicture').prop('disabled', true);
			} else {
				$('#SendPicture').prop('disabled', false);
			}
			imagePreview(this, $('#picturePreview'));
		});

		$(document).on('click', '#SendPicture', SendPicture);

		$(document).on('click', '.picture-del', pictureDel);

		$(document).on('click', '.edit-picture', pictureEditOpen);

		$(document).on('click', '.edit-picture-send, .edit-picture-cancel', editPictureSend);

		$(document).on('click', '#sendPictureOrder', sendPictureOrder);

		$(document).on('click', '#gallery-sortable .thumbnail img', showPicturePreviewModal);

		$(document).on('click', '.selecttext', function(event) {
            var copytext = $(this).val();
            $(this).select();
            document.execCommand("Copy");
            $.notify({
                message: '<i class="fa fa-check-circle"></i> URL已經複製完成：' + copytext
            },{
                type: 'success',
                z_index: 2000,
				delay: 2000,
            });
		});


		// 多重視窗相容性
		$(document).on('hidden.bs.modal', function(event) {
			if ($('.modal:visible').length) {
				$('body').addClass('modal-open');
			}
		});

		$(document).on('show.bs.modal', function(event) {
			var modalLength = $('.modal').length;
			$.each($('.modal').get().reverse(), function(index, element) {
				var new_zindex = 1050 - (index * 20);
				$(element).css('z-index', new_zindex);
				$(element).next('.modal-backdrop').css('z-index', new_zindex - 15);
			});
		});

	});
	</script>
</body>

</html>