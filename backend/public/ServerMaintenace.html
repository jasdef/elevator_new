<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">

    <!-- bootstrap-datetimepicker -->
    <link href="../vendors/bootstrap-datetimepicker/build/css/bootstrap-datetimepicker.css" rel="stylesheet">
    <!-- Ion.RangeSlider -->
    <link href="../vendors/normalize-css/normalize.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.css" rel="stylesheet">
    <link href="../vendors/ion.rangeSlider/css/ion.rangeSlider.skinFlat.css" rel="stylesheet">
    <style>
        .dataTables_wrapper>.row {
            overflow: visible!important;
        }

        .serverStatusRunningBackground {
            background-color: green;
            text-align: center;
            color:white;
        }
        .serverStatusMaintainBackground {
            background-color: red;
            text-align: center;
            color:white;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="clearfix"></div>
                <div class="row">
                    <div class="col-md-12">
                        <!-- form date pickers -->
                        <div class="x_panel" style="">
                            <div class="x_title">
                                <h2>刷新靜態資料</h2>
                                <ul class="nav navbar-right panel_toolbox">
                                    <li>
                                        <a class="collapse-link">
                                            <i class="fa fa-chevron-up"></i>
                                        </a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_content">
                                        <div class="form-horizontal form-label-left" novalidate>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <button id="clearStaticData" class="btn btn-success">立刻刷新靜態資料</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <!-- form date pickers -->
                        <div class="x_panel" style="">
                            <div class="x_title">
                                <h2>伺服器刪除Token</h2>
                                <ul class="nav navbar-right panel_toolbox">
                                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_content">
                                        <div class="form-horizontal form-label-left" novalidate>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <button id="mClearAllToken" class="btn btn-success">刪除所有Token</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <!-- form date pickers -->
                        <div class="x_panel" style="">
                            <div class="x_title">
                                <h2>延長機台時間</h2>
                                <ul class="nav navbar-right panel_toolbox">
                                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_content">
                                        <div class="form-horizontal form-label-left" novalidate>
                                            <div class="item form-group">
                                                <label class="control-label">延長時間(秒)</label>
                                                <input id="ExtendTime" class="date-picker form-control col-md-7 col-xs-12" placeholder="" type="text">
                                            </div>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <button id="mExtendTimeConfirm" class="btn btn-success">確定</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <!-- form date pickers -->
                        <div class="x_panel" style="">
                            <div class="x_title">
                                <h2>伺服器狀態</h2>
                                <ul class="nav navbar-right panel_toolbox">
                                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_content">
                                        <div class="form-horizontal form-label-left" novalidate>
                                            <h1 id="ServerStatusText" class="serverStatusRunningBackground">營運中</h1>
                                            <div class="form-group">
                                                <div class="text-center">
                                                    <button id="mChangeServerStatus" class="btn btn-success">開始維修</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <!-- form date pickers -->
                        <div class="x_panel" style="">
                            <div class="x_title">
                                <h2>伺服器維修人員</h2>
                                <ul class="nav navbar-right panel_toolbox">
                                    <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a>
                                    </li>
                                </ul>
                                <div class="clearfix"></div>
                            </div>
                            <div class="col-md-12 col-sm-12 col-xs-12">
                                <div class="x_panel">
                                    <div class="x_content">
                                        <div class="form-horizontal form-label-left" novalidate>
                                            <div class="item form-group">
                                                <label class="control-label">MemberId
                                                </label>
                                                <input id="MemberId" class="date-picker form-control col-md-7 col-xs-12" placeholder="" type="text">
                                            </div>
                                            <div class="ln_solid"></div>
                                            <div class="form-group">
                                                <div class="col-md-9 col-md-offset-4">
                                                    <button id="mInsertMaintainCrew" class="btn btn-success">新增維修人員</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-12 col-sm-12 col-xs-12">
                        <div class="x_panel">
                            <div class="x_title">
                                <h2>伺服器維修白名單</h2>
                                <div class="clearfix"></div>
                            </div>
                            <div class="x_content">
                                <table id="datatable" class="table table-striped table-bordered">
                                    <thead>
                                        <tr>
                                            <th>Id</th>
                                            <th>MemberId</th>
                                            <th>功能</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <div id="loading-cover" style="width: 100%; height: 100%; background: rgba(0,0,0,.5); position: fixed; display: none; z-index: 999999; top: 0; left: 0;">
        <div id="loading-icon" style="width: 85px; height: 65px; margin: -42.5px 0 0 -32.5px; top: 50%; left: 50%; position: fixed;">
            <i class="fa fa-circle-o-notch fa-spin fa-5x fa-fw" style="color: #FFF;"></i>
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- Ion.RangeSlider -->
    <script src="../vendors/ion.rangeSlider/js/ion.rangeSlider.min.js"></script>
    <!-- bootstrap-daterangepicker -->
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-datetimepicker -->    
    <script src="../vendors/bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>
    <!-- jquery.inputmask -->
    <script src="../vendors/jquery.inputmask/dist/min/jquery.inputmask.bundle.min.js"></script>
    <!-- jQuery Knob -->
    <script src="../vendors/jquery-knob/dist/jquery.knob.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>

    $(document).ready(function() {
        var currentRow;
        var serverStatus;
        var $_GET = {}; 
        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() { 
            function decode(s) { 
                return decodeURIComponent(s.split("+").join(" ")); 
            } 
            $_GET[decode(arguments[1])] = decode(arguments[2]); 
        });

        var table = $('#datatable').DataTable({
            destroy: true,
            "columnDefs": [
                {"targets": 0},
                {"targets": 1},
                {
                    "targets": 2,
                    "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                        "<button class='btn btn-danger' id='removeCrew'><i class='fa fa-pencil-square-o' aria-hidden='true'></i> 刪除</button>" +
                        "</div>"
                }
            ]
        });

        $('#datatable tbody').on('click', 'button', function(e) {
            var data = table.row($(this).parents('tr')).data();
            var jsonData = {};
            currentRow = $(this).closest("tr");
            switch ($(this).attr('id')) {
                case "removeCrew":
                    removeCrew(currentRow.find("td:eq(1)").text());
                    break;
            }
        });
        
        getServerStatus();
        refresh();

        $(document).on('click', '#mInsertMaintainCrew', insertCrew);
        $(document).on('click', '#mChangeServerStatus', changeServerStatus);
        $(document).on('click', '#mClearAllToken', clearAllToken);
        $(document).on('click', '#mExtendTimeConfirm', extendTimeConfirm);
        $(document).on('click', '#clearStaticData', clearStaticData);
        //$(document).on('click', '#mGetExtendTimeList', getExtendTimeList);
        
        // function getExtendTimeList() {
        //     if (!confirm("確定要取得延長時間之機台列表嗎?")){
        //         return;
        //     }

        //     $.ajax({
        //         type: 'POST',
        //         url: "/ServerMaintainGetExtendReserveTimeList",
        //         cache: false,
        //         async: true,
        //         dataType: 'json',
        //         success: function(msg) {
        //             var code = msg.code;
        //             var message = msg.msg;
        //             if (code == 0) {
        //                 //getServerStatus();
        //             }
        //             //alert(message);
        //             $('#mExtendTimeList').val(JSON.stringify(msg.data));
        //         },
        //         error: function(xhr, desc, err) {
        //             alert("HTTP Status code:" + xhr.status);
        //         }
        //     }).done(function() {
        //         $('#loading-cover').fadeOut(100);
        //     });
        // }
        
        function getServerStatus() {
            $.ajax({
                type: 'POST',
                url: "/ServerMaintenaceGetServerStatus",
                cache: false,
                async: true,
                success: function(msg) {
                    console.log(msg);
                    serverStatus = msg.data[0];
                    if (serverStatus.Value == "0") {
                        $('#ServerStatusText').addClass('serverStatusRunningBackground').removeClass('serverStatusMaintainBackground');
                        $('#ServerStatusText').text("營運中");
                        $('#mChangeServerStatus').addClass('btn-danger').removeClass('btn-success');
                        $('#mChangeServerStatus').text("開始維修");
                    } else {
                        $('#ServerStatusText').addClass('serverStatusMaintainBackground').removeClass('serverStatusRunningBackground');
                        $('#ServerStatusText').text("維修中");
                        $('#mChangeServerStatus').addClass('btn-success').removeClass('btn-danger');
                        $('#mChangeServerStatus').text("開始營運");
                    }
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function extendTimeConfirm(e) {
            var extendSec = $('#ExtendTime').val();
            if (!extendSec) {
                alert("請輸入延長時間!!");
                return;
            }

            if (!confirm("確定要延長機台時間 " + extendSec + " 秒嗎?")){
                return;
            }

            var SendData = {
                ExtendTime : extendSec
            };

            $.ajax({
                type: 'POST',
                url: "/ServerMaintainExtendReserveTime",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        //getServerStatus();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function clearAllToken(e) {
            if (!confirm("確定要刪除所有Token嗎?")){
                return;
            }

            $.ajax({
                type: 'POST',
                url: "/ServerMaintainClearAllToken",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        //getServerStatus();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function changeServerStatus(e) {
            var str = serverStatus.Value == "0" ? "開始維修" : "開始營運";
            if (!confirm("確定要 " + str + " 嗎?")){
                return;
            }

            var SendData = {
                ServerStaus : serverStatus.Value == "0" ? "1" : "0"
            };

            $.ajax({
                type: 'POST',
                url: "/ServerMaintenaceSetServerStatus",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        getServerStatus();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        function insertCrew(e) {
            var MemberId = $('#MemberId').val();
            if (!MemberId) {
                alert("請輸入MemberId!!");
                return;
            }

            if (!confirm("確定新增 " + MemberId + " 至維修白名單嗎?")){
                return;
            }

            var SendData = {
                MemberId : MemberId
            };

            $.ajax({
                type: 'POST',
                url: "/ServerMaintenaceWhiteListAdd",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        //處理刪除
        function removeCrew(memberId) {
            if (!confirm("確定將 " + memberId + " 從維修白名單中移除嗎?"))
                return;

            var SendData = {
                MemberId : memberId
            };

            $('#loading-cover').fadeIn(100);
            $.ajax({
                type: 'POST',
                url: "/ServerMaintenaceWhiteListDel",
                data: SendData,
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    $('#bs-modal-box').modal('hide');
                    var code = msg.code;
                    var message = msg.msg;
                    if (code == 0) {
                        refresh();
                    }
                    alert(message);
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        };

        function refresh() {
            $('#loading-cover').fadeIn(100);
            table.clear().draw();
            var data = [];
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/ServerMaintenaceWhiteList",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    msg.data.forEach(function(value) {
                        data.push([
                            value.Id,
                            value.MemberId
                        ]);
                    });
                    table.rows.add(data).draw();
                },
                error: function(xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function() {
                $('#loading-cover').fadeOut(100);
            });
        }

        // //處理修改
        // function modifyitem() {
        //     var editId = currentRow.find("td:eq(0)").text();
        //     var editType = $('#editType').val();
        //     var editTitle = $('#editTitle').val();
        //     var editContent = $('#editContent').val();
        //     if (!editTitle || !editContent) {
        //         alert("請輸入內容!!");
        //         return;
        //     }

        //     var SendData = {
        //         Id : editId,
        //         Type : editType,
        //         Title : editTitle,
        //         Content: editContent
        //     };

        //     if (!confirm("確定修改嗎?"))
        //         return;

        //     $('#loading-cover').fadeIn(100);
        //     $.ajax({
        //         type: 'POST',
        //         url: "/FeedbackCanModify",
        //         data: SendData,
        //         cache: false,
        //         async: true,
        //         dataType: 'json',
        //         success: function(msg) {
        //             $('#bs-modal-box').modal('hide');
        //             var code = msg.code;
        //             var message = msg.msg;
        //             if (code == 0) {
        //                 refresh();
        //             }
        //             alert(message);
        //         },
        //         error: function(xhr, desc, err) {
        //             alert("HTTP Status code:" + xhr.status);
        //         }
        //     }).done(function() {
        //         $('#loading-cover').fadeOut(100);
        //     });
        // };

        function clearStaticData(){
            $('#loading-cover').fadeIn(100);
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/refreshStaticData",
                cache: false,
                async: true,
                dataType: 'json',
                success: function (msg) {
                    alert(JSON.stringify(msg));
                },
                error: function (xhr, desc, err) {
                    alert("HTTP Status code:" + xhr.status);
                }
            }).done(function () {
                $('#loading-cover').fadeOut(100);
            });
        }
    });
    
    </script>
</body>

</html>