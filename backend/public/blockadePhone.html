<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
        #datatable tr td{
            vertical-align: middle;
        }
        .alert h5{
            margin: 0 0 0 15px;
            font-size: 1.3em;
        }
        .alert i{
            margin-right: 5px;
        }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>門號封鎖</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-lg-12 col-md-12 col-xs-12">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-sm-2">
                                                            <label for="BlockadNum" class="control-label" title="必選項目">手機門號*</label>
                                                            <input type="text" name="BlockadNum" id="BlockadNum" class="form-control"  maxlength="10" required>
                                                        </div>
                                                        <div class="col-sm-9">
                                                            <label for="BlockadNote" class="control-label" title="必填項目">封鎖原因*</label>
                                                            <input type="text" name="BlockadNote" id="BlockadNote" class="form-control length-input" minlength="10"  maxlength="255" required>
                                                        </div>
                                                        <div class="col-sm-1">
                                                            <label class="control-label" style="opacity: 0;">確定送出</label>
                                                            <button id="SendAdd" type="button" class="btn btn-primary btn-block">確定送出</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>已封鎖列表</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <button class="btn btn-primary pull-right btn-sm refresh-table"><i class="fa fa-refresh" aria-hidden="true"></i> 刷新列表</button>

                                    <table id="datatable" class="table table-striped table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th title="異動時間">封鎖<br/>日期</th>
                                                <th title="送出時間">手機門號</th>
                                                <th title="失效時間">封鎖原因</th>
                                                <th title="動作">動作</th>
                                                <!-- <th title="刪除">Dele</th> -->
                                                <!-- <th>Mag</th>
                                                <th>Reward</th>
                                                <th>Tag</th> -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {
        var endDate = moment();

        function QuickNotify(message, type) {
            var icon = "";
            switch(type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fa-times-circle';
                    break;
                default: 
                    icon = 'fa-exclamation-triangle';
            }
            $.notify({
                message: '<h5><i class="fa ' + icon + '"></i> ' + message + '</h5>'
            },{
                type: type,
                z_index: 20000,
                delay: 6000,
            });
        }

        function textLengthInsert(target, text){
            if(!target.next().hasClass('length-text-data')){
                var html = '<p class="help-block text-right length-text-data"></p>';
                target.after(html);
            }
            target.next('.length-text-data').html(text);
        };

        function textLengthPreview(){
            $('.length-input').each(function(index, el) {
                var maxLength = $(el).attr('maxlength') != null ? Number($(el).attr('maxlength')) : '∞';
                var inputLength = $(el).val().length;
                var insertText = inputLength + ' / ' + maxLength;
                textLengthInsert($(el), insertText);
            });

            $(document).on('change keyup', '.length-input', function(event) {
                var maxLength = $(event.target).attr('maxlength') != null ? Number($(event.target).attr('maxlength')) : '∞';
                var inputLength = $(event.target).val().length;
                var insertText = inputLength + ' / ' + maxLength;
                textLengthInsert($(event.target), insertText);
            });
        };
        textLengthPreview();

        function phoneComma(number){
            var num = number == null ? '0' : number.toString();
            var pattern = /(\d{4})(\d{3})(\d{3})/;
            while(pattern.test(num)){
                num = num.replace(pattern, "$1-$2-$3");
            }
            return num;
        };

        function previewPhoneComma(target, num){
            target.tooltip('destroy');
            target.tooltip({
                animation: false,
                title: phoneComma(num),
                trigger: 'focus',
                placement: 'top',
                // template: '<div class="tooltip"><div class="tooltip-arrow"></div><p class="tooltip-inner text-nowrap"></p></div>'
            }).tooltip('show');
        }

        function ShowModalBox(Title, Content, footer, zindex = '999') {
            $('#bs-modal-box-' + zindex).remove();
            var html =
                '<div id="bs-modal-box-' + zindex + '" class="modal fade" tabindex="' + zindex + '" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '<h4 class="modal-title"></h4>' +
                '</div>' +
                '<div class="modal-body" style="display:flow-root">' +
                '<p></p>' +
                '</div>' +
                (footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
                '</div>' +
                '</div>' +
                '</div>';
            $('body').append(html);
            $('#bs-modal-box-' + zindex + ' h4.modal-title').html(Title);
            $('#bs-modal-box-' + zindex + ' div.modal-body').html(Content);
            $('#bs-modal-box-' + zindex).modal('show');
        }

        var mDataTable = $('#datatable').DataTable({
                "lengthMenu": [[30, 50, 100, -1], [30, 50, 100, "∞"]],
                "autoWidth": false,
                "order": [
                    [0, "desc"]
                ],
                "columnDefs": [{
                    "targets": 0,
                    "width": "45px"
                }, {
                    "targets": 1,
                    "width": "60px"
                }, {
                    "targets": 3,
                    "width": "30px"
                }]
        });
        var dataForEdit = {};
        function getTableData() {

            var ActionBtn = function(index, key){
                var EditBtn = '<button type="button" editkey="' + index + '" delekey="' + key + '" class="btn btn-info RowEdit"><i class="fa fa-pencil"></i> 修改</button>';
                var DeleBtn = '<button type="button" delekey="' + key + '" class="btn btn-danger RowDelete"><i class="fa fa-trash-o"></i> 刪除</button>';
                return '<div class="btn-group" style="display: flex;">' + EditBtn + DeleBtn + '</div>';
            };

            var arrayTableData = [];
            $.ajax({
                type: 'POST',
                url: '/blockadePhone_History',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(result) {
                    dataForEdit = result.result;
                    $.each(dataForEdit, function(index, value) {
                        arrayTableData.push([
                            moment(value.timeStemp).format("YYYY-MM-DD HH:mm:ss"),
                            "0" + value.Number,
                            value.Note,
                            ActionBtn(index, value.Id)
                        ]);
                    });
                    mDataTable.clear().draw();
                    mDataTable.rows.add(arrayTableData).draw();
                }
            });
        };
        getTableData();

        $(document).on('change keyup focus click', '#BlockadNum, #editBlockadNum', function(event) {
            event.preventDefault();
            previewPhoneComma($(this), $(this).val());
        });

        $(document).on('click', '#SendAdd', function(event) {
            event.preventDefault();
            var insertData = {
                BlockadNum: $('#BlockadNum').val(),
                BlockadNote: $('#BlockadNote').val()
            }

            var checkData = {
                BlockadNum: insertData.BlockadNum.match(/^09[0-9]{8}$/),
                BlockadNote: insertData.BlockadNote.length >= 10 && insertData.BlockadNote.length <= 255
            }

            if(checkData.BlockadNote && checkData.BlockadNum){
                $.ajax({
                    type: 'POST',
                    url: "/blockadePhone_Add",
                    data: insertData,
                    dataType: 'json',
                    success: function(result) {
                        if (result.code == "0") {
                            getTableData();
                            QuickNotify('新增門號封鎖名單成功', 'success');
                        } else {
                            if(result.error == "NumberExist"){
                                QuickNotify('無法新增已經存在的號碼', 'warning');
                            } else {
                                QuickNotify('新增失敗，資料庫連線異常', 'danger');
                            }
                        }
                    },
                    error: function() {
                        QuickNotify('新增失敗，連線錯誤。', 'danger');
                    }
                });
            } else {
                if(!checkData.BlockadNum){
                     QuickNotify('請輸入手機門號或是格式不正確', 'danger');
                }
                if (!checkData.BlockadNote) {
                    if(insertData.BlockadNote.length >= 10){
                        QuickNotify('封鎖原因不可高於255字', 'danger');
                    } else {
                        QuickNotify('封鎖原因未填或是小於10字', 'danger');
                    }
                }
            }
        });


        $(document).on('click', '.RowDelete', function(event) {
            var confirmAlert = confirm("確定要刪除？");
            if (confirmAlert) {
                var thisRow = $(this);
                $.ajax({
                    url: 'blockadePhone_Delete',
                    type: 'POST',
                    dataType: 'json',
                    data: { delekey: $(this).attr('delekey') },
                })
                .done(function(result) {
                    mDataTable.row(thisRow.parents('tr')).remove().draw();
                    QuickNotify('門號已經刪除！', 'success');
                })
                .fail(function() {
                    QuickNotify('連線發生問題，刪除失敗！', 'danger');
                });
            } else {}
        });

        $(document).on('click', '.RowEdit', function(event) {
            if (dataForEdit == null) {
                QuickNotify('資料錯誤，請重新整理', 'danger');
            } else {
                var editData = dataForEdit[$(this).attr('editkey')];
            }

            var html =    '<div class="col-sm-2">'
                        +     '<label class="control-label" title="必選項目">手機門號*</label>'
                        +     '<input type="text" name="editBlockadNum" id="editBlockadNum" class="form-control"  maxlength="10" required>'
                        + '</div>'
                        + '<div class="col-sm-10">'
                        +      '<label class="control-label" title="必填項目">封鎖原因*</label>'
                        +      '<input type="text" name="editBlockadNote" id="editBlockadNote" class="form-control length-input"  maxlength="100" required>'
                        + '</div>';
            var zindex = 999;
            var footer = 
                '<div class="btn-group btn-group-lg" style="margin-right: 10px;">' +
                '<button id="sendEditData" data-update-id="' + editData.Id + '" type="button" class="btn btn-primary"><i class="fa fa-pencil"></i> 確定修改</button>' +
                '<button type="button" class="btn btn-danger btn-lg" data-dismiss="modal"><i class="fa fa-undo"></i> 取消</button>';

            ShowModalBox('Edit', html, footer, zindex);

            $('#bs-modal-box-' + zindex).on('shown.bs.modal', function(e) {
                $('#editBlockadNum').val("0" + editData.Number);
                $('#editBlockadNote').val(editData.Note);
            });
        });

        $(document).on('click', '#sendEditData', function(event) {
            $('#bs-modal-box-999').modal('hide');
            var updateData = {
                updateId: $(this).attr('data-update-id'),
                BlockadNum: $('#editBlockadNum').val(),
                BlockadNote: $('#editBlockadNote').val()
            }

            $.ajax({
                url: '/blockadePhone_Edit',
                type: 'POST',
                data: updateData,
                dataType: 'json',
                success: function(result) {
                    if (result.code == "0") {
                        getTableData();
                        QuickNotify('門號封鎖名單修改成功', 'success');
                    } else {
                        if(result.error == "NumberExist"){
                            QuickNotify('無法修改成已經存在的號碼', 'warning');
                        } else {
                            QuickNotify('修改失敗，資料庫連線異常', 'danger');
                        }
                    }
                },
                error: function() {
                    QuickNotify('新增失敗，連線錯誤。', 'danger');
                }
            });
        });

    });
    </script>
</body>

</html>