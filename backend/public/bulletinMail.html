<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    .popover {
        max-width: 700px;
    }

    .form-control[readonly] {
        background-color: transparent;
    }

    .text-ellipsis {
        /*width: 200px;*/
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
    }

    #datatable tbody td {
        vertical-align: middle;
        overflow: hidden;
    }

    #datatable tbody td:nth-child(10) {
        text-align: right;
    }

    #datatable {
        table-layout: fixed;
    }
    #datatable td:nth-child(4) span.label {
        display: block;
    }
    .modal td span{
        line-height: 1.42857143;
    }
    .modal input{
        border-radius: .25em;
    }
    .modal table.add-item-to-pack td{
        vertical-align: middle;
    }
    .modal table.add-item-to-pack td .form-group,
    .modal table.add-item-to-pack td .btn
    {
        margin: 0;
    }
    .modal table.add-item-to-pack tbody > tr > td:nth-child(n+2),
    .modal table.add-item-to-pack tfoot > tr > td:nth-child(n+2){
        padding-left: 22px;
    }
    .modal table.add-item-to-pack td:nth-child(1){
        width: 40px;
    }
    .modal table.add-item-to-pack td:nth-child(2){
        width: 250px;
    }
    .modal table.add-item-to-pack td:nth-child(3){
        width: 280px;
    }
    .modal table.add-item-to-pack tbody td:last-child,
    .modal table.add-item-to-pack tfoot td:last-child{
        text-align: right;
        padding-right: 36px;
    }
    .modal table.add-item-to-pack caption{
        padding: 3px 8px;
    }
    .modal .dropdown-menu{
        margin-top: 0px;
        margin-left: -1px;
    }
    .dropdown-menu>li>a{
        padding: 6px 20px;
    }
    .bootstrap-select.btn-group.show-tick .dropdown-menu li.selected a span.check-mark{
        top: 0;
        line-height: 29px;
        margin-top: 0;
    }
    .alert h5{
        margin: 0 0 0 15px;
        font-size: 1.3em;
    }
    .alert i{
        margin-right: 5px;
    }
    .form-group p{
        margin-bottom: 0;
    }
    td .btn-block{
        margin-bottom: 0;
    }
    .show-pack-table tr td:first-child{
        width: 20%;
    }
    .show-pack-table tr td:last-child{
        width: 30%;
        text-align: right;
    }
    .show-pack-table .radio,
    .show-pack-table .table{
        margin: 0;
    }
    #datatable_wrapper > .row {
        overflow: visible!important;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>發送系統信</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-lg-3 col-md-6 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-heading"><i class="fa fa-question-circle"></i> 信件內容使用說明</div>
                                                <div class="panel-body">
                                                    <ul>
                                                        <li class="hide">若要瀏覽畫面請
                                                            <a href="javascript:;" class="btn btn-xs btn-primary"><i class="fa fa-download"></i> 下載</a>瀏覽程式（暫不支援）
                                                        </li>
                                                        <li>若要使用<b><u>連結</u></b>請使用<code>&lt;a href=&#x6b64;&#x8f38;&#x5165;&#x9023;&#x7d50;&gt;&#x6587;&#x5b57;&lt;/a&gt;</code>
                                                            <br/><b>可用選項：</b>
                                                        </li>
                                                        <ul>
                                                            <li>GameService</li>
                                                            <ul>
                                                                <li>opengame</li>
                                                                <ul>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="開啟火牛陣" data-action="200001">[game-id]</a></li>
                                                                </ul>
                                                                <li>deletegame</li>
                                                                <ul>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="刪除火牛陣" data-action="200001">[game-id]</a></li>
                                                                </ul>
                                                            </ul>
                                                        </ul>
                                                        <ul>
                                                            <li>LobbyService</li>
                                                            <ul>
                                                                <li>OpenView</li>
                                                                <ul>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開包包" data-action="">BackPack</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開任務" data-action="">Task</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開龍虎榜" data-action="">Ranking</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開社交" data-action="">Social</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開個人資料" data-action="">Profile</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開個人資料" data-action="">Shop</a></li>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-extext="打開個人資料" data-action="">Vip</a></li>
                                                                </ul>
                                                            </ul>
                                                        </ul>
                                                        <ul>
                                                            <li>WebService</li>
                                                            <ul>
                                                                <li>OpenWebView</li>
                                                                <ul>
                                                                    <li><a href="javascript:;" class="mail-code-example" data-exmode="WebService" data-extext="打開Google" data-action="http://www.google.com.tw">URL</a></li>
                                                                </ul>
                                                            </ul>
                                                        </ul>
                                                        <li>若要使用<b>粗體</b>請使用<code>&lt;b&gt;&#x7c97;&#x9ad4;&lt;/b&gt;</code></li>
                                                        <li>若要使用<i>斜體</i>請使用<code>&lt;i&gt;&#x659c;&#x9ad4;&lt;/i&gt;</code></li>
                                                        <li>若要使用<span style="color: blue;">顏色</span>請使用<code>&lt;color=blue&gt;&#x984f;&#x8272;&lt;color&gt;</code></li>
                                                        <li>若要使用<span style="font-size: 18px;">
                                                        大小</span>請使用<code>&lt;size=20&gt;&#x5927;&#x5c0f;&lt;/size&gt;</code></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-3 col-md-6 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-body">
                                                    <div class="form-group">
                                                        <label class="control-label">信件種類</label>
                                                        <div class="btn-group btn-group-justified" data-toggle="buttons">
                                                            <label class="btn btn-success btn-sm active">
                                                                <input type="radio" class="MailType" name="MailType" value="N" id="MailType_1" checked>文字信&amp;禮品信
                                                            </label>
                                                            <label class="btn btn-success btn-sm">
                                                                <input type="radio" class="MailType" name="MailType" value="L" id="MailType_2">廣告信（暫不支援）
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">受眾*</label>
                                                        <select name="mGroup" id="mGroup" class="form-control" disabled="">
                                                            <option class="default-option" value="none" selected>請選擇受眾</option>
                                                            <option class="default-option" value="single">單一會員</option>
                                                        </select>
                                                        <p class="help-block">*必選項目</p>
                                                    </div>
                                                    <div class="form-group hidden" id="ToMemberIdGroup">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必填項目，請輸入會員ID，請勿輸入會員姓名">會員ID* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="ToMemberId" id="ToMemberId" class="form-control length-input" value="" disabled="" maxlength="16">
                                                        <p class="help-block">*必選項目</p>
                                                    </div>
                                                    <div class="form-group GeneralMail">
                                                        <label class="control-label">夾帶類型</label>
                                                        <select name="mAttachment" id="mAttachment" class="form-control">
                                                            <option value="0" selected>不夾帶</option>
                                                            <option value="1" data-col="ItemJSON">卡片</option>
                                                            <option value="2" data-col="ChipJSON">碎片</option>
                                                            <option value="3" data-col="MoneyAmount">金錢</option>
                                                            <option value="7" data-col="Gem">寶石</option>
                                                            <option value="4" data-col="ExpAmount" style="display: none;">經驗值</option>
                                                            <!-- <option value="5" disabled>VIP點數</option> -->
                                                            <option value="6">獎項組合</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group GeneralMail">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="內建內容搜尋，須按照順序輸入關鍵字關鍵字間請用空格隔開">夾帶品項 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <select name="mCategory" id="mCategory" class="form-control" disabled="">
                                                            <option value="none">請選擇品項</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group GiftPackBtn hide">
                                                        <label class="control-label" data-toggle="tooltip">夾帶的獎勵組合</label>
                                                        <div class="input-group">
                                                            <div class="input-group-btn">
                                                                <button type="button" class="btn btn-success show-add-pack"  data-toggle="tooltip" data-placement="top" title="選擇或新增獎勵組合">
                                                                    <i class="fa fa-archive"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-danger clear-select-pack"  data-toggle="tooltip" data-placement="top" title="清除目前獎勵組合">
                                                                    <i class="fa fa-trash"></i>
                                                                </button>
                                                                <button type="button" class="btn btn-info show-pack-data" data-packid=""  data-toggle="tooltip" data-placement="top" title="檢視當前獎勵組合">
                                                                    <i class="fa fa-eye"></i>
                                                                </button>
                                                            </div>
                                                            <input id="packname" class="form-control" readonly>
                                                            <input type="hidden" id="packkey" disabled>
                                                        </div>
                                                    </div>
                                                    <div class="form-group GeneralMail">
                                                        <label class="control-label">數量</label>
                                                        <input type="number" id="mQuantity" class="form-control text-right" name="mQuantity" disabled="" value="0" min="1" style="font-size: 20px;" inputmode="numeric">
                                                        <!-- <input type="text" class="form-control text-right" value="0" style="font-size: 19.5px; padding-right: 27px;" readonly> -->
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="若時間設定為現在時間或更早的時間將於1分鐘內寄出信件">預約送信時間 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="ReserveTime" id="ReserveTime" class="form-control" value="" readonly="true" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必須大於預約送信日並預留足夠時間讓玩家開啟信件">信件失效時間 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="EndTime" id="EndTime" class="form-control" value="" readonly="true" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-md-12 col-xs-12">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-sm-3">
                                                            <label class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">信件類別</label>
                                                            <select id="TitleCategory" class="form-control" required="required">
                                                                <option value="MAIL_CATEGORY_ANNOUNCE">系統公告</option>
                                                                <option value="MAIL_CATEGORY_EVENT">營運活動</option>
                                                                <option value="MAIL_CATEGORY_PRIZE">得獎通知</option>
                                                                <option value="MAIL_CATEGORY_TEMP">臨時公告</option>
                                                                <option value="MAIL_CATEGORY_RANK">排行榜獎勵</option>
                                                                <option value="MAIL_CATEGORY_LEVEL">等級獎勵</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-9">
                                                            <label class="control-label" data-toggle="tooltip" data-placement="right" title="必填項目">信件主旨*</label>
                                                            <input type="text" name="MailTitle" id="MailTitle" class="form-control length-input" value="" maxlength="20">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group GeneralMail">
                                                    <label class="control-label">信件內容</label>
                                                    <textarea name="MailContent" id="MailContent" class="form-control length-input" rows="17" required="required" maxlength="500"></textarea>
                                                    <label class="control-label" data-toggle="tooltip" data-placement="right" title="非必填項目，僅供查核用前端不會顯示">備註 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                    <input type="text" name="MailNote" id="MailNote" class="form-control length-input" rows="17" required="required" maxlength="50">
                                                </div>
                                            </div>
                                            <div class="col-md-12 adMail">
                                                <div class="row">
                                                    <div class="form-group col-md-3">
                                                        <label class="control-label">Service</label>
                                                        <select name="Service" id="Service" class="form-control" required="required">
                                                            <option value="GameService">GameService</option>
                                                            <option value="LobbyService">LobbyService</option>
                                                            <option value="WebService">WebService</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group col-md-3">
                                                        <label class="control-label">Action</label>
                                                        <select name="Action" id="Action" class="form-control" required="required">
                                                            <option value="opengame" selected>opengame</option>
                                                            <option value="deletegame">deletegame</option>
                                                            <option value="OpenView" disabled>OpenView</option>
                                                            <option value="OpenWebView" disabled>OpenWebView</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group col-md-6">
                                                        <label class="control-label">Parameter</label>
                                                        <select name="ParameterGame" id="ParameterGame" class="form-control">
                                                        </select>
                                                        <select name="ParameterLobbyOpen" id="ParameterLobbyOpen" class="form-control">
                                                            <option value="BackPack" disabled>背包（暫不支援）</option>
                                                            <option value="Task" disabled>任務（暫不支援）</option>
                                                            <option value="Ranking" disabled>排行榜（暫不支援）</option>
                                                            <option value="Social" disabled>社群（暫不支援）</option>
                                                            <option value="Profile">個人資訊</option>
                                                            <option value="Shop">商城</option>
                                                            <option value="Vip">VIP</option>
                                                        </select>
                                                        <input type="url" name="ParameterURL" id="ParameterURL" class="form-control hide" value="" placeholder="https://www.google.com.tw/">
                                                    </div>
                                                    <div class="form-group col-md-12">
                                                        <input type="text" name="DataOutput" id="DataOutput" class="form-control" value="" disabled="">
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-12">
                                                <button type="button" id="SendMail" class="btn btn-lg btn-primary pull-right" disabled>確定送出</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>送信後結果</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content" style="overflow-x: auto;">
                                    <button class="btn btn-primary pull-right btn-sm refresh-table"><i class="fa fa-refresh" aria-hidden="true"></i> 刷新列表</button>

                                    <table id="datatable" class="table table-striped table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th title="異動時間">異動<br/>時間</th>
                                                <th title="送出時間">送出<br/>時間</th>
                                                <th title="失效時間">失效<br/>時間</th>
                                                <th title="受眾選擇/會員ID"><span class="label label-default">受眾選擇</span> / 會員ID</th>
                                                <th title="信件類別">信件<br/>類別</th>
                                                <th title="信件主旨">信件主旨</th>
                                                <th title="信件內容">信件內容</th>
                                                <th title="夾帶類型">夾帶類型</th>
                                                <th title="品項">品項</th>
                                                <th title="數量">數量</th>
                                                <th title="狀態">狀態</th>
                                                <th title="信件種類">信件種類</th>
                                                <th title="動作">動作</th>
                                                <!-- <th title="刪除">Dele</th> -->
                                                <!-- <th>Mag</th>
                                                <th>Reward</th>
                                                <th>Tag</th> -->
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>


    
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {
        var startDate = moment().subtract(29, 'days');
        var endDate = moment();
        var $_GET = {};



        document.location.search.replace(/\??(?:([^=]+)=([^&]*)&?)/g, function() {
            function decode(s) {
                return decodeURIComponent(s.split("+").join(" "));
            }
            $_GET[decode(arguments[1])] = decode(arguments[2]);
        });

        function thousandComma(number){
            var num = number == null ? '0' : number.toString();
            var pattern = /(-?\d+)(\d{3})/;
            while(pattern.test(num)){
                num = num.replace(pattern, "$1,$2");
            }
            return num;
        };

        function previewThousandComma(target, num){
            target.tooltip('destroy');
            target.tooltip({
                animation: false,
                title: thousandComma(num),
                trigger: 'focus',
                placement: 'right',
                template: '<div class="tooltip"><div class="tooltip-arrow"></div><h3 class="tooltip-inner"></h3></div>'
            }).tooltip('show');
        }

        function QuickNotify(message, type) {
            var icon = "";
            switch(type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fa-times-circle';
                    break;
                default: 
                    icon = 'fa-exclamation-triangle';
            }
            $.notify({
                message: '<h5><i class="fa ' + icon + '"></i> ' + message + '</h5>'
            },{
                type: type,
                z_index: 20000,
                delay: 6000,
            });
        }

        function ShowModalBox(Title, Content, footer, zindex = '999') {
            $('#bs-modal-box-' + zindex).remove();
            var html =
                '<div id="bs-modal-box-' + zindex + '" class="modal fade" tabindex="' + zindex + '" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '<h4 class="modal-title"></h4>' +
                '</div>' +
                '<div class="modal-body" style="display:flow-root">' +
                '<p></p>' +
                '</div>' +
                (footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
                '</div>' +
                '</div>' +
                '</div>';
            $('body').append(html);
            $('#bs-modal-box-' + zindex + ' h4.modal-title').html(Title);
            $('#bs-modal-box-' + zindex + ' div.modal-body').html(Content);
            $('#bs-modal-box-' + zindex).modal('show');
        }

        function textLengthInsert(target, text){
            if(!target.next().hasClass('length-text-data')){
                var html = '<p class="help-block text-right length-text-data"></p>';
                target.after(html);
            }
            target.next('.length-text-data').html(text);
        };

        function textLengthPreview(){
            $('.length-input').each(function(index, el) {
                var maxLength = $(el).attr('maxlength') != null ? Number($(el).attr('maxlength')) : '∞';
                var inputLength = $(el).val().length;
                var insertText = inputLength + ' / ' + maxLength;
                textLengthInsert($(el), insertText);
            });

            $(document).on('change keyup', '.length-input', function(event) {
                var maxLength = $(event.target).attr('maxlength') != null ? Number($(event.target).attr('maxlength')) : '∞';
                var inputLength = $(event.target).val().length;
                var insertText = inputLength + ' / ' + maxLength;
                textLengthInsert($(event.target), insertText);
            });
        };
        textLengthPreview();

        $('[data-toggle="tooltip"]').tooltip();

        $('.mail-code-example').popover({
            title: function() {
                var title = 'Example' +
                    '<a class="btn-popover-close pull-right" href="javascript:;" onclick="$(&quot;.mail-code-example&quot;).popover(&quot;hide&quot;);"> <i class="fa fa-times" aria-hidden="true"></i> </a>'
                return title;
            },
            content: function() {
                var codeExampleMode = $(this).attr('data-exmode');
                var text_Servive = $(this).parents().eq(3).children('li').eq(0).text();
                var text_Progam = $(this).parents().eq(1).prev().text();
                var text_Action = $(this).attr('data-action').length > 0 ? $(this).attr('data-action') : $(this).text();
                var needParse = true;

                var text = '&lt;a href=' +
                    text_Servive +
                    '/' + text_Progam +
                    '/' + text_Action +
                    '&gt;' + $(this).attr('data-extext') + '&lt;/a&gt;';
                var text = '<pre>' + text + '</pre>';

                return text;
            },
            // trigger: 'focus',
            html: true,
        });

        $('.mail-code-example').on('show.bs.popover', function() {
            $('.mail-code-example').not($(this)).popover('hide');
        });

        $('#mGroup, #mCategory, .mCategory, #ParameterGame').selectpicker({
            liveSearch: true,
            showTick: true,
            showContent: true,
            liveSearchNormalize: true
        });

        $('#Service, #mAttachment, .mAttachment, #Action, #ParameterLobbyOpen').selectpicker({
            showTick: true
        });

        $("#ParameterLobbyOpen").selectpicker('hide');

        $('#ReserveTime').daterangepicker({
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment().add(3, 'minute'),
            timePicker: true,
            singleDatePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            minDate: moment(),
        });

        $('#EndTime').daterangepicker({
            autoUpdateInput: false,
            locale: {
                format: 'YYYY-MM-DD HH:mm:ss'
            },
            startDate: moment().add(1, 'days'),
            timePicker: true,
            singleDatePicker: true,
            timePicker24Hour: true,
            timePickerSeconds: true,
            minDate: moment().add(60, 'minute')
        });

        $('.GeneralMail').show();
        $('.adMail').hide();

        // initLoading
        function getGameList() {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getGameList",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var targetSelect = $('#ParameterGame');
                    msg.data.forEach(function(value) {
                        targetSelect.append('<option data-content="<div class=\'label label-warning\'>' + value.SCGGameId + '</div> ' + value.GameName + '" value="' + value.SCGGameId + '">' + value.GameName + '</option>');
                    });
                    targetSelect.selectpicker('refresh');
                }
            })
        };
        getGameList();

        var AttData = {};
        var AttDisabled = [];
        var parseKey = [];
        function getAttData() {
            $('#mAttachment > option').each(function() {
                AttData[$(this).val()] = $(this).text();
                AttDisabled[$(this).val()] = false;
                parseKey[$(this).val()] = $(this).attr('data-col');
            });
        };
        var TitleCategoryData = {};
        function getTitleCategoryData() {
            $('#TitleCategory > option').each(function() {
                TitleCategoryData[$(this).val()] = $(this).text();
            });
        };
        getTitleCategoryData();
        getAttData();


        var GroupData = {};
        function getmGroup(callback) {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getmGroup",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var targetSelect = $('#mGroup');
                    targetSelect.prop('disabled', false);
                    msg.data.forEach(function(value) {
                        targetSelect.append('<option data-content="<div class=\'label label-success\'>' + value.count + ' 人</div> ' + value.AudienceName + '" value="' + value.Id + '">' + value.AudienceName + '</option>');
                        GroupData[value.Id] = value.AudienceName;
                    });
                    targetSelect.selectpicker('refresh');
                    callback();
                }
            })
        };
        function getCategory(callback) {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getAttItems",
                cache: false,
                data: { mAttachment: '1' },
                async: true,
                dataType: 'json',
                success: function(msg) {
                    mAttachmentParse('1', msg.data);
                    $.ajax({
                        type: 'GET',
                        url: "/BulletinMail_getAttItems",
                        cache: false,
                        data: { mAttachment: '2' },
                        async: true,
                        dataType: 'json',
                        success: function(msg) {
                            mAttachmentParse('2', msg.data);
                            callback();
                        }
                    });
                }
            });
        };
        function getPackageList(callback){
            $.ajax({
                type: 'POST',
                url: "/BulletinMail_ViewPackage",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    mAttachmentParse('6', msg.result);
                    callback();
                }
            });
        };
        var DataForCopy = {};
        var mDataTable = $('#datatable').DataTable({
                "autoWidth": false,
                "order": [
                    [0, "desc"]
                ],
                "columnDefs": [{
                    "targets": [0, 1, 2],
                    "width": "45px"
                }, {
                    "targets": 3,
                    "width": "80px"
                }, {
                    "targets": 4,
                    "width": "30px"
                }, {
                    "targets": [5, 6],
                    "width": "100px"
                }, {
                    "targets": 7,
                    "width": "30px"
                }, {
                    "targets": 8,
                    "width": "300px"
                }, {
                    "targets": 10,
                    "width": "40px"
                }, {
                    "targets": 11,
                    "width": "72px"
                }, {
                    "targets": 12,
                    "width": "125px"
                }]
        });
        function getTableData() {

            var ActionBtn = function(index, key, isSend){
                var EditBtn = '<button type="button" copykey="' + index + '" delekey="' + key + '" class="btn btn-info RowEdit" ' + (isSend != 'N' ? 'disabled' : '') + '><i class="fa fa-pencil" aria-hidden="true"></i> 修改</button>';
                var CopyBtn = '<button type="button" copykey="' + index + '" class="btn btn-success RowCopy"><i class="fa fa-clone" aria-hidden="true"></i> 拷貝</button>';
                var DeleBtn = '<button type="button" delekey="' + key + '" class="btn btn-danger RowDelete" ' + (isSend != 'N' ? 'disabled' : '') + '><i class="fa fa-trash-o" aria-hidden="true"></i> 刪除</button>';
                return '<div class="btn-group btn-group-xs" style="display: flex;">' + EditBtn + CopyBtn + DeleBtn + '</div>';
            };

            var arrayTableData = [];
            $.ajax({
                type: 'POST',
                url: '/BulletinMail_History',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(result) {
                    DataForCopy = result.result;
                    $.each(result.result, function(index, value) {
                        arrayTableData.push([
                            moment(value.ModifyTime).format("YYYY-MM-DD HH:mm:ss"),
                            moment(value.ReserveTime).format("YYYY-MM-DD HH:mm:ss"),
                            ((value.EndTime === null) ? '' : moment(value.EndTime).format("YYYY-MM-DD HH:mm:ss")),
                            GroupData[value.mGroup] == null ? value.ToMemberId : '<span class="label label-default text-ellipsis">' + GroupData[value.mGroup] + '</span>',
                            TitleCategoryData[value.TitleCategory] == null ? "已刪除類別" : TitleCategoryData[value.TitleCategory],
                            '<p class="text-ellipsis">' + value.MailTitle + '</p>',
                            '<p class="text-ellipsis">' + value.MailContent + '</p>',
                            value.mAttachment == null ? '不夾帶' : AttData[value.mAttachment],
                            getAttCategory(value),
                            thousandComma(value.mAttachment == 3 ? value.mQuantity / 100 : value.mQuantity),
                            getStatusHTML(value.IsSend),
                            value.MailType == 'L' ? '<span class="label label-primary">廣告信</span>' : '<span class="label label-default">文字信&amp;禮品信</span>',
                            ActionBtn(index, value.Id, value.IsSend)
                        ]);
                    });
                    mDataTable.clear().draw();
                    mDataTable.rows.add(arrayTableData).draw();
                }
            }).done(function() {
                $('.text-ellipsis').popover({
                    trigger: 'hover',
                    placement: 'top',
                    html: true,
                    content: function() {
                        return $(this).text().replace("\n", "<br />", "g");
                    },
                });
            });
        };

        $('#datatable').on( 'draw.dt', function () {
            $('.text-ellipsis').popover({
                trigger: 'hover',
                placement: 'top',
                html: true,
                content: function() {
                    return $(this).text().replace("\n", "<br />", "g");
                },
            });
        });
        function getStatusHTML(isSend){
            var str = "";
            var icon = "";
            var color = "";

            switch (isSend) {
                case "Y": // 已送出
                    str = "已送出";
                    icon = "check-circle-o";
                    color = "success";
                    break;
                case "N": // 預約中
                    str = "預約中";
                    icon = "clock-o";
                    color = "info";
                    break;
                case "V": // 待審核
                    str = "待審核";
                    icon = "eye";
                    color = "primary";
                    break;
                case "B": // 駁回
                    str = "駁回";
                    icon = "ban";
                    color = "danger";
                    break;
                case "E": // 已失效
                    str = "已失效";
                    icon = "exclamation-triangle";
                    color = "warning";
                    break;
                default:
                    break;
            }
            return '<span class="label label-' + color + '"><i class="fa fa-' + icon + '"></i> ' + str + '</span>'
        };

        function showPackageSelectModal(){
            var modalHTML = '<button class="btn btn-default btn-block btn-lg add-new-pack" style="border-style: dashed;">'
                                + '<i class="fa fa-plus" aria-hidden="true"></i> 新增獎勵組合'
                                + '</button><hr>'
                                + '<div class="container select-package">'
                                + '</div>';
            
            ShowModalBox("選擇或新增獎勵組合", modalHTML, '<div class="btn-group btn-group-lg btn-packselect-action"><button class="btn btn-danger" data-dismiss="modal">取消</button><button id="addPackageToMail" class="btn btn-primary">確定選擇</button></div>');
            viewPackageSelected($('.select-package'), AttItemsData[6]);
        }
        function viewPackageSelected(target, array){
            target.html('');
            var modalHTML = "";
            var reverseArr = [];
            $.each(array, function(index, value) {
                reverseArr.push(value);
            });
            $.each(reverseArr.reverse(), function(index, value) {
                modalHTML += viewPackageData(value);
            });
            target.append(modalHTML);
        }
        function viewPackageData(array, needInput = true){
            var itemArr = JSON.parse(array.ItemJSON);
            if(itemArr != null){
                itemArr = itemArr.sort(function (a, b) {
                    return a.mCategory.localeCompare( b.mCategory );
                });
            }
            var itemHTML = "";
            $.each(itemArr, function(itemIndex, itemVal) {
                itemHTML += '<tr>' + ( itemIndex == 0 ? '<td rowspan="' + itemArr.length + '">' + AttData[1] + '</td>' : '') + '<td>' + getAttCategory({mAttachment: 1, mCategory: itemVal.mCategory}) + '</td><td>' + itemVal.mQuantity + '</td></tr>';
            });
            var chipArr = JSON.parse(array.ChipJSON);
            if(chipArr != null){
                chipArr = chipArr.sort(function (a, b) {
                    return a.mCategory.localeCompare( b.mCategory );
                });
            }
            var chipHTML = "";
            $.each(chipArr, function(chipIndex, chipVal) {
                chipHTML += '<tr>' + ( chipIndex == 0 ? '<td rowspan="' + chipArr.length + '">' + AttData[1] + '</td>' : '') + '<td>' + getAttCategory({mAttachment: 2, mCategory: chipVal.mCategory}) + '</td><td>' + chipVal.mQuantity + '</td></tr>';
            });
            var coinHTML = array.coin == null ? '' : '<tr><td>' + AttData[3] + '</td><td></td><td>' + thousandComma(array.coin / 100) + '</td></tr>';
            var expHTML  = array.exp == null ? '' : '<tr><td>' + AttData[4] + '</td><td></td><td>' + thousandComma(array.exp) + '</td></tr>';
            var html = '';
            console.log(itemArr, chipArr);
            if(needInput){
                html += '<div class="panel panel-default show-pack-table"><div class="panel-heading"><div class="radio">'
                        + '<label for="packageSelect_' + array.id + '">'
                        + '<input class="packageSelect" type="radio" name="packageSelect" id="packageSelect_' + array.id + '" value="' + array.id + '">'
                        + array.Name
                        + '</label></div></div><div class="panel-body">';
            }
            html +='<table class="table table-hover"><thead><tr><td>夾帶類型</td><td>夾帶品項</td><td>數量</td></tr></thead><tbody>'
                  + itemHTML + chipHTML + coinHTML + expHTML
                  + '</tbody></table>';
            if(needInput){
                html += '</div></div>';
            }
            return html; 
        }

        function LinkMemberId() {
            if ($_GET['MemberId'] != null) {
                $('#mGroup').val('single');
                $('#ToMemberId').val($_GET['MemberId']);
                SmartForm();
            }
        }
        getmGroup(function(){
            getCategory(function(){
                getPackageList(function(){
                    getTableData();
                    LinkMemberId();
                });
            });
        });

        // ParseData
        function mAttachmentParse(mAttachment, ParseData) {
            // console.log(value);
            AttItemsData[mAttachment] = {};
            switch (mAttachment) {
                case '1':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ItemId] = {
                            id: value.ItemId,
                            Name: value.ItemName,
                            betLevel: value.betLevel,
                            GameName: value.GameName,
                            multiple: value.multiple,
                            round: value.round,
                            itemType: value.itemType,
                            DataContent: '<span class=\'label label-default\'>' + value.ItemId + '號</span> <span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>Lv-' + value.betLevel + '</span> <span class=\'label label-info\'>' + value.ItemName + '</span> <span class=\'label label-primary\'>' + value.multiple + '倍</span> <span class=\'label label-default\'>' + value.round + '場</span> <span class=\'label label-default\'>' + value.itemType + '</span>'
                        };
                    });
                    break;
                case '2':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ChipId] = {
                            id: value.ChipId,
                            Name: value.ChipName,
                            GameName: value.GameName,
                            MixValue: value.MixValue,
                            DataContent: '<span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>' + value.ChipName + '</span> <span class=\'label label-info\'>' + value.MixValue + '</span> <span class=\'label label-default\'>' + value.SellValue + '</span>'
                        };
                    });
                    break;
                case '6':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.PackageId] = {
                            id: value.PackageId,
                            Name: value.PackageName,
                            ChipJSON: value.ChipJSON,
                            ItemJSON: value.ItemJSON,
                            coin: value.MoneyAmount,
                            exp: value.ExpAmount,
                            DataContent: `<button class="btn btn-default btn-block show-pack-data" data-packid="${value.PackageId}">顯示獎勵組合</button>`
                        };
                    });
                    break;
            }
        };

        // Other GET / POST
        var AttItemsData = {};
        function ItemsDataOption(mCategory, mAttachment, Selected = 'none') {
            switch (mAttachment) {
                case '1':
                    mCategory.children('option').not('[value="none"]').remove();
                    $.each(AttItemsData[mAttachment], function(index, value) {
                        var data_tokens = value.id + ' ' + value.GameName + ' ' + value.betLevel + ' ' + value.Name + ' ' + value.multiple + ' ' + value.round + ' ' + value.itemType;
                        mCategory.append(`<option value="${value.id}" data-tokens="${data_tokens}" data-content="${value.DataContent}">${value.Name}</option>`);
                    });
                    break;
                case '2':
                    mCategory.children('option').not('[value="none"]').remove();
                    $.each(AttItemsData[mAttachment], function(index, value) {
                        var data_tokens = value.GameName + ' ' + value.Name + ' ' + value.MixValue + ' ' + value.SellValue;
                        mCategory.append(`<option value="${value.id}" data-tokens="${data_tokens}" data-content="${value.DataContent}">${value.Name}</option>`);
                    });
                    break;
            }
            mCategory.find('option[value="' + Selected + '"]').prop('selected', true);
        }

        function SmartForm() {
            var mAttachment_val = $('#mAttachment').val().toString();
            var mCategory_val = $('#mCategory').val().toString();
            var MailTitle_val = $('#MailTitle').val().toString();
            var mGroup_val = $('#mGroup').val().toString();
            var ToMemberId_val = $('#ToMemberId').val().toString();

            AttachmentSmartForm($('#mAttachment'), $('#mCategory'), $('#mQuantity'));

            if (mGroup_val == "single") {
                $('#ToMemberIdGroup').removeClass('hidden');
                $('#ToMemberId').prop('disabled', false);
            } else {
                $('#ToMemberIdGroup').addClass('hidden');
                $('#ToMemberId').prop('disabled', true);
            }

            var checkTitle  = MailTitle_val.length < 1;
            var checkGroup  = mGroup_val == 'single' && ToMemberId_val.length < 5 || mGroup == 'none';
            var checkAtt    = (mAttachment_val == '1' || mAttachment_val == '2') && (mCategory_val == 'none' || $('#mQuantity').val() < 1);
            var chackPack   = mAttachment_val == '6' && $('#packkey').val().length < 1;

            var disabledSand = ( checkGroup || checkTitle || checkAtt || chackPack);
            $('#SendMail').prop('disabled', disabledSand);
        }

        function AttachmentSmartForm(mAttachment, mCategory, mQuantity, isNewadd = false){
            var mCategory_val = mCategory.val().toString();
            var mAttachment_val = mAttachment.val().toString();
            // console.log(mAttachment_val, mCategory_val);
            $('.GiftPackBtn').addClass('hide');
            $('#packkey').prop('disabled', true);

            switch (mAttachment_val) {
                case '1':
                    mCategory.prop('disabled', false);
                    mQuantity.prop('max', '99').SmartQuantity(mCategory_val == 'none');
                    break;
                case '2':
                    mCategory.prop('disabled', false);
                    mQuantity.prop('max', '99').SmartQuantity(mCategory_val == 'none');
                    break;
                case '3':
                    mCategory.prop('disabled', true).find('[value="none"]').prop('selected', true);;
                    mQuantity.prop('max', '100000000').SmartQuantity(false);
                    break;
                case '4':
                    mCategory.prop('disabled', true).find('[value="none"]').prop('selected', true);;
                    mQuantity.removeAttr('max').SmartQuantity(false);
                    break;
                case '6':
                    mCategory.prop('disabled', true).find('[value="none"]').prop('selected', true);;
                    mQuantity.removeAttr('max').SmartQuantity(true);
                    $('.GiftPackBtn').removeClass('hide');
                    $('#packkey').prop('disabled', false);
                    break;
                case '7':
                    mCategory.prop('disabled', true).find('[value="none"]').prop('selected', true);;
                    mQuantity.prop('max', '100000000').SmartQuantity(false);
                    break;
                default:
                    mCategory.prop('disabled', true).find('[value="none"]').prop('selected', true);;
                    mQuantity.removeAttr('max').SmartQuantity(true);
                    break;
            }
            if(isNewadd){
                mCategory.selectpicker({
                    liveSearch: true,
                    showTick: true,
                    showContent: true,
                    liveSearchNormalize: true
                });
                mCategory.selectpicker('refresh');
            } else {
                mCategory.selectpicker('refresh');
            }
        }

        jQuery.fn.SmartQuantity = function(bool){
            if(bool){
                $(this).prop('disabled', true);
                $(this).val('0');
                // $(this).next().val('0');
            } else {
                $(this).prop('disabled', false);
                $(this).val($(this).val() > 1 ? $(this).val() : "1");
                // $(this).next().val(thousandComma($(this).val() > 1 ? $(this).val() : "1"));
            }
        }

        function InsertDataValue() {
            var Service = $('#Service').val();
            var Action = $('#Action').val();
            var ParameterData = "";

            switch (Service) {
                case "GameService":
                    ParameterData = $('#ParameterGame').val();
                    break;
                case "LobbyService":
                    ParameterData = $('#ParameterLobbyOpen').val();
                    break;
                case "WebService":
                    ParameterData = $('#ParameterURL').val();
                    break;
            }

            var DataVaule = Service + '/' + Action + '/' + ParameterData;
            $('#DataOutput').val(DataVaule);
        }

        function ServiceSmartFrom(Service) {
            switch (Service) {
                case "GameService":
                    $('#ParameterGame').selectpicker('show');
                    $('#ParameterLobbyOpen').selectpicker('hide');
                    $('#ParameterURL').addClass('hide');
                    $('#Action').find('option').not('[value=opengame], [value=deletegame]').prop({
                        'disabled': true,
                        'selected': false,
                    });
                    $('#Action').find('option[value=opengame], option[value=deletegame]').prop({
                        'disabled': false,
                        'selected': false
                    });
                    break;
                case "LobbyService":
                    $('#ParameterGame').selectpicker('hide');
                    $('#ParameterLobbyOpen').selectpicker('show');
                    $('#ParameterURL').addClass('hide');
                    $('#Action').find('option').not('[value=OpenView]').prop({
                        'disabled': true,
                        'selected': false,
                    });
                    $('#Action').find('option[value=OpenView]').prop({
                        'disabled': false,
                        'selected': true,
                    });
                    break;
                case "WebService":
                    $('#ParameterGame').selectpicker('hide');
                    $('#ParameterLobbyOpen').selectpicker('hide');
                    $('#ParameterURL').removeClass('hide');
                    $('#Action').find('option').not('[value=OpenWebView]').prop({
                        'disabled': true,
                        'selected': false,
                    });
                    $('#Action').find('option[value=OpenWebView]').prop({
                        'disabled': false,
                        'selected': true,
                    });
                    break;
            }
        }

        function MailTypeSmartFrom() {
            if ($('[name="MailType"]:checked').val().toString() == "N") {
                $('.GeneralMail').show();
                $('.adMail').hide();
            } else {
                $('.adMail').show();
                $('.GeneralMail').hide();
                InsertDataValue();
            }
        }

        function CopyParameterData(Service, ParameterData) {
            $('#ParameterGame').val('');
            $('#ParameterLobbyOpen').val('');
            $('#ParameterURL').val('');

            switch (Service) {
                case "GameService":
                    $('#ParameterGame').selectpicker('val', ParameterData);
                    break;
                case "LobbyService":
                    $('#ParameterLobbyOpen').selectpicker('val', ParameterData);
                    break;
                case "WebService":
                    $('#ParameterURL').val(ParameterData);
                    break;
            }
            $('#ParameterLobbyOpen').selectpicker('refresh');
            $('#ParameterGame').selectpicker('refresh');

            InsertDataValue();
        }

        function showReciprocal(target, totaltime){
            if(totaltime > 0){
                if(target.find('.reciprocal').length < 1){
                    target.append('<span class="reciprocal" time="' + totaltime + '">(' + totaltime + ')</span>');
                } else {
                    var nowTime = Number(target.find('.reciprocal').attr('time'));
                    target.find('.reciprocal').attr('time', nowTime-1).text(('(' + (nowTime-1) + ')'));
                }
            } else {
                target.find('.reciprocal').remove();
            }
        }

        function packageSelected() {
            $.each($('.select-package > .show-pack-table'), function(index, element) {
                if($(element).find('input.packageSelect').prop('checked')){
                    $(element).addClass('panel-primary').removeClass('panel-default');
                } else {
                    $(element).addClass('panel-default').removeClass('panel-primary');
                }
            });
        }

        function getAttCategory(array){
            if(array.mCategory != null){
                if(AttItemsData[array.mAttachment][array.mCategory] == null || AttItemsData[array.mAttachment] == null){
                    mCategory = `<span class="label label-danger">品項不存在: ${array.mCategory}</span>`;
                } else {
                    mCategory = `<div class="text-nowrap">${AttItemsData[array.mAttachment][array.mCategory].DataContent}</div>`;
                }
            } else {
                mCategory = '';
            }
            return mCategory
        }

        // document Event
        $(document).on('change focus keyup', '#mGroup, #MailTitle, #mCategory, #ToMemberId, #MailContent', SmartForm);

        $(document).on('change', '[name="MailType"]', MailTypeSmartFrom);

        $(document).on('change focus keyup', '#Service, #ParameterGame, #ParameterLobbyOpen, #ParameterURL', InsertDataValue);

        $(document).on('change', '#mAttachment', function(event) {
            var mAttachment = $(this).val().toString();
            ItemsDataOption($('#mCategory'), mAttachment);
            SmartForm();
        });

        $(document).on('click', '#SendMail', function(event) {
            var confirmAlert = false;
            var nuix_reserveTime = moment($('#ReserveTime').val(), "YYYY-MM-DD HH:mm:ss").unix();
            var nuix_endTime = $('#EndTime').val() == "" ? "" : moment($('#EndTime').val(), "YYYY-MM-DD HH:mm:ss").unix();
            var nuix_nowTime = moment().unix();
            var check_reserveTime = (nuix_reserveTime > nuix_nowTime);
            var check_endTime = (nuix_endTime > nuix_reserveTime + 3600) || nuix_endTime == "";

            if (nuix_reserveTime - nuix_nowTime < 300) {
                confirmAlert = confirm("預約時間與現在時間相差過短，預約後可能無法刪除，確定要新增？");
            } else {
                confirmAlert = confirm("確定新增？");
            }

            var mAttachment = $('#mAttachment').val();
            var mQuantity = mAttachment == 3 ? $('#mQuantity').val() * 100 : $('#mQuantity').val();
            var MailType = $('input[name="MailType"]:checked').val();
            var postData = {
                MailType: MailType,
                mGroup: $('#mGroup').val(),
                ToMemberId: $('#mGroup').val() == 'single' ? $('#ToMemberId').val() : null,
                mAttachment: mAttachment,
                mCategory: mAttachment == 6 ? $('#packkey').val() : $('#mCategory').val(),
                mQuantity: mQuantity,
                ReserveTime: $('#ReserveTime').val(),
                EndTime: $('#EndTime').val(),
                TitleCategory: $('#TitleCategory').val(),
                MailTitle: $('#MailTitle').val(),
                MailContent: $('#MailContent').val(),
                Note: $('MailNote').val()
            };

            if(confirmAlert && check_reserveTime && check_endTime){
                $.ajax({
                    type: 'POST',
                    url: "/BulletinMail_AddSystemMail",
                    data: postData,
                    cache: false,
                    async: true,
                    dataType: 'json',
                    success: function(result) {
                        if (result.code == "0") {
                            getTableData();

                            if($('.refresh-table .reciprocal').length == 0){
                                var timeShow = setInterval(function(){ showReciprocal($('.refresh-table'), 60); }, 1000);
                                setTimeout(function(){ getTableData(); showReciprocal($('.refresh-table'), -1); clearInterval(timeShow); }, 60000);
                            }

                            QuickNotify('新增成功！', 'success');
                        } else {
                            QuickNotify(`新增失敗，資料庫連線異常或收件對象「${postData.ToMemberId}」不存在`, 'danger');
                        }
                    },
                    error: function() {
                        QuickNotify('新增失敗，連線錯誤。', 'danger');
                    }
                });
            } else {
                if(!check_reserveTime){
                    QuickNotify('新增失敗，預約送信時間在現在時間之前。', 'danger');
                }
                if(!check_endTime){
                    QuickNotify('新增失敗，失效時間與預約時間隔過短（60分鐘）或早於預約時間。', 'danger');
                }
            }
        });

        $(document).on('click', '.RowCopy', function(event) {
            var CopyData = DataForCopy[$(this).attr('copykey')];
            dataCopy(CopyData);
        });

        function dataCopy(CopyData){
            if (DataForCopy == null || CopyData == null) {
                QuickNotify('資料錯誤，請重新整理', 'danger');
            } else {
                $('#mGroup').selectpicker('val', CopyData.mGroup == null ? 'single' : CopyData.mGroup);
                $('#ToMemberId').val(CopyData.mGroup == null ? CopyData.ToMemberId : '');
                $('#MailTitle').val(CopyData.MailTitle);
                $('#TitleCategory').val(CopyData.TitleCategory);

                $('input[name="MailType"]').prop('checked', false);
                $('input[name="MailType"][value="' + CopyData.MailType + '"]').prop('checked', true);
                $('input[name="MailType"]').parent().removeClass('active');
                $('input[name="MailType"][value="' + CopyData.MailType + '"]').parent().addClass('active');

                MailTypeSmartFrom();

                switch (CopyData.MailType) {
                    case 'N':
                        $('#mAttachment').selectpicker('val', CopyData.mAttachment);
                        $('#mAttachment').val(CopyData.mAttachment);
                        $('#MailContent').val(CopyData.MailContent);
                        ItemsDataOption($('#mCategory'), CopyData.mAttachment.toString(), CopyData.mCategory != null ? CopyData.mCategory : 'none');
                        $('#mQuantity').val(CopyData.mAttachment == 3 ? CopyData.mQuantity / 100 : CopyData.mQuantity);

                        if(CopyData.mAttachment == 6){
                            var selectPackage = Number(CopyData.mCategory);
                            $('#packname').val(AttItemsData[6][selectPackage].Name);
                            $('#packkey').val(selectPackage);
                            $('.GiftPackBtn .show-pack-data').attr('data-packid', selectPackage);
                        }

                        break;
                    case 'L':
                        var ContentToArray = CopyData.MailContent.split("/");
                        var Service = ContentToArray[0];
                        var Action = ContentToArray[1];
                        var ParameterData = CopyData.MailContent.replace(Service + '/' + Action + '/', "");

                        $('#Service').selectpicker('val', Service);
                        ServiceSmartFrom(Service);
                        $('#Action').selectpicker('val', Action);
                        CopyParameterData(Service, ParameterData);
                        break;
                    default:
                        QuickNotify('資料錯誤，請重新整理', 'danger');
                        break;
                }
            }
            SmartForm();
            QuickNotify('複製完成', 'success');
        }

        $(document).on('click', '.RowEdit', function(event) {
            var confirmAlert = confirm("按下確定後會先刪除原本資料，然後將資料拷貝到上方的新增欄位，確定要修改？");
            if (confirmAlert) {
                var thisRow = $(this);
                var CopyData = DataForCopy[$(this).attr('copykey')];
                $.ajax({
                    url: 'BulletinMail_Delete',
                    type: 'POST',
                    dataType: 'json',
                    data: { delekey: $(this).attr('delekey') },
                })
                .done(function(result) {
                    console.log(result.code);
                    if(result.code == 1){
                        mDataTable.row(thisRow.parents('tr')).remove().draw();
                        QuickNotify('信件已經刪除！', 'success');
                        dataCopy(CopyData);
                    } else {
                        QuickNotify('刪除失敗！該信件可能已經送出，請重新整理頁面！', 'danger');
                    }
                })
                .fail(function() {
                    QuickNotify('連線發生問題，刪除失敗！', 'danger');
                });
            } else {}
        });

        $(document).on('click', '.RowDelete', function(event) {
            var confirmAlert = confirm("確定要刪除？");
            if (confirmAlert) {
                var thisRow = $(this);
                $.ajax({
                    url: 'BulletinMail_Delete',
                    type: 'POST',
                    dataType: 'json',
                    data: { delekey: $(this).attr('delekey') },
                })
                .done(function(result) {
                    console.log(result.code);
                    if(result.code == 1){
                        mDataTable.row(thisRow.parents('tr')).remove().draw();
                        QuickNotify('信件已經刪除！', 'success');
                    } else {
                        QuickNotify('刪除失敗！該信件可能已經送出，請重新整理頁面！', 'danger');
                    }
                })
                .fail(function() {
                    QuickNotify('連線發生問題，刪除失敗！', 'danger');
                });
            } else {}
        });

        $(document).on('change', '#Service', function(event) {
            var Service = $(this).val();
            ServiceSmartFrom(Service);
            $('#Action');
        });

        $(document).on('change keyup keydown focus click', '#mQuantity, .mQuantity', function(event) {
            var maxValue = Number($(this).attr('max'));
            var getValue = Number($(this).val());
            previewThousandComma($(this), getValue);
            if(maxValue != null){
                if (getValue > maxValue) {
                    QuickNotify(`數量超出系統容許大小：${thousandComma(maxValue)}。\n已自動將數值降至容許最大值。`, 'warning');
                    $(this).val(maxValue);
                    previewThousandComma($(this), maxValue);
                }
            }
        });

        var giftPackDataChacker = []; // 判斷禮物組合是否有重複用
        $(document).on('change', 'select.mAttachment, select.mCategory, input.mQuantity', function(event) {
            var mCategory = $(this).parents('tr').find('select.mCategory');
            var mAttachment = $(this).parents('tr').find('select.mAttachment');
            var mQuantity = $(this).parents('tr').find('.mQuantity');
            var addBtn = $(this).parents('tr').find('.btn-success');

            if ($(this).hasClass('mAttachment')) {
                ItemsDataOption(mCategory, mAttachment.val().toString());
            }
            var checkAtt = (mAttachment.val().toString() == '1' || mAttachment.val().toString() == '2') && mCategory.val().toString() == 'none' || mAttachment.val().toString() == 0;
            addBtn.prop('disabled', checkAtt);

            AttachmentSmartForm(mAttachment, mCategory, mQuantity, true);
        });

        var giftPackData = []; // 禮物組合Array
        $(document).on('click', '.add-item-to-pack .btn-success', function(event) {
            event.preventDefault();
            var mAttachment = $(this).parents('tr').find('select.mAttachment');
            var mCategory = $(this).parents('tr').find('select.mCategory');
            var mQuantity = $(this).parents('tr').find('.mQuantity');
            var chackData = mAttachment.val() + '/' + mCategory.val();

            if(giftPackDataChacker.indexOf(chackData) == -1){
                giftPackData.push({ mAttachment: mAttachment.val(),
                                    mCategory: mCategory.val(),
                                    mQuantity: mQuantity.val() });
                addGiftPackData($(this).parents('table').find('tbody'), mAttachment, giftPackData);
            } else {
                QuickNotify('重複的項目', 'warning');
            }
        });
        function addGiftPackData(target, lockTarget, array) {
            target.html('');
            giftPackDataChacker = [];
            $.each(array.slice().reverse(), function(index, value) {
                var chackData = value.mAttachment + '/' + value.mCategory;
                giftPackDataChacker.push(chackData);

                var delBtn = `<button class="btn btn-danger" data-id="${index}"><i class="fa fa-trash"></i></button>`;
                var mCategory = '';
                if(value.mCategory != 'none'){
                    mCategory = `<div class="text-nowrap">${AttItemsData[value.mAttachment][value.mCategory].DataContent}</div>`;
                } else {
                    mCategory = '';
                }
                target.append(`<tr><td>${delBtn}</td><td>${AttData[value.mAttachment]}</td><td>${mCategory}</td><td>${thousandComma(value.mQuantity)}</td></tr>`);
            });
            lockTarget.selectpicker('val', '0');
        };
        $(document).on('click', '.add-item-to-pack .btn-danger', function(event) {
            event.preventDefault();
            var dataId = $(this).attr('data-id');
            var mAttachment = $(this).parents('table').find('thead > tr select.mAttachment');

            giftPackData.splice(dataId, 1);
            addGiftPackData($(this).parents('table').find('tbody'), mAttachment, giftPackData);
        });

        var addData = {};
        $(document).on('click', '.btn-addpack-action > .btn-primary', function(event) {
            event.preventDefault();
            var packname = $(this).parents('.modal-content').find('input.packname');
            var packnameMin = Number(packname.attr('minlength'));
            addData = {};

            if(giftPackData.length <= 1 || packname.val().length < packnameMin){
                if(giftPackData.length <= 1){
                    if(giftPackData.length == 1){
                        QuickNotify('單一品項目無法新增，請利用單項目夾帶功能。', 'warning');
                    } else {
                        QuickNotify('請選擇夾帶項目', 'danger');
                    }
                }
                if(packname.val().length < packnameMin){
                    QuickNotify('獎勵組合名稱不得為空或字數過多', 'danger');
                }
            } else {
                var insertData = {};
                $.each(giftPackData, function(index, value) {
                    if(value.mAttachment < 3){
                        if(addData[value.mAttachment] == null){
                            addData[value.mAttachment] = new Array();
                        }
                        addData[value.mAttachment].push(value);
                    } else {
                        addData[value.mAttachment] = value.mAttachment == 3 ? value.mQuantity * 100 : value.mQuantity;
                    }
                });
                $.each(addData, function(index, value) {
                    insertData[parseKey[index]] = index < 3 ? JSON.stringify(value) : value;
                });
                insertData['PackageName'] = packname.val();
                var confirmAlert = confirm("確定新增？");
                if(confirmAlert){
                    $.ajax({
                        type: 'POST',
                        url: "/BulletinMail_AddPackage",
                        data: insertData,
                        dataType: 'json',
                        success: function(result) {
                            if (result.code == "0") {
                                QuickNotify('新增成功！', 'success');
                                getPackageList(function(){
                                    viewPackageSelected($('.select-package'), AttItemsData[6]);
                                    $('#bs-modal-box-9999').modal('hide');
                                });
                            } else {
                                QuickNotify('新增失敗', 'danger');
                            }
                        },
                        error: function() {
                            QuickNotify('新增失敗', 'danger');
                        }
                    });
                }
            }
        });
        $(document).on('click', '.btn-addpack-action > .btn-danger', function(event) {
            event.preventDefault();
            var packname = $(this).parents('.modal-content').find('input.packname');
            var packnameMin = Number(packname.attr('minlength'));
            if(giftPackData.length <= 1 && packname.val().length < packnameMin){
                $('#bs-modal-box-9999').modal('hide');
            } else {
                var confirmAlert = confirm("若取消選擇的資料將會被刪除，確定要取消？");
                if(confirmAlert){
                    addData = {};
                    $('#bs-modal-box-9999').modal('hide');
                }
            }
        });
        $(document).on('click', '.refresh-table', getTableData);

        $(document).on('change', 'input.packageSelect', packageSelected);
        $(document).on('click', '#addPackageToMail', function(event) {
            event.preventDefault();
            var selectPackage = Number($('input.packageSelect:checked').val());
            $('#packname').val(AttItemsData[6][selectPackage].Name);
            $('#packkey').val(selectPackage);
            $('#bs-modal-box-999').modal('hide');
            $('.GiftPackBtn .show-pack-data').attr('data-packid', selectPackage);
        });
        $(document).on('click', '.clear-select-pack', function(event) {
            event.preventDefault();
            $('#packname').val('');
            $('#packkey').val('');
            $('.GiftPackBtn .show-pack-data').attr('data-packid', '');
        });
        $(document).on('click', '.show-add-pack', showPackageSelectModal);
        $(document).on('click', '.add-new-pack', function(event) {
            event.preventDefault();
            var modalHTML =    `<table class="table table-hover add-item-to-pack">
                                    <caption>
                                        <div class="input-group">
                                            <span class="input-group-addon">獎勵組合名稱</span>
                                            <input type="text" class="form-control packname" minlength="3" maxlength="20">
                                        </div>
                                    </caption>
                                    <thead>
                                        <tr>
                                            <td><button class="btn btn-success" disabled><i class="fa fa-plus" aria-hidden="true"></i></button></td>
                                            <td>
                                                <div class="form-group">
                                                    <select class="form-control mAttachment">
                                                        <option value="0" selected>不夾帶</option>
                                                        <option value="1">卡片</option>
                                                        <option value="2">碎片</option>
                                                        <option value="3">金錢</option>
                                                     // <option value="4" style="display: none;">經驗值</option>
                                                    </select>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="form-group">
                                                    <select class="form-control mCategory" disabled="">
                                                        <option value="none">請選擇品項</option>
                                                    </select>
                                                </div>
                                            </td>
                                            <td>
                                                <div class="form-group">
                                                    <input type="number" class="form-control mQuantity text-right" min="1" inputmode="numeric" disabled>
                                                </div>
                                            </td>
                                        </tr>
                                    </thead>
                                    <tbody>
                                    </tbody>
                                    <tfoot>
                                        <tr>
                                            <td></td>
                                            <td>夾帶類型</td>
                                            <td>夾帶品項</td>
                                            <td>數量</td>
                                        </tr>
                                    </tfoot>
                                </table>`;

            ShowModalBox("選擇或新增獎勵組合", modalHTML, '<div class="btn-group btn-group-lg btn-addpack-action"><button class="btn btn-danger">取消</button><button class="btn btn-primary">確定新增</button></div>', 9999);
            $('.mAttachment').selectpicker('render');
        });
        $(document).on('click', '.show-pack-data', function(event) {
            event.preventDefault();
            var packId = $(this).attr('data-packid');
            if (packId != ""){
                var packageArr = AttItemsData[6][packId];
                var modalHTML = viewPackageData(packageArr, false);
                var modalTitle = `<span class="label label-default">獎勵組合</span> ${packageArr.Name}`;
                ShowModalBox(modalTitle, modalHTML);
            } else {
                QuickNotify("沒有選擇任何獎勵組合", "warning");
            }
        });

        $('input[name="EndTime"]').on('apply.daterangepicker', function(ev, picker) {
            $(this).val(picker.startDate.format('YYYY-MM-DD HH:mm:ss'));
        });

        $('input[name="EndTime"]').on('cancel.daterangepicker', function(ev, picker) {
            $(this).val('');
        });

        // 多重視窗相容性
        $(document).on('hidden.bs.modal', function (event) {
            if($('.modal:visible').length) {
                $('body').addClass('modal-open');
            }
        });

        $(document).on('show.bs.modal', function (event) {
            var modalLength = $('.modal').length;
            $.each($('.modal').get().reverse(), function(index, element) {
                var new_zindex = 1050 - (index * 20);
                $(element).css('z-index', new_zindex);
                $(element).next('.modal-backdrop').css('z-index', new_zindex - 15);
            });
        });
    });
    </script>
</body>

</html>