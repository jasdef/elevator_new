<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
    <!-- bootstrap-daterangepicker -->
    <link href="../vendors/bootstrap-daterangepicker/daterangepicker.css" rel="stylesheet">
    <!-- bootstrap-select -->
    <link rel="stylesheet" href="../vendors/bootstrap-select/css/bootstrap-select.min.css">
    <link href="../vendors/bootstrap-notify/animate.min.css" rel="stylesheet">
    <style type="text/css" media="screen">
    .popover {
        max-width: 700px;
    }

    .form-control[readonly] {
        background-color: transparent;
    }

    .text-ellipsis {
        /*width: 200px;*/
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        margin: 0;
    }

    #datatable tbody td {
        vertical-align: middle;
        overflow: hidden;
    }
    #datatable td:nth-child(4) span.label {
        display: block;
    }

    #datatable tbody td:nth-child(10) {
        text-align: right;
    }

    #datatable {
        table-layout: fixed;
    }
    .modal td span{
        line-height: 1.42857143;
    }
    .modal input{
        border-radius: .25em;
    }
    .modal table.add-item-to-pack td{
        vertical-align: middle;
    }
    .modal table.add-item-to-pack td .form-group,
    .modal table.add-item-to-pack td .btn
    {
        margin: 0;
    }
    .modal table.add-item-to-pack tbody > tr > td:nth-child(n+2),
    .modal table.add-item-to-pack tfoot > tr > td:nth-child(n+2){
        padding-left: 22px;
    }
    .modal table.add-item-to-pack td:nth-child(1){
        width: 40px;
    }
    .modal table.add-item-to-pack td:nth-child(2){
        width: 250px;
    }
    .modal table.add-item-to-pack td:nth-child(3){
        width: 280px;
    }
    .modal table.add-item-to-pack tbody td:last-child,
    .modal table.add-item-to-pack tfoot td:last-child{
        text-align: right;
        padding-right: 36px;
    }
    .modal table.add-item-to-pack caption{
        padding: 3px 8px;
    }
    .modal .dropdown-menu{
        margin-top: 0px;
        margin-left: -1px;
    }
    .dropdown-menu>li>a{
        padding: 6px 20px;
    }
    .bootstrap-select.btn-group.show-tick .dropdown-menu li.selected a span.check-mark{
        top: 0;
        line-height: 29px;
        margin-top: 0;
    }
    .alert h5{
        margin: 0 0 0 15px;
        font-size: 1.3em;
    }
    .alert i{
        margin-right: 5px;
    }
    .form-group p{
        margin-bottom: 0;
    }
    td .btn-block{
        margin-bottom: 0;
    }
    .show-pack-table tr td:first-child{
        width: 20%;
    }
    .show-pack-table tr td:last-child{
        width: 30%;
        text-align: right;
    }
    .show-pack-table .radio,
    .show-pack-table .table{
        margin: 0;
    }
    #datatable_wrapper > .row {
        overflow: visible!important;
    }
    </style>
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row hide">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>發送系統信</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <div class="col-md-12 col-sm-12 col-xs-12">
                                        <div class="col-lg-3 col-md-6 col-xs-12">
                                            <div class="panel panel-default">
                                                <div class="panel-body">
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">受眾*</label>
                                                        <select name="mGroup" id="mGroup" class="form-control" disabled="">
                                                            <option class="default-option" value="none" selected>請選擇受眾</option>
                                                            <option class="default-option" value="single">單一會員</option>
                                                        </select>
                                                        <p class="help-block">*必選項目</p>
                                                    </div>
                                                    <div class="form-group hidden" id="ToMemberIdGroup">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必填項目，請輸入會員ID，請勿輸入會員姓名">會員ID* <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="ToMemberId" id="ToMemberId" class="form-control" value="" disabled="">
                                                        <p class="help-block">*必選項目</p>
                                                    </div>
                                                    <div class="form-group GeneralMail">
                                                        <label class="control-label">夾帶類型</label>
                                                        <select name="mAttachment" id="mAttachment" class="form-control">
                                                            <option value="0" selected>不夾帶</option>
                                                            <option value="1" data-col="ItemJSON">卡片</option>
                                                            <option value="2" data-col="ChipJSON">碎片</option>
                                                            <option value="3" data-col="MoneyAmount">金錢</option>
                                                            <option value="4" data-col="ExpAmount">經驗值</option>
                                                            <option value="7" data-col="Gem">寶石</option>
                                                            <option value="6">獎項組合</option>
                                                        </select>
                                                    </div>
                                                    <div class="form-group GeneralMail">
                                                        <label class="control-label">數量</label>
                                                        <input type="number" id="mQuantity" class="form-control text-center" name="mQuantity" disabled="" value="0" min="1" style="font-size: 20px;" inputmode="numeric">
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="若時間設定為現在時間或更早的時間將於1分鐘內寄出信件">預約送信時間 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="ReserveTime" id="ReserveTime" class="form-control" value="" readonly="true" />
                                                    </div>
                                                    <div class="form-group">
                                                        <label class="control-label" data-toggle="tooltip" data-placement="right" title="必須大於預約送信日並預留足夠時間讓玩家開啟信件">信件失效時間 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                        <input type="text" name="EndTime" id="EndTime" class="form-control" value="" readonly="true" />
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-6 col-md-12 col-xs-12">
                                            <div class="col-md-12">
                                                <div class="form-group">
                                                    <div class="row">
                                                        <div class="col-sm-3">
                                                            <label class="control-label" data-toggle="tooltip" data-placement="right" title="必選項目">信件類別</label>
                                                            <select id="TitleCategory" class="form-control" required="required">
                                                                <option value="MAIL_CATEGORY_ANNOUNCE">系統公告</option>
                                                                <option value="MAIL_CATEGORY_EVENT">營運活動</option>
                                                                <option value="MAIL_CATEGORY_PRIZE">得獎通知</option>
                                                                <option value="MAIL_CATEGORY_TEMP">臨時公告</option>
                                                                <option value="MAIL_CATEGORY_RANK">排行榜獎勵</option>
                                                                <option value="MAIL_CATEGORY_LEVEL">等級獎勵</option>
                                                            </select>
                                                        </div>
                                                        <div class="col-sm-9">
                                                            <label class="control-label" data-toggle="tooltip" data-placement="right" title="必填項目">信件主旨*</label>
                                                            <input type="text" name="MailTitle" id="MailTitle" class="form-control length-input" value="" maxlength="20">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="form-group GeneralMail">
                                                    <label class="control-label">信件內容</label>
                                                    <textarea name="MailContent" id="MailContent" class="form-control length-input" rows="17" required="required" maxlength="1000"></textarea>
                                                    <label class="control-label" data-toggle="tooltip" data-placement="right" title="非必填項目，僅供查核用前端不會顯示">備註 <i class="fa fa-info-circle" aria-hidden="true"></i></label>
                                                    <input type="text" name="MailNote" id="MailNote" class="form-control length-input" rows="17" required="required" maxlength="50">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>審核列表</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <button class="btn btn-primary pull-right btn-sm refresh-table"><i class="fa fa-refresh" aria-hidden="true"></i> 刷新列表</button>
                                    <table id="datatable" class="table table-striped table-bordered table-hover">
                                        <thead>
                                            <tr>
                                                <th title="異動時間">異動<br/>時間</th>
                                                <th title="送出時間">送出<br/>時間</th>
                                                <th title="失效時間">失效<br/>時間</th>
                                                <th title="受眾選擇/會員ID"><span class="label label-default">受眾選擇</span> / 會員ID</th>
                                                <th title="信件類別">信件<br/>類別</th>
                                                <th title="信件主旨">信件主旨</th>
                                                <th title="信件內容">信件內容</th>
                                                <th title="夾帶類型">夾帶類型</th>
                                                <th title="品項">品項</th>
                                                <th title="數量">數量</th>
                                                <th title="動作">動作</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>


    
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <script src="../vendors/moment/min/moment.min.js"></script>
    <script src="../vendors/bootstrap-daterangepicker/daterangepicker.js"></script>
    <!-- bootstrap-select -->
    <script src="../vendors/bootstrap-select/js/bootstrap-select.min.js"></script>
    <script src="../vendors/bootstrap-select/js/i18n/defaults-zh_TW.min.js"></script>
    <!-- bootstrap-notify -->
    <script src="../vendors/bootstrap-notify/bootstrap-notify.min.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {
        function thousandComma(number){
            var num = number == null ? '0' : number.toString();
            var pattern = /(-?\d+)(\d{3})/;
            while(pattern.test(num)){
                num = num.replace(pattern, "$1,$2");
            }
            return num;
        };

        function QuickNotify(message, type) {
            var icon = "";
            switch(type) {
                case 'success':
                    icon = 'fa-check-circle';
                    break;
                case 'danger':
                    icon = 'fa-times-circle';
                    break;
                default: 
                    icon = 'fa-exclamation-triangle';
            }
            $.notify({
                message: '<h5><i class="fa ' + icon + '"></i> ' + message + '</h5>'
            },{
                type: type,
                z_index: 20000,
                delay: 6000,
            });
        }

        function ShowModalBox(Title, Content, footer, zindex = '999') {
            $('#bs-modal-box-' + zindex).remove();
            var html =
                '<div id="bs-modal-box-' + zindex + '" class="modal fade" tabindex="' + zindex + '" role="dialog">' +
                '<div class="modal-dialog modal-lg" role="document">' +
                '<div class="modal-content">' +
                '<div class="modal-header">' +
                '<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>' +
                '<h4 class="modal-title"></h4>' +
                '</div>' +
                '<div class="modal-body" style="display:flow-root">' +
                '<p></p>' +
                '</div>' +
                (footer == null ? '' : '<div class="modal-footer">' + footer + '</div>') +
                '</div>' +
                '</div>' +
                '</div>';
            $('body').append(html);
            $('#bs-modal-box-' + zindex + ' h4.modal-title').html(Title);
            $('#bs-modal-box-' + zindex + ' div.modal-body').html(Content);
            $('#bs-modal-box-' + zindex).modal('show');
        }

        $('[data-toggle="tooltip"]').tooltip();

        var AttData = {};
        var AttDisabled = [];
        var parseKey = [];
        function getAttData() {
            $('#mAttachment > option').each(function() {
                AttData[$(this).val()] = $(this).text();
                AttDisabled[$(this).val()] = false;
                parseKey[$(this).val()] = $(this).attr('data-col');
            });
        };
        var TitleCategoryData = {};
        function getTitleCategoryData() {
            $('#TitleCategory > option').each(function() {
                TitleCategoryData[$(this).val()] = $(this).text();
            });
        };
        getTitleCategoryData();
        getAttData();


        var GroupData = {};
        function getmGroup(callback) {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getmGroup",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    var targetSelect = $('#mGroup');
                    targetSelect.prop('disabled', false);
                    msg.data.forEach(function(value) {
                        targetSelect.append('<option data-content="<div class=\'label label-success\'>' + value.count + ' 人</div> ' + value.AudienceName + '" value="' + value.Id + '">' + value.AudienceName + '</option>');
                        GroupData[value.Id] = value.AudienceName;
                    });
                    targetSelect.selectpicker('refresh');
                    callback();
                }
            })
        };
        function getCategory(callback) {
            $.ajax({
                type: 'GET',
                url: "/BulletinMail_getAttItems",
                cache: false,
                data: { mAttachment: '1' },
                async: true,
                dataType: 'json',
                success: function(msg) {
                    mAttachmentParse('1', msg.data);
                    $.ajax({
                        type: 'GET',
                        url: "/BulletinMail_getAttItems",
                        cache: false,
                        data: { mAttachment: '2' },
                        async: true,
                        dataType: 'json',
                        success: function(msg) {
                            mAttachmentParse('2', msg.data);
                            callback();
                        }
                    });
                }
            });
        };
        function getPackageList(callback){
            $.ajax({
                type: 'POST',
                url: "/BulletinMail_ViewPackage",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    mAttachmentParse('6', msg.result);
                    callback();
                }
            });
        };
        var DataForCopy = {};
        var mDataTable = $('#datatable').DataTable({
                "autoWidth": false,
                "order": [
                    [0, "desc"]
                ],
                "columnDefs": [{
                    "targets": [0, 1, 2],
                    "width": "45px"
                }, {
                    "targets": 3,
                    "width": "80px"
                }, {
                    "targets": 4,
                    "width": "30px"
                }, {
                    "targets": [5, 6],
                    "width": "200px"
                }, {
                    "targets": 7,
                    "width": "30px"
                }, {
                    "targets": 8,
                    "width": "300px"
                }, {
                    "targets": 10,
                    "width": "125px"
                }]
        });
        function getTableData() {
            var arrayTableData = [];
            $.ajax({
                type: 'POST',
                url: '/bulletinMailVerify_History',
                cache: false,
                async: true,
                dataType: 'json',
                success: function(result) {
                    DataForCopy = result.result;
                    $.each(result.result, function(index, value) {
                        arrayTableData.push([
                            moment(value.ModifyTime).format("YYYY-MM-DD HH:mm:ss"),
                            moment(value.ReserveTime).format("YYYY-MM-DD HH:mm:ss"),
                            ((value.EndTime === null) ? '' : moment(value.EndTime).format("YYYY-MM-DD HH:mm:ss")),
                            GroupData[value.mGroup] == null ? value.ToMemberId : '<span class="label label-default text-ellipsis">' + GroupData[value.mGroup] + '</span>',
                            TitleCategoryData[value.TitleCategory] == null ? "已刪除類別" : TitleCategoryData[value.TitleCategory],
                            '<p class="text-ellipsis">' + value.MailTitle + '</p>',
                            '<p class="text-ellipsis">' + value.MailContent + '</p>',
                            value.mAttachment == null ? '不夾帶' : AttData[value.mAttachment],
                            getAttCategory(value),
                            thousandComma(value.mAttachment == 3 ? value.mQuantity / 100 : value.mQuantity),
                            '<div class="btn-group btn-group-xs" style="display: flex;">'
                            + '<button number="' + value.mQuantity + '" datakey="' + value.Id + '" class="btn btn-success passed"><i class="fa fa-check"></i> 審核通過</button>'
                            + '<button number="' + value.mQuantity + '" datakey="' + value.Id + '" class="btn btn-danger rejection"'  + '><i class="fa fa-times"></i> 取消審核</button>'
                            + '</div>'
                        ]);
                    });
                }
            }).done(function() {
                mDataTable.clear().draw();
                mDataTable.rows.add(arrayTableData).draw();
                $('.text-ellipsis').popover({
                    trigger: 'hover',
                    placement: 'top',
                    html: true,
                    content: function() {
                        return $(this).text().replace("\n", "<br />", "g");
                    },
                });
            });
        };

        function viewPackageSelected(target, array){
            target.html('');
            var modalHTML = "";
            $.each(array, function(index, value) {
                modalHTML += viewPackageData(value);
            });
            target.append(modalHTML);
        }

        function viewPackageData(array, needInput = true){
            var itemArr = JSON.parse(array.ItemJSON);
            var itemHTML = "";
            $.each(itemArr, function(itemIndex, itemVal) {
                itemHTML += '<tr><td>' + AttData[1] + '</td><td>' + getAttCategory({mAttachment: 1, mCategory: itemVal.mCategory}) + '</td><td>' + itemVal.mQuantity + '</td></tr>';
            });
            var chipArr = JSON.parse(array.ChipJSON);
            var chipHTML = "";
            $.each(chipArr, function(chipIndex, chipVal) {
                chipHTML += '<tr><td>' + AttData[2] + '</td><td>' + getAttCategory({mAttachment: 2, mCategory: chipVal.mCategory}) + '</td><td>' + chipVal.mQuantity + '</td></tr>';
            });
            var coinHTML = array.coin == null ? '' : '<tr><td>' + AttData[3] + '</td><td></td><td>' + thousandComma(array.coin / 100) + '</td></tr>';
            var expHTML  = array.exp == null ? '' : '<tr><td>' + AttData[4] + '</td><td></td><td>' + thousandComma(array.exp) + '</td></tr>';
            var html = '';
            if(needInput){
                html += '<div class="panel panel-default show-pack-table"><div class="panel-heading"><div class="radio">'
                        + '<label for="packageSelect_' + array.id + '">'
                        + '<input class="packageSelect" type="radio" name="packageSelect" id="packageSelect_' + array.id + '" value="' + array.id + '">'
                        + array.Name
                        + '</label></div></div><div class="panel-body">';
            }
            html +='<table class="table table-hover"><thead><tr><td>夾帶類型</td><td>夾帶品項</td><td>數量</td></tr></thead><tbody>'
                  + itemHTML + chipHTML + coinHTML + expHTML
                  + '</tbody></table>';
            if(needInput){
                html += '</div></div>';
            }
            return html; 
        }

        getmGroup(function(){
            getCategory(function(){
                getPackageList(function(){
                    getTableData();
                });
            });
        });

        // ParseData
        function mAttachmentParse(mAttachment, ParseData) {
            // console.log(value);
            AttItemsData[mAttachment] = {};
            switch (mAttachment) {
                case '1':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ItemId] = {
                            id: value.ItemId,
                            Name: value.ItemName,
                            betLevel: value.betLevel,
                            GameName: value.GameName,
                            multiple: value.multiple,
                            round: value.round,
                            itemType: value.itemType,
                            DataContent: '<span class=\'label label-default\'>' + value.ItemId + '號</span> <span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>Lv-' + value.betLevel + '</span> <span class=\'label label-info\'>' + value.ItemName + '</span> <span class=\'label label-primary\'>' + value.multiple + '倍</span> <span class=\'label label-default\'>' + value.round + '場</span> <span class=\'label label-default\'>' + value.itemType + '</span>'
                        };
                    });
                    break;
                case '2':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.ChipId] = {
                            id: value.ChipId,
                            Name: value.ChipName,
                            GameName: value.GameName,
                            MixValue: value.MixValue,
                            DataContent: '<span class=\'label label-warning\'>' + value.GameName + '</span> <span class=\'label label-success\'>' + value.ChipName + '</span> <span class=\'label label-info\'>' + value.MixValue + '</span> <span class=\'label label-default\'>' + value.SellValue + '</span>'
                        };
                    });
                    break;
                case '6':
                    $.each(ParseData, function(index, value) {
                        AttItemsData[mAttachment][value.PackageId] = {
                            id: value.PackageId,
                            Name: value.PackageName,
                            ChipJSON: value.ChipJSON,
                            ItemJSON: value.ItemJSON,
                            coin: value.MoneyAmount,
                            exp: value.ExpAmount,
                            DataContent: '<button class="btn btn-default btn-block show-pack-data" data-packid="' + value.PackageId + '">顯示獎勵組合</button>'
                        };
                    });
                    break;
            }
        };

        // Other GET / POST
        var AttItemsData = {};
        function showReciprocal(target, totaltime){
            if(totaltime != -1){
                if(target.find('.reciprocal').length < 1){
                    target.append('<span class="reciprocal" time="' + totaltime + '">(' + totaltime + ')</span>');
                } else {
                    var nowTime = Number(target.find('.reciprocal').attr('time'));
                    target.find('.reciprocal').attr('time', nowTime-1).text(('(' + (nowTime-1) + ')'));
                }
            } else {
                target.find('.reciprocal').remove();
            }
        }

        function getAttCategory(array){
            if(array.mCategory != null){
                if(AttItemsData[array.mAttachment][array.mCategory] == null || AttItemsData[array.mAttachment] == null){
                    mCategory = '<span class="label label-danger">品項不存在: ' + array.mCategory + '</span>';
                } else {
                    mCategory = '<div class="text-nowrap">' + AttItemsData[array.mAttachment][array.mCategory].DataContent + '</div>';
                }
            } else {
                mCategory = '';
            }
            return mCategory
        }

        $(document).on('click', '#datatable .passed, #datatable .rejection', function(event) {
            var number = $(this).attr('number');
            var datakey = $(this).attr('datakey');
            var isPassed = $(this).hasClass('passed');
            var confirmAlert = confirm('確定要' + (isPassed?'通過':'拒絕') + '？');
            var data = { datakey: datakey, isPassed: isPassed };
            var thisRow = $(this);

            if(confirmAlert){
                mDataTable.row(thisRow.parents('tr')).remove().draw();
                $.ajax({
                    url: 'bulletinMailVerify_Checker',
                    type: 'POST',
                    dataType: 'json',
                    data: data,
                }).done(function(result) {
                    switch(result.code) {
                        case 1:
                            QuickNotify('已經' + (isPassed?'通過':'拒絕') + '項目', 'success');
                            break;
                        case 0:
                            QuickNotify('該項目審核沒有被' + (isPassed?'通過':'拒絕') + '，可能已經過期或已經被審核', 'danger');
                            break;
                        default:
                            QuickNotify('資料異常', 'danger');
                            break;
                    }
                }).fail(function() {
                    QuickNotify('連線失敗', 'danger');
                });
            }
        });

        $(document).on('click', '.refresh-table', getTableData);
        // $(document).on('click', '.show-add-pack', showPackageSelectModal);
        $(document).on('click', '.show-pack-data', function(event) {
            event.preventDefault();
            var packId = $(this).attr('data-packid');
            if (packId != ""){
                var packageArr = AttItemsData[6][packId];
                var modalHTML = viewPackageData(packageArr, false);
                var modalTitle = '<span class="label label-default">獎勵組合</span> ' + packageArr.Name;
                ShowModalBox(modalTitle, modalHTML);
            } else {
                QuickNotify("沒有選擇任何獎勵組合", "warning");
            }
        });

        // 多重視窗相容性
        $(document).on('hidden.bs.modal', function (event) {
            if($('.modal:visible').length) {
                $('body').addClass('modal-open');
            }
        });

        $(document).on('show.bs.modal', function (event) {
            var modalLength = $('.modal').length;
            $.each($('.modal').get().reverse(), function(index, element) {
                var new_zindex = 1050 - (index * 20);
                $(element).css('z-index', new_zindex);
                $(element).next('.modal-backdrop').css('z-index', new_zindex - 15);
            });
        });
    });
    </script>
</body>

</html>