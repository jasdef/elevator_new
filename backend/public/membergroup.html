<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <!-- Meta, title, CSS, favicons, etc. -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>SCG</title>
    <!-- Bootstrap -->
    <link href="../vendors/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="../vendors/font-awesome/css/font-awesome.css" rel="stylesheet">
    <!-- NProgress -->
    <link href="../vendors/nprogress/nprogress.css" rel="stylesheet">
    <!-- iCheck -->
    <link href="../vendors/iCheck/skins/flat/green.css" rel="stylesheet">
    <!-- Datatables -->
    <link href="../vendors/datatables.net-bs/css/dataTables.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-buttons-bs/css/buttons.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-fixedheader-bs/css/fixedHeader.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-responsive-bs/css/responsive.bootstrap.min.css" rel="stylesheet">
    <link href="../vendors/datatables.net-scroller-bs/css/scroller.bootstrap.min.css" rel="stylesheet">
    <!-- Custom Theme Style -->
    <link href="../build/css/custom.min.css" rel="stylesheet">
</head>

<body class="nav-md">
    <div class="container body">
        <div class="main_container">
            <!--Menu-->
            <!--Top-->
            <!-- page content -->
            <div class="right_col" role="main">
                <div class="row">
                    <div class="clearfix"></div>
                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12">
                            <div class="x_panel">
                                <div class="x_title">
                                    <h2>Member Group Settings</h2>
                                    <div class="clearfix"></div>
                                </div>
                                <div class="x_content">
                                    <!--
                                    <toolbar>
                                        <button id="rowAddM" class="btn btn-primary">新增手動群組</button>
                                        <button id="rowAddS" class="btn btn-primary">新增智慧群組</button>
                                        <br>
                                        <br>
                                    </toolbar>
                                    -->
                                    <table id="datatable" class="table table-striped table-bordered">
                                        <thead>
                                            <tr>
                                                <th>群組編號</th>
                                                <th>建立時間</th>
                                                <th>群組名稱</th>
                                                <th>群組敘述</th>
                                                <th>群組成員數量</th>
                                                <th>功能</th>
                                                <th>標記來源</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- /page content -->
            <!--footer-->
        </div>
    </div>
    <!-- jQuery -->
    <script src="../vendors/jquery/dist/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="../vendors/bootstrap/dist/js/bootstrap.min.js"></script>
    <!-- FastClick -->
    <script src="../vendors/fastclick/lib/fastclick.js"></script>
    <!-- NProgress -->
    <script src="../vendors/nprogress/nprogress.js"></script>
    <!-- iCheck -->
    <script src="../vendors/iCheck/icheck.min.js"></script>
    <!-- Datatables -->
    <script src="../vendors/datatables.net/js/jquery.dataTables.min.js"></script>
    <script src="../vendors/datatables.net-bs/js/dataTables.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/dataTables.buttons.min.js"></script>
    <script src="../vendors/datatables.net-buttons-bs/js/buttons.bootstrap.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.flash.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.html5.min.js"></script>
    <script src="../vendors/datatables.net-buttons/js/buttons.print.min.js"></script>
    <script src="../vendors/datatables.net-fixedheader/js/dataTables.fixedHeader.min.js"></script>
    <script src="../vendors/datatables.net-keytable/js/dataTables.keyTable.min.js"></script>
    <script src="../vendors/datatables.net-responsive/js/dataTables.responsive.min.js"></script>
    <script src="../vendors/datatables.net-responsive-bs/js/responsive.bootstrap.js"></script>
    <script src="../vendors/datatables.net-scroller/js/dataTables.scroller.min.js"></script>
    <script src="../vendors/jszip/dist/jszip.min.js"></script>
    <script src="../vendors/pdfmake/build/pdfmake.min.js"></script>
    <script src="../vendors/pdfmake/build/vfs_fonts.js"></script>
    <!-- Custom Theme Scripts -->
    <script src="../build/js/custom.min.js"></script>
    <script>
    $(document).ready(function() {
        var table = $('#datatable').DataTable({
            destroy: true,
            "lengthMenu": [
                [30, 50, 100, -1],
                [30, 50, 100, "∞"]
            ],
            "columnDefs": [
                { "targets": 0 },
                { "targets": 1 },
                { "targets": 2 },
                { "targets": 3 },
                { "targets": 4 },
                {
                    "targets": 5,
                    "defaultContent": "<div class='btn-group btn-group-sm' style='display: flex'>" +
                        "<button class='btn btn-success' id='additem' style='display: none;'><i class='fa fa-check' aria-hidden='true'></i> 確定</button>" +
                        "<button class='btn btn-danger' id='cancelitem' style='display: none;'><i class='fa fa-times' aria-hidden='true'></i> 取消</button>" +
                        "<button class='btn btn-info' id='modifyitem'><i class='fa fa-pencil-square-o' aria-hidden='true' dispaly='none'></i> 修改</button>" +
                        "<button class='btn btn-danger' id='deleteitem'><i class='fa fa-pencil-square-o' aria-hidden='true' dispaly='none'></i> 刪除</button>" +
                        "</div>"
                },
                { "targets": 6 }
            ],
            'rowCallback': function(row, data, dataIndex) {
                /*
                if (data[0] === "") {
                    $(row).find('#modifyitem').hide();
                } else {
                    $(row).find('#additem').hide();
                    $(row).find('#cancelitem').hide();
                }*/
            }
        });
        /*
                //點選新增
                $("button#rowAddM").on('click', "", function(e) {
                    table.row.add([
                        "",
                        "",
                        "<input type='text' id='AudienceName' value=''/>",
                        "<input type='text' id='AudienceDescription' value=''/>",
                        "", ,
                        "手動"
                    ]).draw();
                });

                $("button#rowAddS").on('click', "", function(e) {
                    table.row.add([
                        "",
                        "",
                        "<input type='text' id='AudienceName' value=''/>",
                        "<input type='text' id='AudienceDescription' value=''/>",
                        "", ,
                        "智慧"
                    ]).draw();
                });
        */
        refresh();

        function checkZero(data) {
            if (data < 10) {
                data = "0" + data;
            }
            return data;
        }

        function TimeTrans(d) {
            var t = new Date(d);
            return checkZero((t.getMonth() + 1)) + "/" + checkZero(t.getDate()) + "/" + checkZero(t.getFullYear()) + " " + checkZero(t.getHours()) + ":" + checkZero(t.getMinutes()) + ":" + checkZero(t.getSeconds());
        }

        function refresh() {
            table.clear().draw();
            var data = [];
            //取得列表
            $.ajax({
                type: 'POST',
                url: "/MemberGroup",
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { msg.msg } else {
                        msg.data.forEach(function(value) {
                            data.push([
                                value.Id,
                                TimeTrans(value.ModifyTime),
                                value.AudienceName,
                                value.AudienceDescription,
                                value.cnt, ,
                                (value.Smart == 0) ? "手動" : "智慧"
                            ]);
                        });
                        table.rows.add(data).draw();
                    }
                }
            });
        }

        $('#datatable tbody').on('click', 'button', function(e) {
            var data = table.row($(this).parents('tr')).data();
            switch ($(this).attr('id')) {
                /*
                case "additem":
                    if (data[0] === "") {
                        var tempForm = new Object();
                        tempForm.AudienceName = $($(this).parents('tr').find('input').get(0)).val();
                        tempForm.AudienceDescription = $($(this).parents('tr').find('input').get(1)).val();
                        tempForm.Smart = (data[6] === '手動') ? "0" : "1"
                        additem(tempForm);
                    } else {
                        var tempForm = new Object();
                        tempForm.Id = data[0];
                        tempForm.AudienceName = $($(this).parents('tr').find('input').get(0)).val();
                        tempForm.AudienceDescription = $($(this).parents('tr').find('input').get(1)).val();
                        modifyitem(tempForm);
                    }
                    break;
                case "cancelitem":
                    if (data[0] === "") {
                        table.row($(this).parents('tr')).remove().draw();
                    } else {
                        data[2] = $(data[2]).val();
                        data[3] = $(data[3]).val();
                        table.row($(this).parents('tr')).data(data).draw();
                    }
                    break;
                    */
                case "modifyitem":
                    if (data[6] === '手動') {
                        window.open("/memberGroupManualForm?Id=" + data[0]);
                    } else {
                        alert('111');
                    }
                    break;
                case "deleteitem":
                    if (confirm("確定刪除嗎?")) {
                        DeleteGroup(data[0]);
                    }
                    break;
            }

        });
        /*
                //處理新增
                function additem(data) {
                    if (confirm("確定存檔嗎?")) {
                        if (checkObjectValue(data)) {
                            $.ajax({
                                type: 'POST',
                                url: "/MemberGroupAdd",
                                cache: false,
                                async: true,
                                data: data,
                                dataType: 'json',
                                success: function(msg) {
                                    if (msg.code == 0) {
                                        refresh();
                                    }
                                    alert(msg.msg);
                                }
                            });
                        }
                    }
                };

                //處理修改
                function modifyitem(data) {
                    if (confirm("確定修改嗎?")) {
                        if (checkObjectValue(data)) {
                            $.ajax({
                                type: 'POST',
                                url: "/MemberGroupModify",
                                cache: false,
                                async: true,
                                data: data,
                                dataType: 'json',
                                success: function(msg) {
                                    var code = msg.code;
                                    var message = msg.msg;
                                    if (code == 0) {
                                        refresh();
                                    }
                                    alert(message);
                                }
                            });
                        }
                    }
                };

                //檢查物件
                function checkObjectValue(tempForm) {

                    if (tempForm.AudienceName.trim() == "") {
                        alert("AudienceName Error");
                        return false;
                    }
                    if (!tempForm.AudienceDescription) {
                        alert("AudienceDescription Error");
                        return false;
                    }
                    return true;
                }
                */

        function DeleteGroup(id) {
            $.ajax({
                type: 'POST',
                url: "/MemberGroupDelete",
                data: { Id: id },
                cache: false,
                async: true,
                dataType: 'json',
                success: function(msg) {
                    if (msg.code == -1) { alert("刪除失敗, 請檢查廣告系統是否有使用到該群組!"); } else {
                        alert(msg.msg);
                        refresh();
                    }
                }
            });
        }

    });
    </script>
</body>

</html>